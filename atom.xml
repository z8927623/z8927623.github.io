<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title><![CDATA[Wild Yaoyao's blog]]></title>
  <subtitle><![CDATA[é‡ç‘¶ç‘¶çš„æŠ€æœ¯åšå®¢]]></subtitle>
  <link href="/atom.xml" rel="self"/>
  <link href="http://yoursite.com/"/>
  <updated>2016-02-05T10:58:25.000Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name><![CDATA[Wild Yaoyao]]></name>
    <email><![CDATA[z8927623@gmail.com]]></email>
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title><![CDATA[Objective-C Runtimeä¹‹å®ç°]]></title>
    <link href="http://yoursite.com/2016/02/04/Objective-C%20Runtime%E4%B9%8B%E5%AE%9E%E7%8E%B0/"/>
    <id>http://yoursite.com/2016/02/04/Objective-C Runtimeä¹‹å®ç°/</id>
    <published>2016-02-03T16:00:00.000Z</published>
    <updated>2016-02-05T10:58:25.000Z</updated>
    <content type="html"><![CDATA[<h3 id="id">id</h3><p>é¦–å…ˆä»<code>id</code>è¯´èµ·ï¼ŒObjective-Cä¸­idæ˜¯ä¸ªå¯ä»¥æŒ‡å‘ä»»ä½•OCå¯¹è±¡çš„æŒ‡é’ˆï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å®ƒçš„ç»“æ„</p>
<figure class="highlight thrift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">objc_object</span> </span>&#123;</span><br><span class="line">    Class isa;</span><br><span class="line">&#125; *id;</span><br></pre></td></tr></table></figure>
<p>å¯çŸ¥ï¼Œ<code>id</code>æ˜¯ä¸€ä¸ªæŒ‡å‘<code>objec_object</code>ç»“æ„çš„CæŒ‡é’ˆï¼Œè€Œ<code>objec_object</code>åˆåŒ…å«äº†ä¸€ä¸ª<code>isa</code>æŒ‡é’ˆï¼Œè¯¥æŒ‡é’ˆæŒ‡å‘åä¸º<code>Class</code>çš„å˜é‡ï¼Œå› æ­¤ï¼Œæ¯ä¸ªOCå¯¹è±¡éƒ½æœ‰ä¸ª<code>Class</code>ï¼Œé‚£ä¹ˆ<code>Class</code>åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p>
<h3 id="Class">Class</h3><p><code>typedef struct objc_class *Class;</code></p>
<p><code>Class</code>æ˜¯ä¸€ä¸ªæŒ‡å‘<code>objc_class</code>ç»“æ„çš„CæŒ‡é’ˆï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹<code>objc_class</code>ï¼š</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> objc_class &#123;</span><br><span class="line">    Class isa;</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#if !__OBJC2__</span></span><br><span class="line">    Class super_class                                        OBJC2_UN<span class="built_in">AVAILABLE</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name                                         OBJC2_UN<span class="built_in">AVAILABLE</span>;</span><br><span class="line">    <span class="keyword">long</span> version                                             OBJC2_UN<span class="built_in">AVAILABLE</span>;</span><br><span class="line">    <span class="keyword">long</span> info                                                OBJC2_UN<span class="built_in">AVAILABLE</span>;</span><br><span class="line">    <span class="keyword">long</span> instance_size                                       OBJC2_UN<span class="built_in">AVAILABLE</span>;</span><br><span class="line">    <span class="keyword">struct</span> objc_ivar_list *ivars                             OBJC2_UN<span class="built_in">AVAILABLE</span>;</span><br><span class="line">    <span class="keyword">struct</span> objc_method_list **methodLists                    OBJC2_UN<span class="built_in">AVAILABLE</span>;</span><br><span class="line">    <span class="keyword">struct</span> objc_cache *cache                                 OBJC2_UN<span class="built_in">AVAILABLE</span>;</span><br><span class="line">    <span class="keyword">struct</span> objc_protocol_list *protocols                     OBJC2_UN<span class="built_in">AVAILABLE</span>;</span><br><span class="line"><span class="preprocessor">#endif</span></span><br><span class="line"></span><br><span class="line">&#125; OBJC2_UN<span class="built_in">AVAILABLE</span>;</span><br><span class="line"><span class="comment">/* Use `Class` instead of `struct objc_class *` */</span></span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬æ¥çœ‹çœ‹å®ƒçš„æ¯ä¸ªæˆå‘˜</p>
<p><strong>isa</strong></p>
<p>æˆ‘ä»¬çœ‹åˆ°ï¼Œ<code>objc_class</code>ä¹ŸåŒ…å«ä¸€ä¸ªæŒ‡å‘<code>Class</code>çš„<code>isa</code>æŒ‡é’ˆï¼Œè¿™ä¸ª<code>Class</code>å°±æ˜¯<code>Meta-Class</code>ï¼Œä¹Ÿå°±æ˜¯å…ƒç±»ï¼Œå®é™…ä¸Šå…ƒç±»ä¹Ÿæœ‰ä¸ª<code>isa</code>æŒ‡é’ˆï¼Œå…ƒç±»çš„<code>isa</code>æŒ‡é’ˆéƒ½æŒ‡å‘äº†æ ¹å…ƒç±»ã€‚</p>
<p>å› æ­¤ï¼Œä¸ä»…<code>objc_object</code>æ˜¯ä¸ªå¯¹è±¡ï¼Œå®ƒçš„ç±»<code>object_class</code>ä¹Ÿæ˜¯ä¸ªå¯¹è±¡ï¼Œä»–ä»¬éƒ½æœ‰å„è‡ªçš„ç±»ï¼Œ<code>objc_object</code>çš„ç±»æ˜¯æ™®é€šç±»ï¼Œè¿™ä¸ªç±»å­˜å‚¨äº†å®ä¾‹å˜é‡å’Œå®ä¾‹æ–¹æ³•åˆ—è¡¨ï¼›<code>object_class</code>çš„ç±»æ˜¯å…ƒç±»ï¼Œå…ƒç±»å®ƒå­˜å‚¨äº†ç±»æ–¹æ³•åˆ—è¡¨ã€‚å½“æˆ‘ä»¬å‘é€ä¸€ä¸ªæ¶ˆæ¯ç»™ä¸€ä¸ªå¯¹è±¡çš„æ—¶å€™ï¼Œruntimeä¼šä»å®ƒçš„ç±»çš„æ–¹æ³•åˆ—è¡¨ä¸­æŸ¥æ‰¾æ¶ˆæ¯ã€‚å½“å‘é€ç»™ä¸€ä¸ªç±»çš„æ—¶å€™ï¼Œruntimeä¼šä»å®ƒçš„å…ƒç±»çš„æ–¹æ³•åˆ—è¡¨ä¸­æŸ¥æ‰¾æ¶ˆæ¯ã€‚</p>
<p>æ¦‚æ‹¬ä¸€ä¸‹ï¼Œæ™®é€šçš„OCå¯¹è±¡éƒ½æœ‰ä¸ª<code>isa</code>æŒ‡é’ˆï¼ŒæŒ‡å‘å®ƒä»¬æ‰€å±çš„ç±»ï¼›è€Œå®ƒä»¬æ‰€å±çš„ç±»ä¹Ÿæœ‰ä¸ª<code>isa</code>æŒ‡é’ˆï¼ŒæŒ‡å‘å®ƒä»¬çš„å…ƒç±»ï¼›æœ€åï¼Œå®ƒä»¬çš„å…ƒç±»ä¹Ÿæœ‰ä¸ª<code>isa</code>æŒ‡é’ˆï¼ŒæŒ‡å‘æ ¹å…ƒç±»ã€‚</p>
<p><strong>super_class</strong></p>
<p>æŒ‡å‘çˆ¶ç±»ï¼Œå¦‚æœå½“å‰ç±»æ˜¯è¯¸å¦‚NSObjectæˆ–è€…NSProxyçš„æ ¹ç±»ï¼Œé‚£ä¹ˆå®ƒçš„<code>super_class</code>ä¸ºNULL</p>
<p><strong>name</strong></p>
<p>ç±»åï¼Œå¯ä»¥æ ¹æ®è¿™ä¸ªä¿¡æ¯è·å–ç±»ï¼Œå¦‚<code>objc_getClass</code></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">id</span> objc_getClass(<span class="keyword">const</span> <span class="keyword">char</span> *aClassName)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!aClassName) <span class="keyword">return</span> Nil;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// NO unconnected, YES class handler</span></span><br><span class="line">    <span class="keyword">return</span> look_up_class(aClassName, <span class="literal">NO</span>, <span class="literal">YES</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>version</strong></p>
<p>ç‰ˆæœ¬ä¿¡æ¯</p>
<p><strong>info</strong></p>
<p>runtimeéœ€è¦çš„ä¸€äº›ä¿¡æ¯</p>
<p><strong>instance_size</strong></p>
<p>è¯¥ç±»å®ä¾‹å˜é‡å¤§å°ï¼Œå¯ä»¥é€šè¿‡<code>class_getInstanceSize</code>è·å–</p>
<p><strong>ivars</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> objc_ivar_list &#123;</span><br><span class="line">    <span class="keyword">int</span> ivar_count                                           OBJC2_UNAVAILABLE;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">ifdef</span> __LP64__</span></span><br><span class="line">    <span class="keyword">int</span> space                                                OBJC2_UNAVAILABLE;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="comment">/* variable length structure */</span></span><br><span class="line">    <span class="keyword">struct</span> objc_ivar ivar_list[<span class="number">1</span>]                            OBJC2_UNAVAILABLE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å˜é‡åˆ—è¡¨ï¼Œå¯ä»¥é€šè¿‡<code>class_copyIvarList</code>è·å–</p>
<p><strong>methodLists</strong></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> objc_method_list &#123;</span><br><span class="line">	<span class="keyword">struct</span> objc_method_list *obsolete                        OBJC2_UN<span class="built_in">AVAILABLE</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> method_count                                         OBJC2_UN<span class="built_in">AVAILABLE</span>;</span><br><span class="line"><span class="preprocessor">#ifdef __LP64__</span></span><br><span class="line">	<span class="keyword">int</span> space                                                OBJC2_UN<span class="built_in">AVAILABLE</span>;</span><br><span class="line"><span class="preprocessor">#endif</span></span><br><span class="line">	<span class="comment">/* variable length structure */</span></span><br><span class="line">	<span class="keyword">struct</span> objc_method method_list[<span class="number">1</span>]                        OBJC2_UN<span class="built_in">AVAILABLE</span>;</span><br><span class="line">&#125;                                                            OBJC2_UN<span class="built_in">AVAILABLE</span>;</span><br></pre></td></tr></table></figure>
<p>æ–¹æ³•åˆ—è¡¨ï¼Œå¯ä»¥é€šè¿‡<code>class_copyMethodList</code>è·å–ã€‚<br>å¦‚ä¸‹ç¤ºä¾‹ä»£ç ï¼šæˆ‘ä»¬è·å–äº†è¯¥ç±»çš„æ–¹æ³•åˆ—è¡¨ï¼Œå­˜å…¥æ•°ç»„ä¸­å¹¶è¿”å›ã€‚</p>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">NSArray</span> *)methodsArray &#123;</span><br><span class="line">    <span class="type">NSMutableArray</span> *<span class="type">array</span> = [<span class="type">NSMutableArray</span> <span class="type">array</span>];</span><br><span class="line">    </span><br><span class="line">    unsigned <span class="type">int</span> outCount;</span><br><span class="line">    <span class="type">Method</span> *methods = class_copyMethodList([self class], &amp;outCount);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">NSInteger</span> i = <span class="number">0</span>; i &lt; outCount; i++) &#123;</span><br><span class="line">        <span class="type">Method</span> <span class="keyword">method</span> = methods[i];</span><br><span class="line">        <span class="type">SEL</span> selector = method_getName(<span class="keyword">method</span>);</span><br><span class="line">        <span class="type">NSString</span> *methodName = <span class="type">NSStringFromSelector</span>(selector);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> ([methodName isEqualToString:@<span class="string">".cxx_destruct"</span>]) &#123;</span><br><span class="line">            <span class="keyword">continue</span>; // è·³è¿‡è¿™æ¬¡å¾ªç¯ï¼Œå› ä¸ºæ‰€æœ‰<span class="type">NSObjct</span>éƒ½å«æœ‰è¯¥æ–¹æ³•ï¼Œruntimeç”¨äºé”€æ¯C++å¯¹è±¡çš„</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (methodName) &#123;</span><br><span class="line">            [<span class="type">array</span> addObject:methodName];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    free(methods);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> [<span class="type">array</span> copy];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>objc_cache</strong></p>
<p>ä¹‹å‰è¯´è¿‡runtimeä¸ºäº†åŠ å¿«æ–¹æ³•è°ƒç”¨çš„é€Ÿåº¦ï¼Œä¼šå°†selectorå’Œimpå­˜å‚¨èµ·æ¥ï¼Œè€Œè´Ÿè´£è¿™ä¸ªä»»åŠ¡çš„æ•°æ®ç»“æ„å°±æ˜¯<code>Cache</code>ï¼Œè€Œ<code>Cache</code>æ˜¯ä¸€ä¸ªæŒ‡å‘<code>objc_cache</code>ç»“æ„çš„CæŒ‡é’ˆ</p>
<p><code>typedef struct objc_cache *Cache;</code></p>
<p><code>objc_cache</code>çš„ç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> objc_cache &#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> mask <span class="comment">/* total = mask + 1 */</span>                 OBJC2_UN<span class="built_in">AVAILABLE</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> occupied                                    OBJC2_UN<span class="built_in">AVAILABLE</span>;</span><br><span class="line">	Method buckets[<span class="number">1</span>]                                        OBJC2_UN<span class="built_in">AVAILABLE</span>;</span><br><span class="line">&#125; <span class="comment">/* GrP fixme should be OBJC2_UNAVAILABLE, but isn't because of spurious warnings in [super ...] calls */</span>;</span><br></pre></td></tr></table></figure>
<p><strong>protocols</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> objc_protocol_list &#123;</span><br><span class="line">    <span class="keyword">struct</span> objc_protocol_list *next;</span><br><span class="line">    <span class="keyword">long</span> count;</span><br><span class="line">    Protocol *<span class="built_in">list</span>[<span class="number">1</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>åè®®åˆ—è¡¨ï¼Œå¯ä»¥é€šè¿‡<code>class_copyProtocolList</code>è·å–</p>
<h3 id="Method">Method</h3><p><code>typedef struct objc_method *Method;</code></p>
<p><code>Method</code>æ˜¯ä¸€ä¸ªæŒ‡å‘<code>objc_method</code>ç»“æ„çš„CæŒ‡é’ˆï¼Œå³<strong>æ–¹æ³•</strong>ã€‚é‚£ä¹ˆ<code>objc_method</code>åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> objc_method &#123;</span><br><span class="line">    SEL method_name                                          OBJC2_UN<span class="built_in">AVAILABLE</span>;</span><br><span class="line">    <span class="keyword">char</span> *method_types                                       OBJC2_UN<span class="built_in">AVAILABLE</span>;</span><br><span class="line">    IMP method_imp                                           OBJC2_UN<span class="built_in">AVAILABLE</span>;</span><br><span class="line">&#125;                                                            OBJC2_UN<span class="built_in">AVAILABLE</span>;</span><br></pre></td></tr></table></figure>
<p>ä»ç»“æ„ä½“å¯ä»¥çœ‹åˆ°ï¼Œ<code>objc_method</code>æœ‰ä¸‰ä¸ªæˆå‘˜åˆ—è¡¨ï¼Œåˆ†åˆ«æ˜¯<strong>æ–¹æ³•å</strong>ï¼ˆ<code>method_name</code>ï¼‰ã€<strong>æ–¹æ³•ç±»å‹</strong>ï¼ˆ<code>method_types</code>ï¼‰å’Œ<strong>æ–¹æ³•å®ç°</strong>ï¼ˆ<code>method_imp</code>ï¼‰ã€‚æ–¹æ³•åæ˜¯ä¸€ä¸ª<code>SEL</code>ç±»å‹ç”¨äºæè¿°æ–¹æ³•çš„åå­—ï¼Œæ–¹æ³•ç±»å‹æè¿°äº†æ–¹æ³•å‚æ•°çš„æ•°æ®ç±»å‹ï¼Œæ–¹æ³•å®ç°æ˜¯ä¸€ä¸ª<code>IMP</code>ç±»å‹ï¼Œæä¾›äº†å‡½æ•°å®ç°çš„åœ°å€ï¼Œå½“æ–¹æ³•è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œæ‰§è¡Œçš„å°±æ˜¯IMPå‡½æ•°å†…çš„ä»£ç ã€‚</p>
<h3 id="SEL">SEL</h3><p><code>typedef struct objc_selector *SEL;</code></p>
<p>ä¸€ä¸ªæŒ‡å‘<code>objc_selector</code>ç»“æ„çš„CæŒ‡é’ˆï¼Œç”¨äºè¡¨ç¤ºæ–¹æ³•é€‰æ‹©å™¨selectorçš„ç±»å‹ã€‚æ–¹æ³•é€‰æ‹©å™¨selectorä»£è¡¨<code>Method</code>çš„åå­—ï¼Œå…¶å®å®ƒå°±æ˜¯ä¸€ä¸ªCå­—ç¬¦ä¸²ï¼Œç”±ç¼–è¯‘å™¨ç”Ÿæˆï¼Œè¿è¡Œæ—¶åœ¨ç±»åŠ è½½çš„æ—¶å€™è¢«è‡ªåŠ¨æ˜ å°„åˆ°æ–¹æ³•å®ç°ï¼Œä¹Ÿå°±æ˜¯<code>IMP</code>ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>sel_registerName</code>åœ¨è¿è¡Œæ—¶æ·»åŠ æ–°çš„selectorï¼Œå¦‚æœselectorå·²ç»å­˜åœ¨ï¼Œåˆ™ä¼šè¿”å›å­˜åœ¨çš„selectorã€‚é™¤äº†<code>sel_registerName</code>ï¼Œä¹Ÿå¯ä»¥é€šè¿‡OCç¼–è¯‘å™¨æŒ‡ä»¤<code>@selector()</code>æ¥è·å–ï¼Œä½†æ˜¯ä¸èƒ½ç›´æ¥ä»Cå­—ç¬¦ä¸²å¼ºè½¬è¿‡æ¥ã€‚</p>
<h3 id="IMP">IMP</h3><p><code>typedef id (*IMP)(id, SEL, ...);</code></p>
<p><code>IMP</code>æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼ŒæŒ‡å‘<code>Method</code>çš„å®ç°ï¼Œ<code>Method</code>çš„å®ç°æ˜¯ä¸ªCå‡½æ•°ï¼Œå› æ­¤ç¡®åˆ‡åœ°è¯´æ˜¯æŒ‡å‘Cå‡½æ•°çš„åœ°å€ã€‚å®ƒæœ‰ä¸¤ä¸ªå›ºå®šå‚æ•°ï¼Œåˆ†åˆ«æ˜¯<code>id</code>å’Œ<code>æ–¹æ³•é€‰æ‹©å™¨SEL</code>ï¼Œä»¥åŠå¯å˜å‚æ•°ï¼Œå¹¶ä¸”è¿”å›ä¸€ä¸ª<code>id</code>ç±»å‹çš„å¯¹è±¡ã€‚</p>
<h3 id="ç»§æ‰¿å±‚æ¬¡å›¾">ç»§æ‰¿å±‚æ¬¡å›¾</h3><p>äº†è§£äº†ä»¥ä¸Šæ¦‚å¿µåï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹OCçš„ç»§æ‰¿å±‚æ¬¡å›¾ï¼Œå…¶ä¸­å®çº¿è¡¨ç¤º<code>superclass</code>ï¼Œè™šçº¿è¡¨ç¤º<code>isa</code>æŒ‡é’ˆã€‚</p>
<p><img src="/images/runtime_8.png" alt="runtime_8"></p>
<h3 id="å®ä¾‹">å®ä¾‹</h3><p><strong>ä¾‹å­1</strong>ï¼šç»“åˆclasså’Œobjectå’Œç»“æ„ï¼Œä»¥<code>[@&quot;å‘µå‘µ&quot; stringByAppendingString:@&quot;å“’&quot;];</code>ä¸ºä¾‹å­ï¼Œè¯´æ˜æ•´ä¸ªæ¶ˆæ¯å‘é€è¿‡ç¨‹ï¼š</p>
<p>é¦–å…ˆ@â€å‘µå‘µâ€æ˜¯ä¸ªå¯¹è±¡ï¼Œruntimeç³»ç»Ÿæ ¹æ®å¯¹è±¡çš„<code>isa</code>æŒ‡é’ˆå‘ç°å®ƒçš„ç±»ï¼ˆ<code>Class</code>ï¼‰æ˜¯<code>NSString</code>ï¼Œé¦–å…ˆæŸ¥æ‰¾å®ƒçš„ç¼“å­˜ï¼ˆ<code>cache</code>ï¼‰ï¼Œå¦‚æœæ‰¾åˆ°äº†ç›´æ¥è°ƒç”¨IMPï¼Œå¦åˆ™æŸ¥çœ‹å®ƒçš„æ–¹æ³•åˆ—è¡¨ï¼ˆ<code>methodLists</code>ï¼‰ï¼Œå¦‚æœæœ¬ç±»æ‰¾ä¸åˆ°ï¼Œåˆ™æŸ¥æ‰¾çˆ¶ç±»ï¼ˆ<code>super_class</code>ï¼‰ï¼Œæœ€åæ‰¾åˆ°äº†åŒ¹é…çš„æ–¹æ³•é€‰æ‹©å™¨selector<code>-stringByAppendingString:</code>ï¼Œç„¶åå–å‡ºå’Œselectorä¸€èµ·å­˜å‚¨åœ¨<code>objc_method</code>ä¸­çš„IMPï¼Œè§¦å‘ã€‚</p>
<p><strong>ä¾‹å­2</strong>ï¼šOCç±»çš„ç»§æ‰¿å…³ç³»</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#import <span class="title">"MyClass.h"</span></span></span><br><span class="line"><span class="preprocessor">#import <span class="title">&lt;objc/runtime.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">MyClass</span></span></span><br><span class="line"></span><br><span class="line">- (instancetype)init</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        func(<span class="keyword">self</span>, <span class="keyword">@selector</span>(function), <span class="string">@"å‘µå‘µå“’"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> func(<span class="keyword">id</span> <span class="keyword">self</span>, SEL _cmd, <span class="built_in">NSString</span> *str)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"str = %@"</span>, str);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä¸»è¦èµ°å®çº¿</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"\nğŸ™ˆThis object is %p\nğŸ™ˆThis object's class is %@(%p)\nğŸ™ˆ%@'s super class is %@(%p)\nğŸ™ˆ%@'s super class is %@(%p)\nğŸ™ˆ%@'s meta class is %@(%p)\nğŸ™ˆMeta class's super class is %@(%p)"</span>, <span class="keyword">self</span>, [<span class="keyword">self</span> class], [<span class="keyword">self</span> class],</span><br><span class="line">        [<span class="keyword">self</span> class], [<span class="keyword">self</span> superclass], [<span class="keyword">self</span> superclass],</span><br><span class="line">        [<span class="keyword">self</span> superclass], [[<span class="keyword">self</span> superclass] superclass], [[<span class="keyword">self</span> superclass] superclass],</span><br><span class="line">        [<span class="keyword">self</span> superclass], object_getClass([<span class="keyword">self</span> superclass]), object_getClass([<span class="keyword">self</span> superclass]), [object_getClass([<span class="keyword">self</span> superclass]) superclass], [object_getClass([<span class="keyword">self</span> superclass]) superclass]);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// èµ°è™šçº¿</span></span><br><span class="line">    Class currentClass = [<span class="keyword">self</span> class];</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name = class_getName(currentClass);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"\nğŸ™‰ğŸ™ŠFollowing the isa pointer %d times's class is %s(%p)"</span>, i, name, currentClass);</span><br><span class="line">        currentClass = object_getClass(currentClass);</span><br><span class="line">        name = class_getName(currentClass);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œç»“æœï¼š</p>
<p><img src="/images/runtime_9.png" alt="runtime_9"></p>
<ul>
<li>selfæ˜¯ä¸ªobjectï¼Œåœ°å€ä¸º<code>0x10020dbe0</code>x</li>
<li>selfçš„ç±»æ˜¯MyClassï¼Œåœ°å€ä¸º<code>0x100004640</code></li>
<li>MyClassçš„çˆ¶ç±»æ˜¯NSObjectï¼Œåœ°å€ä¸º<code>0x7fff7542c0f0</code></li>
<li>NSObjectçš„çˆ¶ç±»æ˜¯nil</li>
<li>NSObjectçš„å…ƒç±»æ˜¯NSObjectï¼Œåœ°å€ä¸º<code>0x7fff7542c118</code></li>
<li>NSObjectçš„å…ƒç±»çš„çˆ¶ç±»æ˜¯NSObjectï¼Œåœ°å€ä¸º    <code>0x7fff7542c0f0</code></li>
<li>MyClassçš„å…ƒç±»æ˜¯MyClassï¼Œåœ°å€ä¸º<code>0x100004668</code></li>
<li>MyClassçš„å…ƒç±»çš„çˆ¶ç±»æ˜¯NSObjectï¼Œåœ°å€ä¸º<code>0x7fff7542c118</code></li>
<li>MyClassçš„å…ƒç±»çš„å…ƒç±»æ˜¯NSObjectï¼Œåœ°å€ä¸º<code>0x7fff7542c118</code></li>
</ul>
<p>æ˜¯ä¸æ˜¯ç»•æ™•äº†ï¼Œç”¨å›¾è¡¨ç¤ºä¸€ä¸‹ï¼š</p>
<p><img src="../images/runtime_10.png" alt="runtime_10"></p>
<p>å¥½äº†ï¼Œä¸‹ä¸€ç¯‡æ¥è®²è®²runtimeçš„åº”ç”¨ã€‚</p>
]]></content>
    <summary type="html">
    <![CDATA[<h3 id="id">id</h3><p>é¦–å…ˆä»<code>id</code>è¯´èµ·ï¼ŒObjective-Cä¸­idæ˜¯ä¸ªå¯ä»¥æŒ‡å‘ä»»ä½•OCå¯¹è±¡çš„æŒ‡é’ˆï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å®ƒçš„ç»“æ„</p>
<figure class="highlight thrift"><table><tr><td class]]>
    </summary>
    
  </entry>
  
  <entry>
    <title><![CDATA[Objective-C Runtimeä¹‹æ¶ˆæ¯]]></title>
    <link href="http://yoursite.com/2016/02/03/Objective-C%20Runtime%E4%B9%8B%E6%B6%88%E6%81%AF/"/>
    <id>http://yoursite.com/2016/02/03/Objective-C Runtimeä¹‹æ¶ˆæ¯/</id>
    <published>2016-02-02T16:00:00.000Z</published>
    <updated>2016-02-05T08:37:17.000Z</updated>
    <content type="html"><![CDATA[<h3 id="Method&amp;Message">Method&amp;Message</h3><p>ä»€ä¹ˆæ˜¯Methodï¼Ÿ  </p>
<p>æ–¹æ³•å°±æ˜¯ä¸€ä¸ªç±»ä¸­æœ‰åå­—çš„ä¸€ä¸²ä»£ç ï¼Œå¹³å¸¸æˆ‘ä»¬å†™çš„<br><code>- (int)func:(NString *)str { ... }</code>å°±æ˜¯ä¸€ä¸ªæ–¹æ³•ï¼Œä½†æ˜¯å®ƒåœ¨ç¼–è¯‘çš„æ—¶å€™ä¼šè¢«è½¬æ¢æˆCå‡½æ•°è°ƒç”¨ï¼Œ<br><code>static int func(SomeClass *self, SEL _cmd, NSString *str) { ... }</code>ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ‰€è°“çš„æ–¹æ³•å®é™…ä¸Šå°±æ˜¯Cå‡½æ•°ã€‚</p>
<p>ä»<code>static int func(SomeClass *self, SEL _cmd, NSString *str) { ... }</code>å°±å¯ä»¥æ˜ç™½ä¸ºä»€ä¹ˆæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>self</code>å’Œ<code>_cmd</code>ï¼Œå› ä¸ºä»–ä»¬åœ¨æºç ä¸­æ˜¯éšè—çš„ï¼Œselfä»£è¡¨ç€receiverï¼Œ_cmdä»£è¡¨è°ƒç”¨é€‰æ‹©å™¨selectorã€‚</p>
<p>ä»€ä¹ˆæ˜¯Messageï¼Ÿ  </p>
<p>æ¶ˆæ¯æ˜¯Objective-Cä¸­çš„æ ¸å¿ƒï¼Œå¿…é¡»å€ŸåŠ©äºruntimeç³»ç»Ÿæ‰èƒ½å®Œæˆã€‚å½“æˆ‘ä»¬ä¸äº†è§£runtimeçš„æ—¶å€™ï¼Œä¸€ä¸ªç®€å•çš„<code>[receiver message]</code>å¾€å¾€ä¼šè¢«è®¤ä¸ºæ˜¯å‡½æ•°è°ƒç”¨ï¼Œå®é™…ä¸Šå®ƒä»…ä»…æ˜¯åœ¨ç¼–è¯‘æœŸé—´ç¡®å®šäº†è¦å‘receiverè¿™ä¸ªæ¥æ”¶è€…å‘é€messageæ¶ˆæ¯ï¼Œè€Œreceiverå¦‚ä½•å“åº”è¿™æ¡æ¶ˆæ¯ï¼Œç¼–è¯‘é˜¶æ®µæ˜¯æ— æ³•çŸ¥æ™“çš„ï¼Œè¿™ä¸ªè¦åˆ°è¿è¡Œçš„æ—¶å€™æ¥åˆ¤æ–­äº†ã€‚</p>
<p>å¹³å¸¸æˆ‘ä»¬è°ƒç”¨çš„<code>[self func:@&quot;å‘µå‘µå“’&quot;];</code>ä¼šåœ¨ç¼–è¯‘æœŸé—´è¢«è½¬åŒ–ä¸º<code>objc_msgSend(self, @selector(func:), @&quot;å‘µå‘µå“’&quot;;</code>ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒOCä¸­å‘é€æ¶ˆæ¯ä¼šè¢«è½¬åŒ–ä¸º<code>objc_msgSend</code>ã€‚  </p>
<p>é‚£ä¹ˆï¼Œæˆ‘ä»¬æ˜¯å¦å¯ä»¥ç›´æ¥è°ƒç”¨<code>objc_msgSend</code>æ¥å‘é€æ¶ˆæ¯å‘¢ï¼Ÿç†è®ºä¸Šæ˜¯å¯ä»¥çš„ï¼Œè™½ç„¶è‹¹æœæåŠ›ä¸æ¨èã€‚å®é™…ä¸Šç¼–è¯‘å™¨ä¸ºäº†æ›´å¥½åœ°è¿›è¡Œé”™è¯¯åˆ¤æ–­ï¼Œä¼šæ‰§è¡Œä¸¥æ ¼çš„ç±»å‹æ£€æŸ¥ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæˆ‘ä»¬ç›´æ¥ç¼–å†™ä»¥ä¸Šä»£ç ï¼Œä¼šé€šä¸è¿‡ç¼–è¯‘ï¼Œå‡å¦‚æˆ‘ä»¬éè¦è¿™ä¹ˆåšï¼Œå¯ä»¥å°†ç¼–è¯‘é€‰é¡¹<em>Enable Strict Checking of objc_msgSend Calls</em>è®¾ç½®ä¸º<em>NO</em>ï¼Œæˆ–è€…å°†ä»£ç ä¿®æ”¹ä¸º<code>((int (*)(id, SEL, NSString *))objc_msgSend)(self, @selector(func:), @&quot;å‘µå‘µå“’&quot;;</code>ï¼Œå°±å¯ä»¥äº†ã€‚</p>
<p>å¥½äº†ï¼Œæ— å›¾æ— çœŸç›¸ï¼Œä¸‹é¢å°±è®©æˆ‘ä»¬ç”¨å®éªŒè¯æ˜ä¸€ä¸‹ã€‚</p>
<p>é¦–å…ˆæˆ‘ä»¬æ–°å»ºäº†ä¸€ä¸ª<code>Command Line Tool</code> Applicationï¼Œç„¶åæ–°å»ºäº†ä¸€ä¸ªåä¸ºMyClassçš„ç±»ï¼Œå¡«å†™ä»¥ä¸‹ä»£ç ï¼š</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#import <span class="title">"MyClass.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">MyClass</span></span></span><br><span class="line"></span><br><span class="line">- (instancetype)init</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        [<span class="keyword">self</span> func:<span class="string">@"å‘µå‘µå“’"</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">int</span>)func:(<span class="built_in">NSString</span> *)str</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, str);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>ç„¶åæˆ‘ä»¬ä½¿ç”¨<code>clang -rewrite-objc MyClass.m</code>å‘½ä»¤å°†OCä»£ç è½¬æ¢ä¸ºC++ä»£ç ï¼Œè¿™ä¼šåœ¨åŒç›®å½•ä¸‹ç”Ÿæˆ<code>MyClass.cpp</code>çš„C++æ–‡ä»¶ï¼Œç”¨vimæ‰“å¼€æ‰“å¼€ï¼Œè·³è½¬åˆ°10ä¸‡è¡Œå·¦å³ï¼Œå¯ä»¥çœ‹åˆ°</p>
<p><img src="/images/runtime_2.png" alt="runtime_2"></p>
<p><code>[self func:@&quot;å‘µå‘µå“’&quot;];</code>çš„ç¡®è¢«è½¬æ¢æˆäº†<code>static int _I_MyClass_func_(MyClass * self, SEL _cmd, NSString *func)</code>ã€‚</p>
<h3 id="objc_msgSend">objc_msgSend</h3><p>objc_msgSendå¯èƒ½æ˜¯iOS appè¿è¡Œæ—¶è¢«è°ƒç”¨çš„æœ€å¤šçš„å‡½æ•°äº†ï¼Œé‚£ä¹ˆå®ƒéƒ½å¹²äº†ä»€ä¹ˆï¼Ÿå¾ˆå¯æƒœï¼Œä¸ºäº†æé«˜è°ƒç”¨é€Ÿåº¦ï¼Œå®ƒæ˜¯ç”¨æ±‡ç¼–å®ç°çš„ã€‚ä¸è¿‡æˆ‘ä»¬ä»ç„¶å¯ä»¥é€šè¿‡æºç æ¥çª¥çŸ¥ä¸€äºŒã€‚æˆ‘ä»¬æ‰“å¼€runtimeæºç ç„¶åæœç´¢.sï¼Œ.sæ˜¯æ±‡ç¼–æ–‡ä»¶çš„åç¼€</p>
<p><img src="/images/runtime_3.png" alt="runtime_3"></p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œä¸åŒå¹³å°msgçš„å®ç°æ˜¯ä¸ä¸€æ ·çš„ï¼Œè¿™é‡Œæˆ‘ä»¬é€‰æ‹©X86_64çš„ï¼Œæ‰åˆ°objc_msgSendçš„å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span></span><br><span class="line"> <span class="keyword">*</span></span><br><span class="line"> <span class="keyword">*</span> id objc_msgSend(id self, SEL	_cmd,...);</span><br><span class="line"> <span class="keyword">*</span></span><br><span class="line"> <span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>/</span><br><span class="line">	</span><br><span class="line">	ENTRY	_objc_msgSend</span><br><span class="line">	DW_START _objc_msgSend</span><br><span class="line"></span><br><span class="line">// check whether selector is ignored</span><br><span class="line">// æ£€æŸ¥selectoræ˜¯å¦å¯ä»¥å¿½ç•¥</span><br><span class="line">	cmpq    $ kIgnore, %a2</span><br><span class="line">	// å¦‚æœå¯ä»¥å¿½ç•¥ï¼Œç›´æ¥è¿”å›self</span><br><span class="line">	je      LMsgSendReturnSelf	// ignore and return self</span><br><span class="line"></span><br><span class="line">// check whether receiver is nil </span><br><span class="line">// æ£€æŸ¥æ¶ˆæ¯æ¥æ”¶è€…æ˜¯å¦æ˜¯nil</span><br><span class="line">	testq	%a1, %a1</span><br><span class="line">	// è·³è½¬å“åº”çš„å¤„ç†</span><br><span class="line">	je	LMsgSendNilSelf</span><br><span class="line"></span><br><span class="line">// receiver (in %a1) is non-nil: search the cache</span><br><span class="line">// å¦‚æœæ¥æ”¶è€…ä¸æ˜¯nilï¼Œåˆ™æŸ¥æ‰¾è¿™ä¸ªselectorï¼Œå…ˆä»ç¼“å­˜ä¸­æ‰¾</span><br><span class="line"></span><br><span class="line">// ç¼“å­˜å‘½ä¸­</span><br><span class="line">LMsgSendReceiverOk:</span><br><span class="line">	// è·å–å®ƒçš„isaæŒ‡é’ˆï¼Œç¡®å®šå®ƒçš„ç±»</span><br><span class="line">	movq	isa(%a1), %r11		// class = self-&gt;isa</span><br><span class="line">	CacheLookup %a2, _objc_msgSend</span><br><span class="line">	// CacheLookup placed method in r11</span><br><span class="line">	movq	method_imp(%r11), %r11</span><br><span class="line">	cmp	%r11, %r11		// set nonstret (eq) for </span><br><span class="line">forwarding</span><br><span class="line">	// æ‰¾åˆ°äº†selectorï¼Œè·³è½¬åˆ°å‡½æ•°å®ç°å»æ‰§è¡Œ</span><br><span class="line">	jmp	<span class="keyword">*</span>%r11			// goto <span class="keyword">*</span>imp</span><br><span class="line"></span><br><span class="line">// cache miss: go search the method lists</span><br><span class="line">// ç¼“å­˜æ²¡æœ‰æ‰¾åˆ°ï¼Œæœç´¢æ–¹æ³•åˆ—è¡¨</span><br><span class="line">LCacheMiss_objc_msgSend:</span><br><span class="line">	MethodTableLookup isa(%a1), %a2, _objc_msgSend</span><br><span class="line">	// MethodTableLookup placed IMP in r11</span><br><span class="line">	cmp	%r11, %r11		// set nonstret (eq) for </span><br><span class="line">// åœ¨æ–¹æ³•åˆ—è¡¨ä¸­æ‰¾åˆ°äº†selectorï¼Œè·³è½¬åˆ°å‡½æ•°å®ç°å»æ‰§è¡Œ</span><br><span class="line">forwarding</span><br><span class="line">	jmp	<span class="keyword">*</span>%r11			// goto <span class="keyword">*</span>imp</span><br><span class="line"></span><br><span class="line">// message sent to nil: redirect to nil receiver, if any</span><br><span class="line">// æ¶ˆæ¯æ˜¯å¦å‘é€ç»™nilåŠä¹‹åçš„å¤„ç†</span><br><span class="line">LMsgSendNilSelf:</span><br><span class="line">	movq	__objc_nilReceiver(%rip), %a1</span><br><span class="line">	// æ¥æ”¶è€…ä¸æ˜¯nil</span><br><span class="line">	testq	%a1, %a1		// if (receiver != nil)</span><br><span class="line">	// è·³è½¬åˆ°ä¹‹åçš„å¤„ç†</span><br><span class="line">	jne	LMsgSendReceiverOk	//   send to new receiver</span><br><span class="line"></span><br><span class="line">	// message sent to nil - return 0</span><br><span class="line">	// æ¥æ”¶è€…æ˜¯nilï¼Œç›´æ¥è¿”å›0</span><br><span class="line">	movq	$0, %rax</span><br><span class="line">	movq	$0, %rdx</span><br><span class="line">	xorps	%xmm0, %xmm0</span><br><span class="line">	xorps	%xmm1, %xmm1</span><br><span class="line">	ret</span><br><span class="line">	</span><br><span class="line">LMsgSendReturnSelf:</span><br><span class="line">	movq	%a1, %rax</span><br><span class="line">	ret</span><br><span class="line"></span><br><span class="line">LMsgSendExit:</span><br><span class="line">	DW_END 		_objc_msgSend</span><br><span class="line">	END_ENTRY	_objc_msgSend</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡æ±‡ç¼–å¤§è‡´å¯ä»¥çŸ¥é“objc_msgSendçš„å…·ä½“æ­¥éª¤ï¼š</p>
<ol>
<li>æ£€æŸ¥selectoræ˜¯å¦å¯ä»¥å¿½ç•¥<ul>
<li>å¯ä»¥å¿½ç•¥ï¼Œè¿”å›self</li>
<li>ä¸å¯ä»¥å¿½ç•¥ï¼Œè·³è½¬åˆ°2</li>
</ul>
</li>
<li>æ£€æŸ¥æ¶ˆæ¯æ¥æ”¶è€…æ˜¯å¦æ˜¯nil<ul>
<li>ä¸æ˜¯nilï¼Œè·³è½¬åˆ°3</li>
<li>æ˜¯nilï¼Œç›´æ¥è¿”å›0</li>
</ul>
</li>
<li>æ‰‹å…ˆä»ç¼“å­˜ä¸­æŸ¥æ‰¾selector  <ul>
<li>å¦‚æœç¼“å­˜å‘½ä¸­ï¼Œåˆ™æ‰§è¡Œå®ƒçš„imp</li>
<li>å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç¼“å­˜ï¼Œè·³è½¬åˆ°4</li>
</ul>
</li>
<li>å…ˆä»æœ¬ç±»çš„æ–¹æ³•åˆ—è¡¨ä¸­æ‰¾ï¼ˆæˆ–è€…<code>dispatch table</code>å³åˆ†å‘è¡¨ï¼‰<ul>
<li>å¦‚æœæ‰¾åˆ°ï¼Œåˆ™æ‰§è¡Œå®ƒçš„impï¼ŒåŒæ—¶ä»¥selectorä¸ºkeyï¼Œimpçš„åœ°å€ä¸ºvalueå­˜å…¥ç¼“å­˜<ul>
<li>å¦‚æœæ²¡æ‰¾åˆ°ï¼Œåˆ™é€šè¿‡isaæŒ‡é’ˆç»§ç»­æŸ¥æ‰¾å…¶çˆ¶ç±»çš„åˆ†å‘è¡¨ç›´åˆ°æ ¹ç±»NSObject</li>
</ul>
</li>
</ul>
</li>
<li>å¦‚æœåˆ°NSObjectè¿˜æ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™æ‰§è¡Œ<strong>åŠ¨æ€æ–¹æ³•å†³è®®</strong></li>
<li><p>åŠ¨æ€æ–¹æ³•å†³è®®æ˜¯ä¸ªå¾ˆé‡è¦çš„æµç¨‹ï¼Œæ¥ä¸‹æ¥ä¼šé‡ç‚¹è®²</p>
<p> æ•´ä¸ªè¿‡ç¨‹å¯ç”¨ä¸‹å›¾è¡¨ç¤º</p>
</li>
</ol>
<p><img src="/images/runtime_4_1.png" alt="runtime_4_1"></p>
<h3 id="åŠ¨æ€æ–¹æ³•å†³è®®ï¼ˆDynamic_Method_Resolutionï¼‰">åŠ¨æ€æ–¹æ³•å†³è®®ï¼ˆDynamic Method Resolutionï¼‰</h3><p>ä¸Šé¢æåˆ°äº†ï¼Œå½“åˆ°NSObjectè¿˜æ²¡æœ‰æ‰¾åˆ°selectorçš„æ—¶å€™ï¼Œå°±è¿›å…¥äº†<strong>åŠ¨æ€æ–¹æ³•å†³è®®</strong>ï¼Œç®€å•çš„è¯´å°±æ˜¯å½“æˆ‘ä»¬æ— æ³•æ‰¾åˆ°åŒ¹é…çš„æ–¹æ³•å®ç°æ—¶ï¼Œruntimeå…è®¸æˆ‘ä»¬åœ¨è¿è¡ŒæœŸé—´åŠ¨æ€åœ°æ·»åŠ ä¸€ä¸ªæ–¹æ³•ã€‚</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="built_in">BOOL</span>)resolveInstanceMethod:(SEL)aSEL &#123;</span><br><span class="line">    <span class="keyword">if</span> (aSEL == <span class="keyword">@selector</span>(resolveThisMethodDynamically)) &#123;</span><br><span class="line">    	class_addMethod([<span class="keyword">self</span> class], aSEL, (IMP)dynamicMethodIMP, <span class="string">"v@:"</span>);</span><br><span class="line">    	<span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> resolveInstanceMethod:aSEL];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> dynamicMethodIMP(<span class="keyword">id</span> <span class="keyword">self</span>, SEL _cmd) &#123;</span><br><span class="line">    <span class="comment">// implementation ....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ä¸»è¦åšäº†ä»¥ä¸‹å‡ ä»¶äº‹</p>
<ul>
<li>å®ç°<code>+resolveInstanceMethod:</code>æˆ–è€…<code>+resolveClassMethod:</code></li>
<li>æ£€æŸ¥selectoræ˜¯ä¸æ˜¯æˆ‘ä»¬æƒ³è¦å¤„ç†çš„æ–¹æ³•  <ul>
<li>åŒ¹é…ï¼Œåˆ™é€šè¿‡<code>class_addMethod</code>æ·»åŠ ä¸€ä¸ªæ–¹æ³•å¹¶è¿”å›YESï¼Œå¯ä»¥çœ‹åˆ°æ·»åŠ çš„æ–¹æ³•æ˜¯ä¸€ä¸ªç®€å•çš„Cå‡½æ•°</li>
<li>ä¸åŒ¹é…ï¼Œè°ƒç”¨superå¤„ç† </li>
</ul>
</li>
<li>æ³¨æ„å¦‚æœæˆ‘ä»¬ä¸æä¾›ä¸€ä¸ªå®ç°ç›´æ¥è¿”å›ä¼šæŠ›å‡º<code>NSInvalidArgumentException</code>å¼‚å¸¸</li>
</ul>
<h3 id="æ¶ˆæ¯è½¬å‘ï¼ˆMessage_Forwardingï¼‰">æ¶ˆæ¯è½¬å‘ï¼ˆMessage Forwardingï¼‰</h3><p>å¦‚æœåŠ¨æ€æ–¹æ³•å†³è®®è¿˜æ²¡æœ‰è§£å†³ï¼Œåˆ™è¿›å…¥äº†æ¶ˆæ¯è½¬å‘æµç¨‹ï¼Œå¯åˆ†ä¸ºå¿«é€Ÿè½¬å‘å’Œæ ‡å‡†è½¬å‘ã€‚</p>
<h4 id="å¿«é€Ÿè½¬å‘ï¼ˆFast_Forwardingï¼‰">å¿«é€Ÿè½¬å‘ï¼ˆFast Forwardingï¼‰</h4><p>é€šè¿‡å¿«é€Ÿè½¬å‘æˆ‘ä»¬å¯ä»¥å°†æ¶ˆæ¯å¿«é€Ÿåœ°è½¬å‘ç»™å¦ä¸€ä¸ªå¯¹è±¡ï¼Œæˆ–è€…å¿½ç•¥ï¼Œä½†æ˜¯æˆ‘ä»¬æ— æ³•åœ¨å¿«é€Ÿè½¬å‘ä¸­æ”¹å†™æ¶ˆæ¯ã€‚</p>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- (id)<span class="string">forwardingTargetForSelector:</span>(SEL)aSelector &#123;</span><br><span class="line">    <span class="keyword">if</span> (aSelector == <span class="annotation">@selector</span>(<span class="string">foo:</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> anotherObject;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> <span class="string">forwardingTargetForSelector:</span>aSelector];;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ä¸»è¦åšäº†ä»¥ä¸‹ä¸‰ä»¶äº‹ï¼š</p>
<ul>
<li>å®ç°<code>-forwardingTargetForSelector:</code></li>
<li>æ£€æŸ¥selectoræ˜¯å¦æ˜¯æˆ‘ä»¬æƒ³è¦å¤„ç†çš„æ–¹æ³•<ul>
<li>åŒ¹é…ï¼Œè½¬å‘ç»™èƒ½å¤Ÿå¤„ç†è¯¥æ¶ˆæ¯çš„å¯¹è±¡</li>
<li>ä¸åŒ¹é…ï¼Œè°ƒç”¨superå¤„ç†</li>
</ul>
</li>
</ul>
<h4 id="æ ‡å‡†è½¬å‘ï¼ˆNormal_Forwardingï¼‰">æ ‡å‡†è½¬å‘ï¼ˆNormal Forwardingï¼‰</h4><p>å¿«é€Ÿè½¬å‘ä¹‹åå°±æ˜¯æ ‡å‡†è½¬å‘ï¼Œé€šè¿‡æ ‡å‡†è½¬å‘æˆ‘ä»¬å¯ä»¥å®Œæ•´çš„å®ç°è½¬å‘æµç¨‹ï¼Œåœ¨é”™è¯¯ä¹‹å‰ç»™äº†æˆ‘ä»¬æœ€åä¸€æ¬¡æœºä¼šã€‚</p>
<p>runtimeç³»ç»Ÿé¦–å…ˆä¼šè°ƒç”¨<code>-methodSignatureForSelector:</code>å»è·å–æ–¹æ³•ç­¾åï¼Œç„¶åä½¿ç”¨æ–¹æ³•ç­¾åå»åˆ›å»º<code>NSInvocation</code>å¯¹è±¡ï¼Œå®ƒå°è£…äº†åŸå§‹æ¶ˆæ¯å’Œå‚æ•°ï¼›æ¥ç€<code>-forwardInvocation:</code>è¢«è°ƒç”¨ï¼Œä½¿ç”¨æ–°åˆ›å»ºçš„NSInvocationä½œä¸ºå‚æ•°ï¼Œé»˜è®¤çš„<code>-forwardInvocation:</code>ä¼šå‘é€<code>-doesNotRecognizeSelector</code>æ¶ˆæ¯æŠ›å‡ºå¼‚å¸¸ï¼Œå› æ­¤æˆ‘ä»¬å¿…é¡»è¦†å†™<code>-forwardInvocation:</code>ï¼ŒåŒæ—¶ä¹Ÿè¦è¦†å†™<code>-methodSignatureForSelector:</code>å»ç”Ÿæˆä¸€ä¸ªæ–¹æ³•ç­¾åã€‚</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">- (NSMethodSignature *)<span class="string">methodSignatureForSelector:</span>(SEL)selector &#123;</span><br><span class="line">    NSMethodSignature *signature = [<span class="keyword">super</span> <span class="string">methodSignatureForSelector:</span>selector];</span><br><span class="line">    <span class="keyword">if</span> (!signature) &#123;</span><br><span class="line">        signature = [anotherObject <span class="string">methodSignatureForSelector:</span>selector];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> signature;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="typename">void</span>)<span class="string">forwardInvocation:</span>(NSInvocation *)anInvocation &#123;</span><br><span class="line">    <span class="keyword">if</span> ([anotherObject <span class="string">respondsToSelector:</span></span><br><span class="line">         [anInvocation selector]]) &#123;</span><br><span class="line">        [anInvocation <span class="string">invokeWithTarget:</span>anotherObject];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        [<span class="keyword">super</span> <span class="string">forwardInvocation:</span>anInvocation];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="é”™è¯¯">é”™è¯¯</h3><p>å¦‚æœåŠ¨æ€æ–¹æ³•å†³è®®å’Œæ¶ˆæ¯è½¬å‘éƒ½æ²¡æœ‰è§£å†³ï¼Œé‚£åªå¥½æŠ›å‡ºå¼‚å¸¸ã€‚runtimeä¼šå‘é€<code>-doesNotRecognizeSelector:</code>æ¶ˆæ¯ï¼Œæ¥ç€æŠ›å‡º<code>NSInvalidArgumentException</code>å¼‚å¸¸ï¼Œæ•´ä¸ªè¿‡ç¨‹ä¹Ÿå°±ç»“æŸäº†ã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬ç”¨å®éªŒè¯æ˜ä¸€ä¸‹ã€‚</p>
<p>æˆ‘ä»¬è°ƒç”¨äº†MyClassçš„fooæ–¹æ³•ï¼Œè€Œfooå£°æ˜äº†ä¹‹åå¹¶æ²¡æœ‰å®ç°ï¼Œç„¶åæˆ‘ä»¬åœ¨å¯èƒ½å‘é€å¼‚å¸¸çš„åœ°æ–¹æ‰“ä¸ªæ–­ç‚¹ï¼Œè¿è¡Œåˆ°æ–­ç‚¹å¤„çš„æ—¶å€™ï¼Œæˆ‘ä»¬åœ¨æ§åˆ¶å°è¾“å…¥<code>call (void)instrumentObjcMessageSends(YES)</code>ï¼Œè¡¨ç¤ºæˆ‘ä»¬è¦è®°å½•ä¹‹åå‘é€çš„æ¶ˆæ¯ï¼š</p>
<p><img src="/images/runtime_5.png" alt="runtime_5"></p>
<p>æ¥ç€ç»§ç»­æ‰§è¡Œï¼Œç¨‹åºä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œç„¶åæ‰“å¼€<code>/private/tmp</code>ç›®å½•ï¼Œæ‰“å¼€æœ€æ–°çš„ä»¥<code>msgSends-pid</code>å‘½åçš„æ–‡ä»¶</p>
<p><img src="/images/runtime_6.png" alt="runtime_6"></p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œä¾æ¬¡æŒ‰ç…§ä»¥ä¸‹é¡ºåºå‘é€æ¶ˆæ¯</p>
<ul>
<li><code>-resolveInstanceMethod:</code></li>
<li><code>-forwardingTargetForSelector:</code></li>
<li><code>-methodSignatureForSelector:</code></li>
<li><code>-forwardInvocation:</code></li>
<li><code>-doesNotRecognizeSelector:</code></li>
</ul>
<p>è¿™é‡Œç”±äº<code>-methodSignatureForSelector:</code>æ²¡æœ‰è·å–åˆ°æœ‰æ•ˆç­¾åï¼Œå› æ­¤<code>-forwardInvocation:</code>æ¶ˆæ¯å¹¶æ²¡æœ‰å‘é€ã€‚</p>
<p>ç»¼ä¸Šï¼Œå¯ä»¥ç”¨å¦‚ä¸‹è¿™å¼ å›¾æ¥æè¿°æ•´ä¸ªè¿‡ç¨‹</p>
<p><img src="/images/runtime_7.png" alt="runtime_7"></p>
]]></content>
    <summary type="html">
    <![CDATA[<h3 id="Method&amp;Message">Method&amp;Message</h3><p>ä»€ä¹ˆæ˜¯Methodï¼Ÿ  </p>
<p>æ–¹æ³•å°±æ˜¯ä¸€ä¸ªç±»ä¸­æœ‰åå­—çš„ä¸€ä¸²ä»£ç ï¼Œå¹³å¸¸æˆ‘ä»¬å†™çš„<br><code>- (int)func:(NString *)str { ... ]]>
    </summary>
    
  </entry>
  
  <entry>
    <title><![CDATA[Objective-C Runtimeä¹‹æ¦‚è§ˆ]]></title>
    <link href="http://yoursite.com/2016/02/01/Objective-C%20Runtime%E4%B9%8B%E6%A6%82%E8%A7%88/"/>
    <id>http://yoursite.com/2016/02/01/Objective-C Runtimeä¹‹æ¦‚è§ˆ/</id>
    <published>2016-01-31T16:00:00.000Z</published>
    <updated>2016-02-03T14:03:24.000Z</updated>
    <content type="html"><![CDATA[<p>ä»€ä¹ˆï¼Œä½ å’Œæˆ‘è¯´runtimeï¼Œå¤§å¤šæ•°iOSç¨‹åºå‘˜å¬åˆ°runtimeçš„æ—¶å€™ï¼Œè„‘å­é‡Œç¬¬ä¸€åæ˜ ä¾¿æ˜¯ï¼Œè¿™è´§å¤ªç‰¹ä¹ˆæŠ½è±¡éš¾ç†è§£äº†ï¼Œè€Œä¸”å·¥ä½œä¸­ä¸å¸¸ç”¨åˆ°ã€‚çš„ç¡®ï¼Œæˆ‘ä¹Ÿæ˜¯è¿™ä¹ˆè®¤ä¸ºçš„ï¼ŒObjective-Cé‡Œä¸¤å¤§æœ€éš¾çš„ç‚¹å½“å±Runtimeå’ŒRunloopã€‚ç„¶è€Œï¼Œéš¾è™½éš¾ï¼Œè¿™ç¡¬éª¨å¤´è¿˜æ˜¯è¦å•ƒå•Šï¼Œä¸ç„¶ç†è§£ä¸åˆ°è¿™é—¨è¯­è¨€çš„ç²¾é«“å‘€ã€‚</p>
<p>æˆ‘ä»¬éƒ½çŸ¥é“ï¼ŒObjective-Cè¿™é—¨è¯­è¨€æ˜¯åŠ¨æ€çš„ï¼Œæ˜¯æ‰©å……äºCçš„é¢å‘å¯¹è±¡è¯­è¨€ï¼Œæ‰€è°“åŠ¨æ€çš„æ ¸å¿ƒå°±æ˜¯<code>Runtime</code>ã€‚å¹³å¸¸å†™ç¨‹åºçš„æ—¶å€™ï¼Œå®ƒè¢«ç³»ç»ŸåŠ è½½è¿›å»ï¼Œç„¶ååœ¨å¹•åé»˜é»˜å·¥ä½œç€ï¼Œæˆ‘ä»¬ç”šè‡³å¯Ÿè§‰ä¸åˆ°å®ƒçš„å­˜åœ¨ã€‚ä½†æ˜¯ï¼Œå‡å¦‚æ²¡æœ‰å®ƒï¼ŒOCå°±è¿è¡Œä¸äº†äº†ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ<code>C + Runtime = Objctive-C</code>ã€‚</p>
<h1 id="runtime-h">runtime.h</h1><p>runtimeæ˜¯å¼€æºçš„ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨<a href="https://opensource.apple.com/tarballs/objc4/" target="_blank" rel="external">https://opensource.apple.com/tarballs/objc4/</a>ä¸‹è½½ã€‚</p>
<p>runtime.hé‡Œå£°æ˜äº†ä»¥ä¸‹å¼€å¤´çš„å‡½æ•°ï¼Œæˆ‘ä»¬é€šè¿‡è§‚å¯Ÿç±»çš„å‘½åå¯ä»¥å‘ç°ï¼š</p>
<ul>
<li><code>objc_...</code><br>å’Œruntimeä¸€äº›å±æ€§è®¾ç½®æœ‰å…³ã€‚æ¯”å¦‚<ul>
<li>ç±»ç›¸å…³<br>åˆ›å»ºä¸€ä¸ªç±»ï¼ˆ<em>objc_allocateClassPair</em>ï¼‰ã€æ³¨å†Œè¯¥ç±»ï¼ˆ<em>objc_registerClassPair</em>ï¼‰ã€é”€æ¯è¯¥ç±»ï¼ˆ<em>objc_disposeClassPair</em>ï¼‰ã€æŒ‡å®šç±»åè¿”å›è¯¥ç±»ï¼ˆ<em>objc_getClass</em>ï¼‰ã€æŒ‡å®šç±»åè¿”å›è¯¥ç±»å…ƒç±»ï¼ˆ<em>objc_getMetaClass</em>ï¼‰ã€è·å–æ³¨å†Œçš„ç±»çš„åˆ—è¡¨ï¼ˆ<em>objc_getClassList</em>æˆ–è€…<em>objc_copyClassList</em>ï¼‰ç­‰</li>
<li>å¯¹è±¡ç›¸å…³<br>è®¾ç½®å…³è”å¯¹è±¡ï¼ˆ<em>objc_setAssociatedObject</em>ï¼‰ï¼Œè·å–å…³è”å¯¹è±¡ï¼ˆ<em>objc_getAssociatedObject</em>ï¼‰ç­‰ã€‚</li>
<li>åè®®ç›¸å…³<br>åˆ›å»ºä¸€ä¸ªåè®®ï¼ˆ<em>objc_allocateProtocol</em>ï¼‰ã€æ³¨å†Œè¯¥åè®®ï¼ˆ<em>objc_registerProtocol</em>ï¼‰ã€æŒ‡å®šåè®®åå­—è·å–åè®®ï¼ˆ<em>objc_getProtocol</em>ï¼‰ã€è¿è¡Œæ—¶æ‰€æœ‰çš„åè®®åï¼ˆ<em>objc_copyProtocolList</em>ï¼‰ç­‰ã€‚</li>
</ul>
</li>
<li><p><code>class_...</code><br>å’Œç±»ç›¸å…³ã€‚<br>æ¯”å¦‚è·å–ç±»åï¼ˆ<em>class_getName</em>ï¼‰ã€ä¸ºç±»æ·»åŠ ä¸€ä¸ªæ–°çš„æ–¹æ³•ï¼ˆ<em>class_addMethod</em>ï¼‰ã€è·å–ç±»å¯¹åº”é€‰æ‹©å™¨çš„æ–¹æ³•æè¿°Methodï¼ˆ<em>class_getClassMethod</em>ï¼‰ã€è·å–ç±»çš„å˜é‡åˆ—è¡¨ï¼ˆ<em>class_copyIvarList</em>ï¼‰ã€å±æ€§åˆ—è¡¨ï¼ˆ<em>class_copyPropertyList</em>ï¼‰ã€åè®®åˆ—è¡¨ï¼ˆ<em>class_copyProtocolList</em>ï¼‰ã€æ–¹æ³•åˆ—è¡¨ï¼ˆ<em>class_copyMethodList</em>ï¼‰ç­‰ã€‚</p>
</li>
<li><p><code>object_..</code><br>å’Œå¯¹è±¡ç›¸å…³ã€‚<br>æ¯”å¦‚è·å–å¯¹è±¡çš„ç±»åï¼ˆ<em>object_getClassName</em>ï¼‰ã€è·å–å¯¹è±¡æŸä¸ªå˜é‡çš„å€¼ï¼ˆ<em>object_getIvar</em>ï¼‰ç­‰ã€‚</p>
</li>
<li><p><code>method_...</code><br>å’Œæ–¹æ³•æè¿°æœ‰å…³ã€‚<br>æ¯”å¦‚è·å–æ–¹æ³•åSELï¼ˆ<em>method_getName</em>ï¼‰ã€æ–¹æ³•çš„å®ç°IMPï¼ˆ<em>method_getImplementation</em>ï¼‰ã€å‚æ•°å’Œè¿”å›å‚æ•°çš„ç±»å‹ç¼–ç ï¼ˆ<em>method_getTypeEncoding</em>ï¼‰ç­‰ã€‚</p>
</li>
<li><p><code>ivar_...</code><br>å’Œå˜é‡æœ‰å…³ã€‚<br>æ¯”å¦‚è·å–å˜é‡åï¼ˆ<em>ivar_getName</em>ï¼‰ã€å®ä¾‹å˜é‡çš„ç±»å‹ç¼–ç ï¼ˆ<em>ivar_getTypeEncoding</em>ï¼‰ç­‰ã€‚</p>
</li>
<li><p><code>property_...</code><br>å’Œå±æ€§æ–¹æ³•æœ‰å…³ã€‚<br>æ¯”å¦‚è·å–å±æ€§åï¼ˆ<em>property_getName</em>ï¼‰ã€å±æ€§çš„ç¼–ç ï¼ˆ<em>property_getAttributes</em>ï¼‰ç­‰ã€‚</p>
</li>
<li><p><code>protocol_...</code><br>å’Œåè®®æœ‰å…³ã€‚<br>æ¯”å¦‚è·å–åè®®åï¼ˆ<em>protocol_getName</em>ï¼‰ã€åè®®çš„æ–¹æ³•æè¿°ï¼ˆprotocol_getMethodDescriptionï¼‰ã€åˆ¤æ–­æŸä¸ªåè®®æ˜¯å¦å®ç°å¦ä¸€ä¸ªåè®®ï¼ˆ<em>protocol_conformsToProtocol</em>ï¼‰ç­‰ã€‚</p>
</li>
<li><p><code>sel_...</code><br>å’Œæ–¹æ³•é€‰æ‹©å™¨selectorsæœ‰å…³ã€‚<br>æ¯”å¦‚è·å–é€‰æ‹©å™¨çš„åå­—ï¼ˆ<em>sel_getName</em>ï¼‰ã€æ³¨å†Œä¸€ä¸ªé€‰æ‹©å™¨ï¼ˆ<em>sel_registerName</em>æˆ–è€…<em>sel_getUid</em>ï¼‰ç­‰ã€‚</p>
</li>
<li><p><code>imp_...</code><br>å’Œæ–¹æ³•çš„å®ç°æœ‰å…³ã€‚<br>æ¯”å¦‚ç”¨blockå®ç°æŸselectorçš„å…·ä½“å®ç°ï¼ˆ<em>imp_implementationWithBlock</em>ï¼‰ç­‰</p>
</li>
</ul>
<h1 id="foundation-h">foundation.h</h1><p><code>Foundation</code>æ˜¯ä¸€ä¸ªframeworkï¼Œå®ƒå®šä¹‰äº†OCç±»çš„åŸºç¡€ã€‚å…¶ä¸­ï¼ŒNSObjectç±»æ˜¯Cocoaé‡Œå¤§éƒ¨åˆ†ç±»çš„åŸºç±»ï¼Œå®ƒå®šä¹‰äº†ä¸€äº›åŸºç¡€çš„æ–¹æ³•ï¼Œæ¯”å¦‚<code>description</code>æ–¹æ³•ï¼ŒNSObjectå¯¹è¿™ä¸ªæ–¹æ³•çš„å®ç°ä»…ä»…æ˜¯è¿”å›å¯¹è±¡çš„åå­—å’Œåœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¦†å†™è¯¥æ–¹æ³•æ¥è¿”å›æ›´å¤šçš„ä¿¡æ¯ã€‚</p>
<p>é™¤äº†å®ç°äº†ä¸€äº›åŸºæœ¬çš„æ–¹æ³•ï¼ŒNSObjectä¹Ÿå®šä¹‰äº†éƒ¨åˆ†çš„runtimeæ¥å£ï¼š</p>
<ul>
<li><code>- (Class)class;</code></li>
<li><code>- (BOOL)isKindOfClass:(Class)class;</code></li>
<li><code>- (BOOL)isMemberOfClass:(Class)aClass;</code></li>
<li><code>- (BOOL)respondsToSelector:(SEL)selector;</code></li>
<li><code>+ (BOOL)instancesRespondToSelector:(SEL)aSelector;</code></li>
<li><code>- (id)performSelector:(SEL)selector;</code></li>
<li><code>- (IMP)methodForSelector:(SEL)aSelector;</code></li>
<li><code>+ (IMP)instanceMethodForSelector:(SEL)aSelector;</code></li>
<li><code>- (void)doesNotRecognizeSelector:(SEL)aSelector;</code></li>
<li><code>- (BOOL)conformsToProtocol:(Protocol *)aProtocol;</code></li>
<li><code>+ (BOOL)conformsToProtocol:(Protocol *)protocol;</code></li>
</ul>
]]></content>
    <summary type="html">
    <![CDATA[<p>ä»€ä¹ˆï¼Œä½ å’Œæˆ‘è¯´runtimeï¼Œå¤§å¤šæ•°iOSç¨‹åºå‘˜å¬åˆ°runtimeçš„æ—¶å€™ï¼Œè„‘å­é‡Œç¬¬ä¸€åæ˜ ä¾¿æ˜¯ï¼Œè¿™è´§å¤ªç‰¹ä¹ˆæŠ½è±¡éš¾ç†è§£äº†ï¼Œè€Œä¸”å·¥ä½œä¸­ä¸å¸¸ç”¨åˆ°ã€‚çš„ç¡®ï¼Œæˆ‘ä¹Ÿæ˜¯è¿™ä¹ˆè®¤ä¸ºçš„ï¼ŒObjective-Cé‡Œä¸¤å¤§æœ€éš¾çš„ç‚¹å½“å±Runtimeå’ŒRunloopã€‚ç„¶è€Œï¼Œéš¾è™½éš¾ï¼Œè¿™ç¡¬éª¨å¤´è¿˜æ˜¯è¦å•ƒå•Šï¼Œä¸ç„¶ç†]]>
    </summary>
    
  </entry>
  
  <entry>
    <title><![CDATA[ä½ å¿…é¡»äº†è§£çš„Xcodeè°ƒè¯•æŠ€å·§]]></title>
    <link href="http://yoursite.com/2016/01/28/%E4%BD%A0%E5%BF%85%E9%A1%BB%E4%BA%86%E8%A7%A3%E7%9A%84Xcode%E8%B0%83%E8%AF%95%E6%8A%80%E5%B7%A7/"/>
    <id>http://yoursite.com/2016/01/28/ä½ å¿…é¡»äº†è§£çš„Xcodeè°ƒè¯•æŠ€å·§/</id>
    <published>2016-01-27T16:00:00.000Z</published>
    <updated>2016-01-30T09:27:38.000Z</updated>
    <content type="html"><![CDATA[<p>æˆ‘ä»¬å¼€å‘iOSæˆ–è€…OSXç¨‹åºæ—¶å€™ï¼Œè°ƒè¯•æ˜¯é¿å…ä¸äº†çš„ï¼Œè€Œè°ƒè¯•æœ€å¤§çš„ä¸€ä¸ªåˆ©å™¨å°±æ˜¯æ–­ç‚¹ã€‚æ¥ä¸‹æ¥æˆ‘ä»‹ç»ä¸€ä¸‹Xcodeä¸€äº›å¸¸ç”¨çš„å’Œä¸å¸¸ç”¨çš„æŠ€å·§ã€‚</p>
<h4 id="æ¡ä»¶æ–­ç‚¹">æ¡ä»¶æ–­ç‚¹</h4><p>å¦‚ä¸‹å›¾ï¼Œè¿™æ˜¯ä¸ªæœ€åŸºæœ¬çš„æ–­ç‚¹ï¼Œæˆ‘ä»¬å†™äº†ä¸€ä¸ª0åˆ°10000çš„å¾ªç¯ï¼Œéœ€è¦åœ¨å¾ªç¯åˆ°5000çš„æ—¶å€™æ‰“ä¸ªæ–­ç‚¹ã€‚</p>
<p><img src="/images/debug_1.png" alt="debug_1"></p>
<p>æˆ‘ä»¬åœ¨Conditioné‡Œå¡«å†™æˆ‘ä»¬çš„æ¡ä»¶ï¼Œè¿™æ ·å½“idx=5000çš„æ—¶å€™ç¨‹åºå°±ä¼šåœåœ¨è¿™é‡Œã€‚</p>
<h4 id="é«˜çº§logæœ¯">é«˜çº§logæœ¯</h4><p>ç»å¸¸åœ¨è°ƒè¯•ç¨‹åºçš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ç¨‹åºé‡Œé¢æ‰“å°ä¸€äº›ä¸œè¥¿ï¼Œæœ€å¸¸ç”¨çš„å°±æ˜¯NSLogï¼Œä½†æ˜¯NSLogæœ‰å‡ ä¸ªç¼ºç‚¹</p>
<ul>
<li>NSLogä¼šæ‹–æ…¢è¿è¡Œé€Ÿåº¦ï¼Œæ•ˆç‡ä½</li>
<li>å¤§é‡logå¯¼è‡´ä»£ç æ··ä¹±</li>
<li>æœ€é‡è¦çš„ä¸€ç‚¹ï¼Œå‡å¦‚æˆ‘ä»¬åœ¨ç¨‹åºè¿è¡Œçš„æ—¶å€™æƒ³è¦æ‰“å°æŸäº›ä¿¡æ¯ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯èƒ½ä¼šæƒ³åˆ°ä½¿ç”¨<code>po</code>ï¼Œè¿™ä¸ªåœ¨æ‰“å°å•ä¸ªä¿¡æ¯çš„æ—¶å€™å¾ˆæœ‰ç”¨ï¼Œä½†æ˜¯æ¯”å¦‚åœ¨ä¸Šé¢æˆ‘ä»¬çš„å¾ªç¯é‡Œé¢ï¼Œæˆ‘éœ€è¦çŸ¥é“æ¯æ¬¡å¶æ•°çš„æ—¶å€™çš„idxæ˜¯å¤šå°‘ï¼Œé‚£å°±ä¸å¾—ä¸åœ¨ç¼–å†™å®Œåé‡æ–°ç¼–è¯‘è¿è¡Œï¼Œå¾ˆéº»çƒ¦ã€‚</li>
</ul>
<p>é‚£ä¹ˆæ€ä¹ˆåŠå‘¢ï¼Œè¿˜æ˜¯åœ¨æ¡ä»¶æ–­ç‚¹é‡Œé¢è®¾ç½®</p>
<p><img src="/images/debug_2.png" alt="debug_2"></p>
<p>æˆ‘ä»¬é¦–å…ˆè®¾ç½®æ¡ä»¶ä¸ºå¶æ•°ï¼Œç„¶åå†åœ¨Actioné‡Œé¢é€‰æ‹©<code>Debug Command</code>ï¼Œè¿™å’Œå…è®¸æˆ‘ä»¬ç›´æ¥ä½¿ç”¨<code>lldb</code>æˆ–è€…<code>gdb</code>çš„å‘½ä»¤è¿›è¡Œè°ƒè¯•ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨<code>po idx</code>æ‰“å°å‡ºidxçš„å€¼ï¼Œè¡¨ç¤ºå½“æ»¡è¶³å¶æ•°æ¡ä»¶çš„æ—¶å€™æ‰“å°ã€‚æ¥ä¸‹æ¥æœ€é‡è¦çš„å°±æ˜¯å‹¾é€‰ä¸‹é¢é‚£ä¸ª<code>Automatically continue after evaluating</code>é€‰é¡¹ï¼Œè¡¨ç¤ºåœ¨æ‰§è¡ŒåŠ¨ä½œä¹‹åä¸æš‚åœç¨‹åºç»§ç»­è¿è¡Œã€‚</p>
<p><img src="/images/debug_3.png" alt="debug_3"></p>
<p>å¯ä»¥çœ‹åˆ°ï¼ŒXcodeä¹–ä¹–åœ°æ‰“å°é™¤äº†0åˆ°10000çš„å¶æ•°ã€‚</p>
<p>å‡å¦‚æˆ‘ä»¬éœ€è¦è¾“å‡ºä¸€äº›ä¿¡æ¯ï¼Œä¹Ÿå¥½åŠï¼Œç‚¹å‡»Actionå³è¾¹çš„åŠ å·ï¼Œæ·»åŠ åŠ¨ä½œï¼Œè¿™æ¬¡æˆ‘ä»¬é€‰æ‹©<code>Log Message</code>ï¼Œè¿™é‡Œå¯ä»¥å†™ä¸‹æˆ‘ä»¬éœ€è¦è¾“å‡ºçš„ä¿¡æ¯ï¼Œå¯ä»¥é€‰æ‹©åœ¨æ§åˆ¶å°è¾“å‡ºæˆ–è€…è¯­éŸ³æ’­æ”¾ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥å†æ·»åŠ ä¸€ä¸ªåŠ¨ä½œï¼Œé€‰æ‹©<code>Sound</code>ï¼Œå†…ç½®ä¸°å¯Œçš„å£°éŸ³ï¼Œåœ¨æ‚¨è°ƒè¯•çš„æ—¶å€™ä¹Ÿèƒ½å¤Ÿäº«å—ç¾å¦™çš„äº¤å“ä¹ã€‚</p>
<p><img src="/images/debug_4.png" alt="debug_4"></p>
<p>æŸ¥çœ‹è¾“å‡ºï¼ŒåŒæ—¶ä¼´æœ‰frogçš„å«å£°</p>
<p><img src="/images/debug_5.png" alt="debug_5"> </p>
<h4 id="é«˜çº§logæœ¯çš„å…¶ä»–ç”¨é€”">é«˜çº§logæœ¯çš„å…¶ä»–ç”¨é€”</h4><p>å¹³æ—¶æˆ‘ä»¬æŸ¥çœ‹è°ƒç”¨å †æ ˆçš„æ—¶å€™éƒ½æ˜¯æ‰“ä¸ªæ–­ç‚¹ç„¶ååœ¨Xcodeå·¦ä¾§çš„Debugæ æŸ¥çœ‹ï¼Œæˆ–è€…åœ¨å‘½ä»¤è¡Œè¾“å…¥lldbå‘½ä»¤<code>bt</code>ï¼Œä½†æ˜¯æœ‰æ—¶å€™æˆ‘ä»¬ä¸æƒ³è¦ç¨‹åºæš‚åœï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨æ¡ä»¶æ–­ç‚¹çš„<code>Automatically continue after evaluating</code>ï¼ŒåŒæ ·ï¼Œåœ¨Actioné‡Œé€‰æ‹©<code>Debug Command</code>ï¼Œç„¶åè¾“å…¥<code>bt</code>æˆ–è€…<code>bt 10</code>ï¼Œè¡¨ç¤ºåªè¾“å‡º10ä¸ªframeçš„è°ƒç”¨å †æ ˆã€‚</p>
<p><img src="/images/debug_6.png" alt="debug_6"></p>
<p><code>-viewWillAppear:</code>çš„è°ƒç”¨å †æ ˆå¦‚ä¸‹ï¼ˆåªè¾“å‡ºäº†10ä¸ªframeï¼‰</p>
<p><img src="/images/debug_7.png" alt="debug_7"></p>
<p>ä¹Ÿå¯ä»¥ä½¿ç”¨<code>dis -f</code>æ˜¾ç¤ºè¿è¡Œæ—¶çš„åæ±‡ç¼–ä»£ç </p>
<p><img src="/images/debug_8.png" alt="debug_8"></p>
<h4 id="ç¬¦å·æ–­ç‚¹ï¼ˆSymbolic_BreakPointsï¼‰">ç¬¦å·æ–­ç‚¹ï¼ˆSymbolic BreakPointsï¼‰</h4><p><code>Symbolic BreakPoints</code>æˆ‘ä»¬å¯èƒ½ç”¨å¾—æ¯”è¾ƒå°‘ï¼Œä½†å…¶å®å®ƒæ˜¯ä¸ªç¥å™¨ï¼Œç”¨äºæˆ‘ä»¬æƒ³è¦åœ¨æŸä¸ªæ–¹æ³•è§¦å‘çš„æ—¶å€™æ‰“æ–­ç‚¹ï¼Œå°¤å…¶æ˜¯å½“æˆ‘ä»¬ä½¿ç”¨äº†ç¬¬ä¸‰æ–¹åº“æˆ–è€…frameworkç­‰æˆ‘ä»¬æ— æ³•ç›´æ¥åœ¨æ–¹æ³•é‡Œæ‰“æ–­ç‚¹çš„æƒ…å†µã€‚</p>
<p>å¥½äº†ï¼Œå‡å¦‚æˆ‘ä»¬æƒ³è¦åœ¨æ¯ä¸ª<code>-viewDidLoad:</code>æ‰§è¡Œçš„æ—¶å€™ï¼Œæ‰“æ–­ç‚¹ï¼Œè¦æ€ä¹ˆåšå‘¢ï¼Œé¦–å…ˆæˆ‘ä»¬å¾—è§ä¸€ä¸ªç¬¦å·æ–­ç‚¹</p>
<p><img src="/images/debug_9.png" alt="debug_9"></p>
<p>ç„¶ååœ¨<code>Symbol</code>é‡Œå¡«å†™æˆ‘ä»¬è¦è¿½è¸ªçš„æ–¹æ³•ï¼Œè¿™é‡Œå¡«å†™<code>-[UIViewController viewWillAppear:]</code>ã€‚è¿™æ ·ï¼Œå½“æ¯æ¬¡æ‰§è¡Œåˆ°çš„æ—¶å€™ï¼Œéƒ½ä¼šåœä¸‹æ¥ï¼Œä¾¿äºæˆ‘ä»¬åˆ†æè°ƒè¯•ã€‚</p>
<p><img src="/images/debug_10.png" alt="debug_10"></p>
<p>Xcodeåœç•™åœ¨äº†ç¬¬ä¸€ä¸ªæ–­ç‚¹å¤„</p>
<p><img src="/images/debug_11.png" alt="debug_11"></p>
<p>æˆ–è€…ï¼Œæˆ‘ä»¬ç›´æ¥è¾“å…¥<code>viewDidLoad</code>ï¼Œè¿è¡Œï¼Œè§‚å¯ŸXcodeçš„ååº”</p>
<p><img src="/images/debug_12.png" alt="debug_12"></p>
<p>æ‰§è¡Œä¹‹åXcodeæ–­ç‚¹ä¸‹</p>
<p><img src="/images/debug_13.png" alt="debug_13"></p>
<p>ä»ä¸Šå›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼ŒXcodeå°†ç¨‹åºè¿è¡Œæ—¶å€™æ‰€æœ‰ç±»ä¸­æ‰§è¡Œåˆ°è¯¥æ–¹æ³•çš„åœ°æ–¹éƒ½æ ‡è®°äº†æ–­ç‚¹ï¼Œå…¶ä¸­æœ‰å¾ˆå¤šç³»ç»Ÿç±»ï¼Œç­‰äºè‡ªåŠ¨<code>class_dump</code>å‡ºæ¥äº†ã€‚</p>
<h4 id="å…¨å±€æ–­ç‚¹ï¼Œæ•æ‰ç¨‹åºè¿è¡Œæ—¶å€™çš„å…¨éƒ¨å¼‚å¸¸ã€‚">å…¨å±€æ–­ç‚¹ï¼Œæ•æ‰ç¨‹åºè¿è¡Œæ—¶å€™çš„å…¨éƒ¨å¼‚å¸¸ã€‚</h4><p>æ·»åŠ æ–­ç‚¹çš„æ—¶å€™é€‰æ‹©é€‰æ‹©<code>Add Exception Breakpoint</code></p>
<p><img src="/images/debug_14.png" alt="debug_14"></p>
<p>ç„¶ååœ¨ç¼–è¾‘çš„æ—¶å€™æˆ‘ä»¬å¯ä»¥é€‰æ‹©æ•æ‰å…¨éƒ¨æˆ–è€…Objective-Cæˆ–è€…C++çš„å¼‚å¸¸ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬ä¿æŒé»˜è®¤ï¼Œè¿™æ ·å½“å‡ºç°crashçš„æ—¶å€™å°±ä¼šåœç•™åœ¨ç›¸åº”çš„ä»£ç å¤„äº†ã€‚</p>
<p><img src="/images/debug_15.png" alt="debug_15"></p>
<p>å¼€å‘ç¨‹åºæ—¶ï¼Œå·§å¦™åœ°åˆ©ç”¨Xcodeå¼ºå¤§çš„è°ƒè¯•æŠ€å·§ï¼Œå¯ä»¥è¾¾åˆ°äº‹åŠåŠŸå€çš„æ•ˆæœã€‚</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>æˆ‘ä»¬å¼€å‘iOSæˆ–è€…OSXç¨‹åºæ—¶å€™ï¼Œè°ƒè¯•æ˜¯é¿å…ä¸äº†çš„ï¼Œè€Œè°ƒè¯•æœ€å¤§çš„ä¸€ä¸ªåˆ©å™¨å°±æ˜¯æ–­ç‚¹ã€‚æ¥ä¸‹æ¥æˆ‘ä»‹ç»ä¸€ä¸‹Xcodeä¸€äº›å¸¸ç”¨çš„å’Œä¸å¸¸ç”¨çš„æŠ€å·§ã€‚</p>
<h4 id="æ¡ä»¶æ–­ç‚¹">æ¡ä»¶æ–­ç‚¹</h4><p>å¦‚ä¸‹å›¾ï¼Œè¿™æ˜¯ä¸ªæœ€åŸºæœ¬çš„æ–­ç‚¹ï¼Œæˆ‘ä»¬å†™äº†ä¸€ä¸ª0åˆ°10000çš„å¾ªç¯ï¼Œéœ€è¦åœ¨å¾ªç¯åˆ°50]]>
    </summary>
    
  </entry>
  
  <entry>
    <title><![CDATA[ARCä¸MRCå¿…çŸ¥å¿…ä¼š]]></title>
    <link href="http://yoursite.com/2016/01/26/ARC%E4%B8%8EMRC%E5%BF%85%E7%9F%A5%E5%BF%85%E4%BC%9A/"/>
    <id>http://yoursite.com/2016/01/26/ARCä¸MRCå¿…çŸ¥å¿…ä¼š/</id>
    <published>2016-01-25T16:00:00.000Z</published>
    <updated>2016-01-30T05:56:25.000Z</updated>
    <content type="html"><![CDATA[<p>æˆ‘ä»¬ä¹ æƒ¯å°†ARCçš„æ¯ä¸ªå­—æ¯åˆ†å¼€è¯»å³è¯»A R Cï¼Œä½†æ˜¯å®é™…ä¸Šæ­£å¼çš„å«æ³•å«<code>É‘:k</code>ï¼Œå³å•Šå…‹ã€‚å¥½äº†ï¼Œä¸‹é¢å¼€å§‹è¿›å…¥æ­£é¢˜ï¼Œè°ˆè°ˆARCä¸MRCæœ‰ä»€ä¹ˆä¸åŒã€‚</p>
<h4 id="ARCä¸‹çš„autorelease_pool">ARCä¸‹çš„autorelease pool</h4><p>ARCä¸‹æœ€æ˜æ˜¾çš„å°±æ˜¯å¯¹autorelease poolçš„æ”¹è¿›ã€‚</p>
<p>Autorelease poolä¼šè‡ªåŠ¨ç®¡ç†å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œæ¯ä¸ªå‘é€<code>autorelease</code>æ¶ˆæ¯çš„å¯¹è±¡ä¸ä¼šé©¬ä¸Šè¢«é‡Šæ”¾ï¼Œå®ƒä»¬ä¼šè¢«åŠ å…¥åˆ°NSAutoreleasePoolä¸­ï¼Œå½“poolè¢«drainçš„æ—¶å€™ï¼Œå®ƒä¼šä¾æ¬¡ç»™æ± å­ä¸­çš„æ¯ä¸ªå¯¹è±¡å‘é€<code>release</code>æ¶ˆæ¯ã€‚å› æ­¤ï¼Œä½¿ç”¨autoreleaseç®¡ç†å†…å­˜çš„å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸè¢«å»¶é•¿äº†ã€‚</p>
<p>MRCä¸‹mainå‡½æ•°æ˜¯è¿™ä¹ˆå†™çš„</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSAutoreleasePool</span> *pool = [[<span class="built_in">NSAutoreleasePool</span> alloc] init];</span><br><span class="line">    <span class="keyword">int</span> retVal = <span class="built_in">UIApplicationMain</span>(argc, argv, <span class="literal">nil</span>, <span class="literal">nil</span>);</span><br><span class="line">    [pool release];</span><br><span class="line">    <span class="keyword">return</span> retVal;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ARCä¸‹ï¼Œæˆ‘ä»¬ä¸éœ€è¦ç›´æ¥ç®¡ç†autorelease pooläº†ï¼Œä½¿ç”¨@autoreleaseå³å¯ï¼Œå¹¶ä¸”æ¯”NSAutoreleasePoolæ›´é«˜æ•ˆã€‚</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">UIApplicationMain</span>(argc, argv, <span class="literal">nil</span>, <span class="built_in">NSStringFromClass</span>([AppDelegate class]));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é‚£ä¹ˆ@autoreleasepoolåˆ°åº•å¹²å•¥äº†å‘¢ï¼Œæ–‡æ¡£ä¸Šæ˜¯è¿™æ ·è¯´çš„</p>
<blockquote>
<p> On entry, an autorelease pool is pushed. On normal exit (break, return, goto, fall-through, and so on) the autorelease pool is popped</p>
</blockquote>
<p>æ„æ€æ˜¯è¯´åœ¨@autoreleasepoolå…¥å£å¤„ï¼Œä¸€ä¸ªautorelease poolä¼šè¢«pushè¿›å»ï¼Œå‡ºå£å¤„ä¼šè¢«popå‡ºæ¥ã€‚å®é™…ä¸Šé€šè¿‡æ–­ç‚¹æŸ¥çœ‹åæ±‡ç¼–ä»£ç å¯ä»¥å‘ç°ï¼Œæ‰€è°“çš„pushæ˜¯è°ƒç”¨äº†<code>objc_autoreleasePoolPush</code>ï¼Œpopæ˜¯è°ƒç”¨äº†<code>objc_autoreleasePoolPop</code>ã€‚</p>
<h4 id="ARCä¸‹å¯¹è±¡çš„åˆ›å»ºå’Œä½¿ç”¨">ARCä¸‹å¯¹è±¡çš„åˆ›å»ºå’Œä½¿ç”¨</h4><p>MRCä¸‹ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå¯¹è±¡å¹¶ä¸”ä½¿ç”¨å®Œçš„æ—¶å€™ï¼Œå¿…é¡»é‡Šæ”¾å®ƒã€‚ä»¥æ•°ç»„ä¸ºä¾‹</p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NSArray *<span class="built_in">array</span> = [[NSArray alloc] initWithObjects:<span class="literal">nil</span> <span class="built_in">count</span>:<span class="number">0</span>];</span><br><span class="line"><span class="comment">// do something</span></span><br><span class="line">[<span class="built_in">array</span> release];   <span class="comment">// ä½¿ç”¨å®Œäº†ï¼Œé‡Šæ”¾</span></span><br></pre></td></tr></table></figure>
<p>æˆ–è€…ç›´æ¥ä½¿ç”¨<code>+array</code>æ–¹æ³•</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NSArray *<span class="built_in">array</span> = [NSArray <span class="built_in">array</span>];</span><br></pre></td></tr></table></figure>
<p>å› ä¸ºè¿™é‡Œ<code>Foundation</code>å†…éƒ¨å·²ç»ä¸ºæˆ‘ä»¬çš„<code>+array</code>æ–¹æ³•è‡ªåŠ¨æ·»åŠ äº†autoreleaseï¼Œå³å†…éƒ¨å¯èƒ½æ˜¯è¿™æ ·å®ç°çš„</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">+ (instancetype)<span class="built_in">array</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> [[[self alloc] initWithObjects:<span class="literal">NULL</span> count:<span class="number">0</span>] autorelease];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä»–è¯¸å¦‚<code>NSDictionary</code>çš„<code>+dictionary</code>æˆ–è€…<code>NSString</code>çš„<code>+stringWithFormat:</code>ä¹Ÿæ˜¯ç±»ä¼¼ã€‚</p>
<p>ARCä¸‹æˆ‘ä»¬åªç®¡ä½¿ç”¨å°±å¥½äº†ï¼Œä¸ç®¡ä½¿ç”¨allocè¿˜æ˜¯ç±»æ–¹æ³•ï¼Œä¸éœ€è¦æ‰‹å†™releaseï¼Œautoreleaseï¼ŒARCä¼šåœ¨åˆé€‚çš„åœ°æ–¹è‡ªåŠ¨æ’ä¸Šã€‚</p>
<p>åŒç†ï¼ŒARCä¸‹æˆ‘ä»¬å·²ç»ä¹ æƒ¯çš„åˆå§‹åŒ–èµ‹å€¼æ–¹æ³•</p>
<figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">self.array = <span class="comment">[<span class="comment">[NSArray alloc]</span> init]</span>;</span><br></pre></td></tr></table></figure>
<p>å®é™…ä¸ŠARCéšå¼è½¬åŒ–ä¸º</p>
<figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">self.array = <span class="comment">[<span class="comment">[<span class="comment">[NSArray alloc]</span> init]</span> autorelease]</span>;</span><br></pre></td></tr></table></figure>
<p>æˆ–è€…</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NSArray *tempArray = [[NSArray alloc] init]<span class="comment">;</span></span><br><span class="line">self.array = tempArray<span class="comment">;</span></span><br><span class="line">[tempArray release]<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<h4 id="ARCä¸‹çš„å±æ€§ä¿®é¥°ç¬¦">ARCä¸‹çš„å±æ€§ä¿®é¥°ç¬¦</h4><p>ARCæ–°å¢äº†å‡ ä¸ªå±æ€§ä¿®é¥°ç¬¦</p>
<ul>
<li><p><code>__strong</code></p>
<p>  ARCä¸‹ï¼Œé»˜è®¤æ‰€æœ‰çš„æ ˆå˜é‡éƒ½æ˜¯strongç±»å‹ï¼Œè¿™ä¸ªå±æ€§å’Œretainä¸€æ ·ï¼Œå¹¶ä¸”å‡å¦‚æˆ‘ä»¬æ²¡æœ‰ä¸ºå…¶èµ‹å€¼ï¼Œä¼šè‡ªåŠ¨åˆå§‹åŒ–ä¸ºnilã€‚</p>
<p>  <code>NSString *name;</code><br>  å®é™…ä¸Šå®ƒç­‰äºæ‹¥æœ‰äº†ä»¥ä¸‹å±æ€§<br>  <code>__strong NSString *name = nil;</code></p>
</li>
<li><p><code>__weak</code></p>
<p>  ä¸ä¼šå¢åŠ å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼Œå½“æŒ‡å‘çš„å¯¹è±¡è¢«é‡Šæ”¾æ—¶ï¼Œè‡ªåŠ¨ç½®ä¸ºnilã€‚ARCä¸‹æ›¿ä»£MRCä¸‹delegateçš„assignæ–¹æ³•ï¼Œæ—¢å¯ä»¥æ‰“ç ´å¾ªç¯å¼•ç”¨åˆå¯ä»¥é¿å…é‡æŒ‡é’ˆé€ æˆçš„crashã€‚</p>
</li>
<li><p><code>__unsafe_unretained</code></p>
<p>  å­—é¢æ„æ€unretainedè¡¨ç¤ºä¸ä¼šå¢åŠ å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼Œunsafeè¡¨ç¤ºå½“æŒ‡å‘çš„å¯¹è±¡è¢«é‡Šæ”¾æ—¶ï¼Œè¯¥æŒ‡é’ˆå°±æˆä¸ºé‡æŒ‡é’ˆäº†ï¼Œå› æ­¤æ˜¯ä¸å®‰å…¨çš„ã€‚</p>
</li>
<li><p><code>__autoreleasing</code></p>
<p>  ç±»ä¼¼@autoreleaseï¼Œè¢«ä¿®é¥°çš„å¯¹è±¡è¢«è®¾ç½®ä¸ºè‡ªåŠ¨é‡Šæ”¾ï¼Œä¸€èˆ¬è¢«ç”¨äºå‚æ•°ä¼ é€’ï¼Œæ¯”å¦‚</p>
  <figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="typename">void</span>)<span class="string">save:</span>(NSError * __autoreleasing *)error</span><br><span class="line">&#123;</span><br><span class="line">    *error = [[NSError alloc] <span class="string">initWithDomain:</span>@<span class="string">"123"</span> <span class="string">code:</span><span class="number">0</span> <span class="string">userInfo:</span>nil];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  è¿™æ ·æˆ‘ä»¬å°±ä¸éœ€è¦ç®¡ç†errorçš„å†…å­˜äº†ï¼Œå› ä¸ºå·²ç»è¢«è®¾ç½®æˆè‡ªåŠ¨é‡Šæ”¾ï¼Œç›¸å½“äºå¦‚ä¸‹ä»£ç ï¼Œå¦åˆ™ä¼šé€ æˆå†…å­˜æ³„éœ²ã€‚</p>
  <figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*error = [[[NSError alloc] <span class="string">initWithDomain:</span>@<span class="string">"123"</span> <span class="string">code:</span><span class="number">0</span> <span class="string">userInfo:</span>nil] autorelease];</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="ARCä¸‹å­˜å–å™¨@property">ARCä¸‹å­˜å–å™¨@property</h4><p>å…ˆçœ‹çœ‹MRCä¸‹æˆ‘ä»¬æ‰‹å†™å­˜å–å™¨çš„ä¾‹å­</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">MyClass</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, retain) <span class="built_in">NSNumber</span> *count;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">MyClass</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSNumber</span> *)count &#123;</span><br><span class="line">    <span class="keyword">return</span> _count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setCount:(<span class="built_in">NSNumber</span> *)newCount &#123;</span><br><span class="line">    <span class="keyword">if</span> (_count != newCount) &#123;</span><br><span class="line">        _count = [newCount retain];</span><br><span class="line">        [_count release];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œgetteræ–¹æ³•æ²¡æœ‰å˜åŒ–ï¼Œä»…ä»…æ˜¯è¿”å›å˜é‡çš„å€¼ï¼›setteræ–¹æ³•åšäº†ä¸¤ä»¶äº‹ï¼š</p>
<ul>
<li><p>retainæ–°å€¼<br>retainæ–°å€¼æ˜¯å› ä¸ºæˆ‘ä»¬æ— æ³•çŸ¥é“æ–°çš„å€¼åœ¨ä»€ä¹ˆæ—¶å€™è¢«é‡Šæ”¾ï¼Œæˆ‘ä»¬å¿…é¡»ç¡®ä¿åœ¨ä½¿ç”¨çš„æ—¶å€™å®ƒæ²¡æœ‰è¢«é‡Šæ”¾ï¼Œå› æ­¤æˆ‘ä»¬å¿…é¡»æŒæœ‰å®ƒã€‚</p>
</li>
<li><p>é‡Šæ”¾æ—§å€¼<br>é‡Šæ”¾æ—§å€¼æ˜¯å› ä¸ºå¦‚æœä¸é‡Šæ”¾ï¼Œæ—§å€¼å°±ä¼šå¤±å»å¯¹è±¡å¯¹å®ƒçš„å¼•ç”¨ï¼Œæˆ‘ä»¬å°±å†ä¹Ÿæ— æ³•è®¿é—®åˆ°æ—§å€¼äº†ï¼Œå› æ­¤ä¹Ÿå°±æ— æ³•é‡Šæ”¾å®ƒï¼Œæœ€ç»ˆå¯¼è‡´å†…å­˜æ³„éœ²ã€‚</p>
</li>
</ul>
<p>æ³¨æ„é‚£ä¸ªåˆ¤æ–­æ˜¯å› ä¸ºï¼Œå‡å¦‚æ–°å€¼å’Œæ—§å€¼æ˜¯åŒä¸€å¯¹è±¡ï¼Œå°±ä¼šå¯¼è‡´è‡ªå·±retainè‡ªå·±ã€‚</p>
<p>ARCä¸‹ï¼Œå¾ˆç®€å•ï¼Œç›´æ¥æŒ‰ç…§é€»è¾‘æ¥å†™ï¼Œä¸ç”¨ç®¡å¤æ‚çš„æ–°å€¼æ—§å€¼äº†</p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-<span class="ruby"> (<span class="constant">NSNumber</span> *)count &#123;</span><br><span class="line"></span>    return _count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-<span class="ruby"> (void)<span class="symbol">setCount:</span>(<span class="constant">NSNumber</span> *)newCount &#123;</span><br><span class="line"></span>    _count = newCount;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ARCä¸‹å‡½æ•°è¿”å›å€¼">ARCä¸‹å‡½æ•°è¿”å›å€¼</h4><p>MRCçš„æ—¶å€™ï¼Œå¯¹è±¡åœ¨å‡½æ•°å†…éƒ¨åˆ›å»ºå¹¶è¿”å›çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¿…é¡»è¦æ”¾å¼ƒå¯¹å…¶çš„æ‰€æœ‰æƒã€‚ä½†æ˜¯å¦‚æœæˆ‘ä»¬ç›´æ¥ä½¿ç”¨releaseï¼Œå¯¹è±¡ä¼šåœ¨è¿”å›çš„æ—¶å€™ç«‹å³è¢«é‡Šæ”¾ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±å¿…é¡»ä½¿ç”¨autoreleaseå»¶è¿Ÿçš„å®ƒçš„é‡Šæ”¾æ—¶æœºï¼Œè¿™æ ·ï¼Œè°ƒç”¨è€…ä»æ—§å¯ä»¥ä½¿ç”¨è¿”å›çš„å¯¹è±¡ï¼Œå¹¶ä¸”ä½¿ç”¨å®Œä¹‹åä¼šè¢«å®‰å…¨çš„é‡Šæ”¾è€Œä¸ä¼šå†…å­˜æ³„éœ²</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSString</span> *)fullName &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *string = [[[<span class="built_in">NSString</span> alloc] initWithFormat:<span class="string">@"%@ %@"</span>, <span class="keyword">self</span><span class="variable">.firstName</span>, <span class="keyword">self</span><span class="variable">.lastName</span>] autorelease];	</span><br><span class="line">    <span class="comment">// æ²¡æœ‰autoreleaseå°±ä¼šå¯¼è‡´å†…å­˜æ³„éœ²ï¼Œå› ä¸ºè°ƒç”¨è€…ä½¿ç”¨å®Œä¹‹åå¾—ä¸åˆ°é‡Šæ”¾</span></span><br><span class="line">    <span class="keyword">return</span> string;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ–è€…ä¹Ÿå¯ä»¥</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSString</span> *)fullName &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *string = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@ %@"</span>,</span><br><span class="line">                                 <span class="keyword">self</span><span class="variable">.firstName</span>, <span class="keyword">self</span><span class="variable">.lastName</span>];</span><br><span class="line">    <span class="keyword">return</span> string;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å› ä¸º<code>+stringWithFormat</code>å†…éƒ¨è‡ªåŠ¨autoreleaseï¼Œæˆ‘ä»¬å·²ç»ä¸å†æ‹¥æœ‰å¯¹stringçš„æ‰€æœ‰æƒï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å®‰å…¨çš„è¿”å›ã€‚</p>
<p>ä½†æ˜¯åˆ°äº†ARCï¼Œæˆ‘ä»¬å¯ä»¥ä¸ç”¨åœ¨å†™autoreleaseï¼Œåªéœ€åˆ›å»ºå¥½ä¹‹åç›´æ¥è¿”å›ï¼ŒARCåœ¨ç¼–è¯‘çš„æ—¶å€™ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬åŠ ä¸Šã€‚</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSString</span> *)fullName &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *string = [[<span class="built_in">NSString</span> alloc] initWithFormat:<span class="string">@"%@ %@"</span>, <span class="keyword">self</span><span class="variable">.firstName</span>, <span class="keyword">self</span><span class="variable">.lastName</span>];	</span><br><span class="line">    <span class="comment">// ARCä¸‹ç›´æ¥è¿”å›å°±å¥½äº†</span></span><br><span class="line">    <span class="keyword">return</span> string;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ARCä¸‹çš„block">ARCä¸‹çš„block</h4><p>ARCå’ŒMRC blockçš„ç±»å‹è¿˜æ˜¯æœ‰æ‰€åŒºåˆ«çš„ã€‚</p>
<p>ARCä¸‹åˆ›å»ºçš„blockï¼Œå’Œå…¶ä»–å¯¹è±¡ä¸€æ ·ï¼Œé»˜è®¤æ˜¯<code>strong</code>ç±»å‹ã€‚å½“<code>__NSStackBlock__</code>ç±»å‹çš„blockä½¿ç”¨å¤–éƒ¨å˜é‡æ—¶ï¼Œè¿™ä¸ªblockä¼šè¢«copyè¿›å †ä¸­ï¼Œå°±æˆä¸ºäº†<code>__NSMallocBlock__</code>ï¼ˆæœ‰ä¸ªä¾‹å¤–ï¼Œç›´æ¥åœ¨å‚æ•°ä¸­ä¼ é€’çš„blockï¼‰ï¼›å¦‚æœæ²¡æœ‰ä½¿ç”¨å¤–éƒ¨å˜é‡ï¼Œåˆ™æ˜¯<code>__NSGlobalBlock__</code>ã€‚é‚£ä¹ˆæœ‰æ²¡æœ‰åŠæ³•ä½¿å®ƒæˆä¸º<code>__NSStackBlock__</code>å‘¢ï¼Œå¯ä»¥æ˜¾å¼å£°æ˜blockä¸º<code>weak</code>ã€‚</p>
<p>MRC</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MRCä¸‹ï¼Œæ˜¯__NSStackBlock__</span></span><br><span class="line"><span class="keyword">void</span> (^myBlock)(<span class="keyword">int</span> i) = ^(<span class="keyword">int</span> i) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"self = %@"</span>, <span class="keyword">self</span>);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"myBlock : %@"</span>, myBlock);</span><br></pre></td></tr></table></figure>
<p>ARC</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ARCä¸‹ï¼Œå´æ˜¯__NSMallocBlock__</span></span><br><span class="line"><span class="keyword">void</span> (^myBlock)(<span class="keyword">int</span> i) = ^(<span class="keyword">int</span> i) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"self = %@"</span>, <span class="keyword">self</span>);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"myBlock : %@"</span>, myBlock);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å£°æ˜ä¸ºweakç±»å‹ï¼Œå˜å›__NSStackBlock__</span></span><br><span class="line">__<span class="keyword">weak</span> <span class="keyword">void</span> (^myBlock)(<span class="keyword">int</span> i) = ^(<span class="keyword">int</span> i) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"self = %@"</span>, <span class="keyword">self</span>);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"myBlock : %@"</span>, myBlock);</span><br></pre></td></tr></table></figure>
<p>ä¾‹å¤–ï¼ŒARCä¸‹ï¼Œå¦‚æœä½¿ç”¨äº†å¤–éƒ¨å˜é‡çš„blockç›´æ¥ä½œä¸ºå‡½æ•°å‚æ•°ï¼Œè¿™ä¸ªæ—¶å€™è¿˜æ˜¯<code>__NSStackBlock__</code></p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="list">[<span class="keyword">self</span> performBlock:^&#123;</span><br><span class="line">    NSLog<span class="list">(<span class="keyword">@</span><span class="string">"self = %@"</span>, self)</span><span class="comment">;</span></span><br><span class="line">&#125;]<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">- <span class="list">(<span class="keyword">void</span>)</span>performBlock:<span class="list">(<span class="keyword">void</span> <span class="list">(<span class="keyword">^</span>)</span><span class="list">()</span>)</span>block</span><br><span class="line">&#123;</span><br><span class="line">    // è¿™ä¸ªblockæ˜¯æ ˆblock</span><br><span class="line">    NSLog<span class="list">(<span class="keyword">@</span><span class="string">"block: %@"</span>, block)</span><span class="comment">;</span></span><br><span class="line">&#125;</span></span><br></pre></td></tr></table></figure>
<p>è®¨è®ºå®ŒARCå’ŒMRCä¸‹blockçš„ç±»å‹ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹çœ‹ARCä¸­æœ‰å“ªäº›éœ€è¦æ³¨æ„çš„åœ°æ–¹ä»¥åŠå’ŒMRCç›¸æ¯”ARCä¸ºæˆ‘ä»¬æ‰€åšçš„å·¥ä½œã€‚</p>
<h5 id="å…ˆçœ‹å‡½æ•°è¿”å›å€¼ä¸ºblockçš„æƒ…å†µã€‚">å…ˆçœ‹å‡½æ•°è¿”å›å€¼ä¸ºblockçš„æƒ…å†µã€‚</h5><p>  MRCä¸‹ï¼Œcopyæ˜¯å› ä¸ºè¿™é‡Œåˆ›å»ºçš„blockæ˜¯ä¸ª<code>__NSStackBlock__</code>ï¼ˆå› ä¸ºå®ƒä½¿ç”¨äº†å¤–éƒ¨å˜é‡<code>i</code>ï¼‰ï¼Œä¸copyçš„è¯å½“å‡½æ•°è¿”å›æ—¶å®ƒå°±è¢«é‡Šæ”¾äº†ï¼Œå› æ­¤å¿…é¡»å°†å®ƒcopyåˆ°å †ä¸Šï¼Œä¹Ÿå°±æ˜¯æˆä¸º<code>__NSMallocBlock__</code>ã€‚å®é™…ä¸Šå¦‚æœæˆ‘ä»¬åˆ›å»ºçš„æ˜¯<strong>NSGlobalBlock</strong>ï¼Œè¿™é‡Œæ˜¯å¯ä»¥ä¸ç”¨copyçš„ï¼Œä½†æ˜¯copyæ€»æ˜¯æ­£ç¡®çš„ï¼›autoreleaseçš„åŸå› å’Œå‰é¢ä¸€æ ·ï¼Œè¿”å›å¯¹è±¡ä¹‹åæˆ‘ä»¬å¿…é¡»æ”¾å¼ƒå¯¹å…¶æ‰€æœ‰æƒï¼Œè¿™æ ·æ‰ä¼šè¢«å®‰å…¨é‡Šæ”¾ã€‚</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>(^)())getBlock:(<span class="keyword">int</span>)i &#123;</span><br><span class="line">    <span class="keyword">void</span> (^block)() = ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"a = %@"</span>,  @(i));</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"dd"</span>);</span><br><span class="line">    <span class="keyword">return</span> [[block <span class="keyword">copy</span>] autorelease];</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ARCä¸‹ä¼šè‡ªåŠ¨å°†è¿”å›çš„æ ˆblock copyå’Œautoreleaseï¼Œæˆ‘ä»¬ä¸éœ€è¦æ‰‹åŠ¨ä¹¦å†™ã€‚å®é™…ä¸Šè¿™ä¸ªblockåœ¨ARCä¸‹æ˜¯<code>__NSMallocBlock__</code>ï¼Œå®éªŒç»“æœæ¥çœ‹ARCå¹¶æ²¡æœ‰åšcopyã€‚</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="pp">- <span class="params">(void (^)</span><span class="params">()</span>)getBlock:<span class="params">(int)</span>i &#123;</span><br><span class="line">    // ARCè¿™æ˜¯ä¸ª__NSMallocBlock__</span><br><span class="line">    void <span class="params">(^block)</span><span class="params">()</span> = ^&#123;</span><br><span class="line">        NSLog<span class="params">(@<span class="string">"a = %@"</span>, @(i)</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">    return block;</span><br><span class="line">&#125;</span></span><br></pre></td></tr></table></figure>
<h5 id="å†çœ‹blockä½œä¸ºå‡½æ•°å‚æ•°çš„æƒ…å†µã€‚">å†çœ‹blockä½œä¸ºå‡½æ•°å‚æ•°çš„æƒ…å†µã€‚</h5><p>æˆ‘ä»¬å»ºç«‹äº†ä¸€ä¸ªç±»ï¼Œå¹¶ä¸”å°†myBlockä½œä¸ºæˆå‘˜å˜é‡ï¼Œç„¶ååˆå§‹åŒ–æ–¹æ³•ä¼ å…¥ä¸€ä¸ªblockã€‚</p>
<p>MRCä¸‹ï¼Œæˆ‘ä»¬å¿…é¡»copyæˆ‘ä»¬çš„blockï¼Œè¿™é‡ŒåŸå› å’Œblockä½œä¸ºè¿”å›å€¼ç±»ä¼¼ã€‚å‡å¦‚ä½œä¸ºå‚æ•°ä¼ å…¥çš„blockæ˜¯ä¸ª<code>__NSStackBlock__</code>ï¼Œé‚£ä¹ˆå½“åˆ›å»ºblockçš„å‡½æ•°æ ˆè¿”å›æ—¶ï¼Œè¿™ä¸ªblockå°±ä¼šè¢«é‡Šæ”¾ï¼Œé‚£ä¹ˆå½“æˆ‘ä»¬ä½¿ç”¨çš„æ—¶å€™ï¼Œå°±ä¼šå› ä¸ºä½¿ç”¨äº†å·²ç»é‡Šæ”¾çš„å¯¹è±¡è€Œcrashï¼Œè€Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬ä½¿ç”¨å±æ€§å®šä¹‰blockçš„æ—¶å€™ä½¿ç”¨copyçš„åŸå› ã€‚</p>
<p><em>ä¾‹å­1ï¼š</em></p>
<p>MRC</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">MyClass</span> : <span class="title">NSObject</span> </span>&#123;</span><br><span class="line">    <span class="keyword">void</span> (^myBlock)(<span class="keyword">int</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//@property (nonatomic, copy) void (^myBlock)(int);</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line">- (instancetype)initWithBlock:(<span class="keyword">void</span> (^)(<span class="keyword">int</span>))block 	&#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        myBlock = [block <span class="keyword">copy</span>];</span><br><span class="line"><span class="comment">//        self.myBlock = blk;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)dealloc &#123;</span><br><span class="line">    [myBlock release];</span><br><span class="line"></span><br><span class="line">    [<span class="keyword">super</span> dealloc];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ARCä¸‹ï¼Œæˆ‘ä»¬åªè¦<code>myBlock = block;</code>å°±è¡Œäº†ï¼Œå®ƒä¼šä¸ºæˆ‘ä»¬è‡ªåŠ¨copyã€‚</p>
<p><em>ä¾‹å­2ï¼š</em></p>
<p>æˆ‘ä»¬å¸¸ç”¨çš„<code>-performSelector:withObject:afterDelay:</code>æ–¹æ³•</p>
<p>MRC</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="typename">int</span> var = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">[self <span class="string">performSelector:</span><span class="annotation">@selector</span>(<span class="string">action:</span>) <span class="string">withObject:</span>[[^(<span class="typename">int</span> i) &#123;</span><br><span class="line">    NSLog(@<span class="string">"result = %@"</span>, @(i+var));</span><br><span class="line">&#125; copy] autorelease] <span class="string">afterDelay:</span><span class="number">1.0</span>];</span><br></pre></td></tr></table></figure>
<p>ARC</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="typename">int</span> var = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">[self <span class="string">performSelector:</span><span class="annotation">@selector</span>(<span class="string">action:</span>) <span class="string">withObject:</span>^(<span class="typename">int</span> i) &#123;</span><br><span class="line">    NSLog(@<span class="string">"result = %@"</span>, @(i+var));</span><br><span class="line">&#125; <span class="string">afterDelay:</span><span class="number">1.0</span>];</span><br></pre></td></tr></table></figure>
<h5 id="blockåŠ å…¥æ•°ç»„æˆ–é›†åˆ">blockåŠ å…¥æ•°ç»„æˆ–é›†åˆ</h5><p>MRCä¸‹blockåŠ å…¥æ•°ç»„ï¼ŒcopyåŸå› åŒä¸Šï¼Œå°†æ ˆä¸Šçš„blockå˜æˆå †blockï¼›autoreleaseçš„åŸå› æ˜¯æ•°ç»„ä¼šå¯¹åŠ å…¥å…¶ä¸­çš„å¯¹è±¡retainï¼Œå› æ­¤åœ¨åŠ å…¥ä¹‹åå¿…é¡»è¦é‡Šæ”¾å®ƒ</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[self.muteArray addObject:<span class="string">[[myBlock copy] autorelease]]</span>;</span><br></pre></td></tr></table></figure>
<p>ARCä¸‹ï¼Œç›´æ¥addå°±è¡Œäº†ã€‚</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">[self.muteArray addObject:myBlock]</span><span class="comment">;</span></span><br></pre></td></tr></table></figure>
<h4 id="ARCä¸‹çš„å¾ªç¯å¼•ç”¨é—®é¢˜">ARCä¸‹çš„å¾ªç¯å¼•ç”¨é—®é¢˜</h4><p>ä½¿ç”¨blockçš„æ—¶å€™ï¼Œå½“AæŒæœ‰blockï¼Œè€ŒblockåˆæŒæœ‰Açš„æ—¶å€™ï¼Œå°±ä¼šé€ æˆå¾ªç¯å¼•ç”¨è€Œç›¸äº’æ— æ³•é‡Šæ”¾ã€‚<br>MRCä¸‹æˆ‘ä»¬åªéœ€è¦ä½¿ç”¨<code>__block</code>ä¿®é¥°å¯¹è±¡ï¼Œblockå°±ä¸ä¼šretainå®ƒ</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">__block <span class="keyword">id</span> blockSelf = <span class="keyword">self</span>;</span><br><span class="line"><span class="keyword">self</span><span class="variable">.myBlock</span> = ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"self = %@"</span>, blockSelf);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯åœ¨ARCä¸‹ï¼Œå³ä½¿ä½ çš„å˜é‡ä½¿ç”¨äº†<code>__block</code>ï¼Œä»æ—§ä¼šè¢«retainï¼Œå› æ­¤ä»ç„¶ä¼šå¾ªç¯å¼•ç”¨ï¼Œè¿™ä¸ªæ—¶å€™å°±åº”è¯¥ä½¿ç”¨<code>__weak</code>æˆ–è€…<code>__unsafe_unretained</code>ï¼ˆiOS5ä»¥ä¸‹ï¼‰äº†ï¼Œä½†æ˜¯<code>__unsafe_unretained</code>æ˜¯ä¸å®‰å…¨çš„ï¼Œå› ä¸ºå½“å®ƒæŒ‡å‘çš„å¯¹è±¡è¢«é‡Šæ”¾çš„æ—¶å€™ï¼Œè€Œè¿™ä¸ªæŒ‡é’ˆè¿˜æŒ‡ç€é‚£å—è¢«é‡Šæ”¾çš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯é‡æŒ‡é’ˆï¼Œå°±ä¼šé€ æˆcrashï¼›è€Œ<code>__weak</code>åˆ™ä¼šåœ¨å‘ç”Ÿè¿™ä¸ªæƒ…å†µçš„æ—¶å€™è‡ªåŠ¨å°†æŒ‡é’ˆç½®ä¸ºnilï¼ŒOCé‡Œå¯¹nilå‘æ¶ˆæ¯æ˜¯å¯ä»¥çš„ã€‚</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">__<span class="keyword">weak</span> <span class="keyword">id</span> weakSelf = <span class="keyword">self</span>;</span><br><span class="line"><span class="keyword">self</span><span class="variable">.myBlock</span> = ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"self = %@"</span>, weakSelf);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">__unsafe_unretained <span class="keyword">id</span> blockSelf = <span class="keyword">self</span>;    <span class="comment">// ä¸æ¨è</span></span><br><span class="line"><span class="keyword">self</span><span class="variable">.myBlock</span> = ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"self = %@"</span>, blockSelf);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸‹æ˜¯å‡ ç‚¹éœ€è¦æ³¨æ„çš„å¾ªç¯å¼•ç”¨çš„åœ°æ–¹</p>
<ul>
<li>blockä¸­ä½¿ç”¨äº†å±æ€§å®šä¹‰çš„å˜é‡ï¼Œå¦‚<code>self.xxx</code>ï¼Œblockå°±ä¼šretain selfï¼Œè€Œå¦‚æœselfåˆretainè¯¥blockï¼Œå°±ä¼šé€ æˆå¾ªç¯å¼•ç”¨ï¼Œä¹Ÿæ˜¯æœ€å¸¸è§çš„ç±»å‹ã€‚</li>
<li><p>blockä¸­ä½¿ç”¨äº†ä¸æ˜¯ä½¿ç”¨å±æ€§å®šä¹‰çš„æˆå‘˜å˜é‡ï¼Œé»˜è®¤æ˜¯strongç±»å‹ï¼Œä¹Ÿä¼šè¢«å¼ºå¼•ç”¨ã€‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ä¸€ä¸ªä¸´æ—¶å˜é‡æ¥å­˜å‚¨ã€‚</p>
  <figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">__<span class="keyword">weak</span> <span class="built_in">NSNumber</span> *tempNum = num;</span><br><span class="line"><span class="built_in">NSUInteger</span> tempCount = count;</span><br><span class="line"><span class="keyword">self</span><span class="variable">.myBlock</span> = ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"value = %@"</span>, tempNum);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"value2 = %@"</span>, @(tempCount));</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>delegateçš„å±æ€§ä¿®é¥°ç¬¦è¦ä»assignæ”¹ä¸ºweakï¼Œè¿™æ ·æ—¢å¯ä»¥æ‰“ç ´å¾ªç¯å¼•ç”¨åˆå¯ä»¥é¿å…é‡æŒ‡é’ˆé€ æˆçš„crashã€‚</p>
</li>
</ul>
<p>å½“ç„¶ä¹Ÿå¹¶ä¸æ˜¯ä¸€æœ‰blockæˆ‘ä»¬å°±è¦ä½¿ç”¨å¼±å¼•ç”¨ï¼Œä»¥ä¸‹æ˜¯å‡ ä¸ªä¸éœ€è¦ä½¿ç”¨weakçš„åœ°æ–¹</p>
<ul>
<li><p>å½“blockä¸è¢«è¯¸å¦‚vcä¹‹ç±»çš„æŒæœ‰æ—¶ï¼Œæˆ‘ä»¬ä¸éœ€è¦ä½¿ç”¨weakï¼Œæ¯”å¦‚æˆ‘å®šä¹‰äº†ä¸€ä¸ªå‡½æ•°ä½¿ç”¨blockä½œå‚æ•°ï¼Œä½†æ˜¯è¿™ä¸ªblockä»…ä»…æ˜¯å‚æ•°è€Œæ²¡æœ‰è¢«æˆ‘æŒæœ‰ã€‚</p>
  <figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¼ è¿›å»çš„blockå¹¶æ²¡æœ‰è¢«self retainï¼Œä¸éœ€è¦weakSelf</span></span><br><span class="line">[<span class="keyword">self</span> doSomething:^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"self = %@"</span>, <span class="keyword">self</span>);</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
</li>
<li><p>GCDä¸­ä¸€èˆ¬æƒ…å†µä¸‹ä¸éœ€è¦ä½¿ç”¨weakSelfï¼ŒGCDä¸­blockè™½ç„¶retainäº†å¤–éƒ¨çš„å˜é‡ï¼Œä½†æ˜¯æˆ‘ä»¬å¹¶ä¸æŒæœ‰è¯¥block</p>
</li>
<li>ç³»ç»Ÿçš„ä¸€äº›è¯¸å¦‚åŠ¨ç”»ä¹‹ç±»çš„blockï¼ŒåŸå› åŒä¸Š</li>
</ul>
<h4 id="å…³äºARCä¸‹__blockå’Œ__weakçš„åŒºåˆ«">å…³äºARCä¸‹<code>__block</code>å’Œ<code>__weak</code>çš„åŒºåˆ«</h4><p>ARCä¸‹çš„ä¸€äº›å¼€æºåº“ä¸­æˆ‘ä»¬ç»å¸¸èƒ½çœ‹åˆ°<code>__block</code>å’Œ<code>__weak</code>ä¸€èµ·ä¿®é¥°æŸä¸ªå˜é‡ï¼Œä»–ä»¬ä¸¤ä¸ªå±æ€§å„æœ‰å„çš„ä½œç”¨ï¼Œ<code>__weak</code>æ˜¯ä¸ºäº†é¿å…å¾ªç¯å¼•ç”¨ï¼›<strong>è€Œ<code>__block</code>æ˜¯ä¸ºäº†å¯ä»¥ä¿®æ”¹å¤–éƒ¨çš„å˜é‡ï¼Œä¸æ˜¯é¿å…å¾ªç¯å¼•ç”¨ï¼Œå› ä¸ºARCä¸‹<code>__block</code>ä»ç„¶å¯ä»¥retainå˜é‡</strong>ï¼Œä¸è¦ææ··æ·†äº†ã€‚</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>æˆ‘ä»¬ä¹ æƒ¯å°†ARCçš„æ¯ä¸ªå­—æ¯åˆ†å¼€è¯»å³è¯»A R Cï¼Œä½†æ˜¯å®é™…ä¸Šæ­£å¼çš„å«æ³•å«<code>É‘:k</code>ï¼Œå³å•Šå…‹ã€‚å¥½äº†ï¼Œä¸‹é¢å¼€å§‹è¿›å…¥æ­£é¢˜ï¼Œè°ˆè°ˆARCä¸MRCæœ‰ä»€ä¹ˆä¸åŒã€‚</p>
<h4 id="ARCä¸‹çš„autorelease_pool">ARCä¸‹çš„autorelease p]]>
    </summary>
    
  </entry>
  
  <entry>
    <title><![CDATA[NSOperationå’ŒNSOperationQueue]]></title>
    <link href="http://yoursite.com/2016/01/19/NSOperation%E5%92%8CNSOperationQueue/"/>
    <id>http://yoursite.com/2016/01/19/NSOperationå’ŒNSOperationQueue/</id>
    <published>2016-01-18T16:00:00.000Z</published>
    <updated>2016-02-03T06:49:14.000Z</updated>
    <content type="html"><![CDATA[<h3 id="NSOperation">NSOperation</h3><h3 id="æ¦‚è¿°">æ¦‚è¿°</h3><p><code>NSOperation</code>æ˜¯ä¸€ä¸ªæŠ½è±¡çš„ç±»ï¼ŒåŒ…è£…äº†å¤„ç†å•ä¸ªä»»åŠ¡æ‰€éœ€è¦çš„ä¸€äº›æ•°æ®ï¼Œä»£è¡¨æ‰§è¡Œå•ä¸ªä»»åŠ¡çš„ä¸€ä¸ªç‹¬ç«‹å•å…ƒã€‚ä¸è¿‡å°½ç®¡å®ƒæ˜¯ä¸ªæŠ½è±¡ç±»ï¼Œä½†æ˜¯å®ƒå·²ç»å¸®æˆ‘ä»¬å¤„ç†äº†ç¹æ‚çš„å¤šçº¿ç¨‹é—®é¢˜ï¼Œå¹¶ä¸”å¯ä»¥ç¡®ä¿çº¿ç¨‹å®‰å…¨ï¼Œå› æ­¤æˆ‘ä»¬åœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œå°±å¯ä»¥æ›´ä¸“æ³¨äºè‡ªå·±çš„ä¸šåŠ¡ã€‚</p>
<p>è‹¹æœå·²ç»é»˜è®¤ç»™æˆ‘ä»¬å°è£…å¥½äº†ä¸¤ä¸ªç±»ï¼Œåˆ†åˆ«æ˜¯<code>NSInvocationOperation</code>å’Œ<code>NSBlockOperation</code></p>
<ul>
<li><p><code>NSInvocationBlock</code></p>
<p>  æˆ‘ä»¬å¯ä»¥ä½¿ç”¨NSInvocationOperationæ¥æ‰§è¡Œæˆ‘ä»¬çš„åå°ä»»åŠ¡ï¼Œè€Œä¸éœ€è¦ç»§æ‰¿äºNSOperationï¼Œæˆ‘ä»¬è¦åšçš„å°±æ˜¯é€šè¿‡è°ƒç”¨<code>-initWithTarget:selector:object:</code>ï¼Œç„¶åå®šä¹‰è¦æ‰§è¡Œä»»åŠ¡çš„æ–¹æ³•å³å¯</p>
  <figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NSInvocationOperation *theOp = [[NSInvocationOperation alloc] <span class="string">initWithTarget:</span>self <span class="string">selector:</span><span class="annotation">@selector</span>(<span class="string">myTaskMethod:</span>) <span class="string">object:</span>data];</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>NSBlockOperation</code> </p>
<p>  NSBlockOperationå’ŒNSInvocationOperationç›¸ä¼¼ï¼Œåªæ˜¯æˆ‘ä»¬å¯ä»¥ä½¿ç”¨blockæ›¿ä»£æ–¹æ³•æ‰§è¡Œæˆ‘ä»¬çš„ä»»åŠ¡</p>
  <figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSBlockOperation</span> *theOp = [<span class="built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;</span><br><span class="line">         <span class="built_in">NSLog</span>(<span class="string">@"Beginning operation.\n"</span>);</span><br><span class="line">       &#125;];</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>æˆ‘ä»¬åœ¨blocké‡Œé¢å®šä¹‰æˆ‘ä»¬æƒ³è¦æ‰§è¡Œçš„ä»»åŠ¡ï¼Œä½œä¸ºå‚æ•°ä¼ ç»™å®ƒï¼Œç„¶åå°±ä¼šè‡ªåŠ¨åœ¨åå°çº¿ç¨‹æ‰§è¡Œäº†ã€‚</p>
<p>è¿™ä¸¤ä¸ªç±»ç»§æ‰¿äºNSOperationï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œé‡Œé¢çš„é€»è¾‘æˆ‘ä»¬ä¸éœ€è¦ç®¡ã€‚</p>
<p>å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥ç»§æ‰¿NSOperationå¹¶ä¸”è¦†å†™ä¸€äº›æ–¹æ³•ï¼Œåˆ›å»ºè‡ªå·±çš„operationï¼Œè¿™ä¸ªoperationå¯ä»¥æ˜¯å¹¶å‘ä¹Ÿå¯ä»¥æ˜¯éå¹¶å‘çš„ã€‚å¯¹äºéå¹¶å‘ï¼Œåˆ›å»ºå¥½ä¹‹åï¼Œéœ€è¦æ‰‹åŠ¨è°ƒç”¨<code>start</code>æ–¹æ³•ï¼›å¯¹äºå¹¶å‘çš„operationï¼Œè¿˜éœ€è¦ç”Ÿæˆä¸€ä¸ª<code>NSOperationQueue</code>ï¼Œç„¶ååŠ å…¥é˜Ÿåˆ—ä¸­å³å¯ã€‚</p>
<p>åˆ›å»ºä¸€ä¸ªéå¹¶å‘çš„operationæ¯”è¾ƒç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦è¦†å†™<code>main</code>æ–¹æ³•ï¼Œç„¶åæ‰§è¡Œç®€å•çš„ä»»åŠ¡å¹¶ä¸”å¯¹å–æ¶ˆçŠ¶æ€åšåˆ¤æ–­å°±å¯ä»¥ï¼Œå…¶ä»–å·¥ä½œäº¤ç»™NSOperationè‡ªèº«å°±å¯ä»¥å•¦ã€‚</p>
<p>å¦‚æœè¦åˆ›å»ºä¸€ä¸ªå¹¶å‘çš„operationï¼Œæˆ‘ä»¬å¿…é¡»è¦†å†™ä¸€äº›å·²ç»å­˜åœ¨çš„æ–¹æ³•ã€‚</p>
<ul>
<li><p><code>start</code>ï¼ˆå¿…é¡»ï¼‰</p>
<p>  æ‰€æœ‰çš„å¹¶å‘çš„operationå¿…é¡»è¦†å†™è¿™ä¸ªæ–¹æ³•ä»¥æ›¿æ¢æ‰é»˜è®¤çš„å®ç°ï¼Œè¿™ä¸ªæ–¹æ³•ä¸­æˆ‘ä»¬è¦åšçš„å°±æ˜¯åšå‡ ä¸ªåˆ¤æ–­ï¼ˆæ¯”å¦‚æ˜¯å¦å·²ç»è¢«å–æ¶ˆæˆ–è€…å·²ç»å®Œæˆï¼‰ï¼Œæ‰§è¡Œä»»åŠ¡æ‰€å¿…é¡»çš„çº¿ç¨‹ç¯å¢ƒï¼Œä»¥ç¡®å®šoperationèƒ½å¤Ÿæ­£ç¡®çš„è¿è¡Œã€‚ </p>
<ul>
<li>è¿™ä¸ªæ–¹æ³•é»˜è®¤æ˜¯åœ¨è°ƒç”¨è€…çš„çº¿ç¨‹ä¸­è°ƒç”¨çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå‡å¦‚ä½ ç›´æ¥è°ƒç”¨<code>NSOperation</code>çš„<code>start</code>æ–¹æ³•ï¼Œ<strong>é‚£ä¹ˆè¿™ä¸ªæ“ä½œä¼šåœ¨ä½ è°ƒç”¨startçš„é‚£ä¸ªçº¿ç¨‹ä¸ŠåŒæ­¥æ‰§è¡Œ</strong>ï¼Œå¹¶ä¸”æ“ä½œä¼šé©¬ä¸Šæ‰§è¡Œã€‚     </li>
<li>ä¸è¦è°ƒç”¨<code>super</code>ã€‚</li>
</ul>
</li>
<li><p><code>main</code>ï¼ˆå¯é€‰ï¼‰<br>  å®ç°startæ–¹æ³•ä¹‹åï¼Œæˆ‘ä»¬æ‰€æœ‰çš„ä»»åŠ¡å¯ä»¥åœ¨starté‡Œé¢å®ç°ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥è¦†å†™è¿™ä¸ªæ–¹æ³•ï¼Œå°†ä¸€éƒ¨åˆ†ç®€å•çš„ä»»åŠ¡æ”¾åœ¨mainä¸­å®ç°ï¼Œæœ‰åˆ©äºä»£ç åˆ†ç¦»ã€‚</p>
<ul>
<li>è¿™ä¸ªæ–¹æ³•ä¸­æˆ‘ä»¬ä¸éœ€è¦æ‰‹åŠ¨åˆ›å»ºautoreleasepoolï¼Œå› ä¸ºNSOperationå·²ç»å¸®æˆ‘ä»¬åšäº†ã€‚</li>
<li>ä¸è¦è°ƒç”¨<code>super</code>ã€‚</li>
</ul>
</li>
<li><p><code>isExecuting</code>ï¼ˆå¿…é¡»ï¼‰</p>
<p>  è¿™ä¸ªå±æ€§è¡¨ç¤ºoperationæ˜¯å¦æ­£åœ¨æ‰§è¡Œï¼Œæ­£åœ¨æ‰§è¡Œåˆ™ä¸º<code>YES</code>å¦åˆ™ä¸º<code>NO</code>ã€‚</p>
</li>
<li><p><code>isFinished</code>ï¼ˆå¿…é¡»ï¼‰</p>
<p>  è¿™ä¸ªå±æ€§è¡¨ç¤ºoperation<strong>æ˜¯å¦å·²ç»å®Œæˆæˆ–è€…å–æ¶ˆ</strong>ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ<code>isFinished</code>ä¸º<code>YES</code>å¹¶ä¸è¡¨ç¤ºè¯¥operationå·²ç»å®Œæˆï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯operationè¢«<code>cancel</code>æ‰äº†ã€‚å‡å¦‚è¯¥operationåœ¨æ“ä½œé˜Ÿåˆ—é‡Œï¼Œé‚£ä¹ˆåªæœ‰ç­‰åˆ°<code>isFinished</code>ä¸º<code>YES</code>çš„æ—¶å€™ï¼Œå®ƒæ‰ä¼šè¢«å‡ºåˆ—ã€‚å› æ­¤ï¼Œè¿™ä¸ªæ˜¯éå¸¸é‡è¦çš„ä¸€ä¸ªçŠ¶æ€ã€‚</p>
</li>
<li><p><code>isConcurrent</code>ï¼ˆå·²å¿½ç•¥ï¼‰    </p>
<p>  è¡¨ç¤ºoperationæ˜¯å¦æ˜¯å¹¶å‘çš„ï¼Œé»˜è®¤å€¼ä¸º<code>NO</code>ã€‚ä¸è¿‡ç°åœ¨å·²ç»è¢«å¿½ç•¥äº†ã€‚</p>
</li>
</ul>
<p>ä»¥ä¸‹æ˜¯è‹¹æœæä¾›çš„ç¤ºä¾‹ä»£ç </p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">MyOperation</span> : <span class="title">NSOperation</span> </span>&#123;</span><br><span class="line">   <span class="built_in">BOOL</span> executing;</span><br><span class="line">   <span class="built_in">BOOL</span> finished;</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">void</span>)completeOperation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">MyOperation</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)init &#123;</span><br><span class="line">   <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">   <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">       executing = <span class="literal">NO</span>;</span><br><span class="line">       finished = <span class="literal">NO</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)start &#123;</span><br><span class="line">    <span class="comment">// Always check for cancellation before launching the task.</span></span><br><span class="line">    <span class="keyword">if</span> ([<span class="keyword">self</span> isCancelled]) &#123;</span><br><span class="line">        <span class="comment">// Must move the operation to the finished state if it is canceled.</span></span><br><span class="line">        [<span class="keyword">self</span> willChangeValueForKey:<span class="string">@"isFinished"</span>];</span><br><span class="line">        finished = <span class="literal">YES</span>;</span><br><span class="line">        [<span class="keyword">self</span> didChangeValueForKey:<span class="string">@"isFinished"</span>];</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// If the operation is not canceled, begin executing the task.</span></span><br><span class="line">    [<span class="keyword">self</span> willChangeValueForKey:<span class="string">@"isExecuting"</span>];</span><br><span class="line">    [<span class="built_in">NSThread</span> detachNewThreadSelector:<span class="keyword">@selector</span>(main) toTarget:<span class="keyword">self</span> withObject:<span class="literal">nil</span>];</span><br><span class="line">    executing = <span class="literal">YES</span>;</span><br><span class="line">    [<span class="keyword">self</span> didChangeValueForKey:<span class="string">@"isExecuting"</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)main &#123;</span><br><span class="line">   <span class="keyword">@try</span> &#123;</span><br><span class="line">       <span class="comment">// Do the main work of the operation here.</span></span><br><span class="line">       [<span class="keyword">self</span> completeOperation];</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">@catch</span>(...) &#123;</span><br><span class="line">       <span class="comment">// Do not rethrow exceptions.</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)completeOperation &#123;</span><br><span class="line">    [<span class="keyword">self</span> willChangeValueForKey:<span class="string">@"isFinished"</span>];</span><br><span class="line">    [<span class="keyword">self</span> willChangeValueForKey:<span class="string">@"isExecuting"</span>];</span><br><span class="line">    executing = <span class="literal">NO</span>;</span><br><span class="line">    finished = <span class="literal">YES</span>;</span><br><span class="line">    [<span class="keyword">self</span> didChangeValueForKey:<span class="string">@"isExecuting"</span>];</span><br><span class="line">    [<span class="keyword">self</span> didChangeValueForKey:<span class="string">@"isFinished"</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)isConcurrent &#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)isExecuting &#123;</span><br><span class="line">  <span class="keyword">return</span> executing;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)isFinished &#123;</span><br><span class="line">  <span class="keyword">return</span> finished;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h3 id="å–æ¶ˆ">å–æ¶ˆ</h3><p>å½“operaitonå¼€å§‹æ‰§è¡Œä¹‹åï¼Œå®ƒä¼šç»§ç»­æ‰§è¡Œä»»åŠ¡ç›´åˆ°å®Œæˆæˆ–è€…æ˜¾å¼åœ°è¢«å–æ¶ˆã€‚å‡å¦‚æˆ‘ä»¬æƒ³è¦å–æ¶ˆä¸€ä¸ªoperationï¼Œå¯ä»¥è°ƒç”¨å®ƒçš„<code>cancel</code>æ–¹æ³•ï¼Œç„¶åé€šè¿‡è§‚å¯Ÿå®ƒçš„<code>isCancelled</code>æ–¹æ³•æ¥åšä¸€äº›åç»­å¤„ç†ã€‚</p>
<ul>
<li><p><code>cancel</code></p>
<p>  è¿™ä¸ªæ–¹æ³•ç”¨äºå–æ¶ˆä¸€ä¸ªoperationï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¦†å†™cancelæ–¹æ³•ï¼ˆè®°å¾—è°ƒç”¨<code>super</code>æ–¹æ³•ï¼‰æ¥åšæˆ‘ä»¬è‡ªå·±çš„ä»»åŠ¡ï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥åœ¨é‡Œé¢å–æ¶ˆç½‘ç»œè¯·æ±‚ï¼Œä½†æ˜¯å½“cancelä¹‹åï¼Œæˆ‘ä»¬éœ€è¦å‘é€åˆé€‚çš„KVOé€šçŸ¥ã€‚    </p>
<p>  å–æ¶ˆoperationä¹‹åçš„è¡Œä¸ºå–å†³äºå®ƒæ˜¯å¦åœ¨æ“ä½œé˜Ÿåˆ—é‡Œï¼š</p>
<ul>
<li>å¯¹äºæ²¡æœ‰åœ¨æ“ä½œé˜Ÿåˆ—é‡Œçš„operationï¼Œå–æ¶ˆä¹‹åä¼šç›´æ¥æ ‡è®°<code>isFinished</code>ä¸º<code>YES</code></li>
<li>å¯¹äºå·²ç»åœ¨æ“ä½œé˜Ÿåˆ—é‡Œçš„operationï¼Œå–æ¶ˆä¹‹åçš„è¡Œä¸ºå–å†³äºæ“ä½œçš„çŠ¶æ€ï¼š<ul>
<li>å‡å¦‚è¿™ä¸ªoperationå·²ç»å®Œæˆäº†ï¼Œé‚£ä¹ˆè¿™ä¸ªæ“ä½œæ²¡æœ‰ä»»ä½•ä½œç”¨ã€‚</li>
<li>å‡å¦‚è¿™ä¸ªoperationå·²ç»åœ¨æ“ä½œé˜Ÿåˆ—ä¸­äº†ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰å¼€å§‹æ‰§è¡Œï¼ˆ<code>start</code>æ–¹æ³•è¿˜æ²¡æœ‰è°ƒç”¨ï¼‰ï¼Œé‚£ä¹ˆå®ƒå°†ä¸ä¼šè¢«æ‰§è¡Œã€‚</li>
<li>å‡å¦‚è¿™ä¸ªoperationåœ¨æ“ä½œé˜Ÿåˆ—ä¸­å¹¶ä¸”å·²ç»å¼€å§‹æ‰§è¡Œäº†ï¼Œå®ƒåªæ˜¯ç®€å•çš„è®¾ç½®<code>isCancelled</code>ä¸º<code>YES</code>ï¼Œå–æ¶ˆå¹¶ä¸ä¼šå¼ºåˆ¶å®ƒé€€å‡ºï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±éœ€è¦é€šè¿‡<code>isCancelld</code>æ–¹æ³•æ¥åˆ¤æ–­æ˜¯å¦çœŸçš„å·²ç»å–æ¶ˆäº†ï¼Œå‡å¦‚å·²ç»æ˜¯å–æ¶ˆçŠ¶æ€äº†ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ ‡è®°è¯¥operationä¸ºå·²å®Œæˆï¼Œé‚£ä¹ˆæ•´ä¸ªoperationçš„çŠ¶æ€å°±å¯ä»¥ç”±<code>isCancelled -&gt; isFinished</code>ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li><p><code>isCancelld</code></p>
<p>  è¿™ä¸ªå±æ€§è¡¨ç¤ºoperationæ˜¯å¦å·²ç»å–æ¶ˆï¼Œæˆ‘ä»¬éœ€è¦ç»å¸¸æ£€æŸ¥è¿™ä¸ªå±æ€§æ˜¯å¦ä¸º<code>YES</code>ï¼Œå› ä¸ºcancelä¸€ä¸ªoprationå¯èƒ½å‘ç”Ÿåœ¨ä»»ä½•æ—¶å€™ï¼Œå³ä½¿åœ¨operationå¼€å§‹æ‰§è¡Œä¹‹å‰ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥</p>
<ul>
<li>åœ¨operationå¼€å§‹ä¹‹å‰ã€‚æ¯”å¦‚åœ¨<code>start</code>æ–¹æ³•é‡Œé¢</li>
<li>åœ¨operationå³å°†æš‚åœçš„æ—¶å€™ã€‚é»˜è®¤çš„NSOperationå¹¶æ²¡æœ‰æä¾›æš‚åœæ“ä½œï¼Œå‡å¦‚æˆ‘ä»¬è‡ªå·±æƒ³è¦å®ç°æš‚åœåŠŸèƒ½ï¼Œé‚£ä¹ˆåœ¨æš‚åœæ“ä½œä¹‹å‰å¯ä»¥æ£€æŸ¥æ˜¯å¦å·²ç»å–æ¶ˆ</li>
<li>åœ¨operationå³å°†å–æ¶ˆçš„æ—¶å€™ã€‚å‡å¦‚æˆ‘ä»¬è¦†å†™äº†<code>cancel</code>æ–¹æ³•ï¼Œé‚£ä¹ˆæœ‰å¿…è¦åœ¨å–æ¶ˆä¹‹å‰æ£€æŸ¥ä¸€ä¸‹æ˜¯å¦å·²ç»è¢«å–æ¶ˆï¼Œè¿™æ ·å°±ä¸ç”¨åšé‡å¤çš„å·¥ä½œäº†ã€‚</li>
</ul>
<p>ç¤ºä¾‹ä»£ç </p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">- (void)main &#123;</span><br><span class="line">    <span class="variable">@try</span> &#123;</span><br><span class="line">        <span class="constant">BOOL </span>isDone = <span class="constant">NO;</span></span><br><span class="line">        <span class="keyword">while</span> (![<span class="keyword">self</span> isCancelled] &amp;&amp; !isDone) &#123;</span><br><span class="line">            <span class="regexp">//</span> <span class="constant">Do </span>some work <span class="keyword">and</span> set isDone to <span class="constant">YES </span><span class="keyword">when</span> finished</span><br><span class="line">        &#125;</span><br><span class="line">     &#125; <span class="variable">@catch</span>(...) &#123;</span><br><span class="line">        <span class="regexp">//</span> <span class="constant">Do </span><span class="keyword">not</span> rethrow exceptions.</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="å®Œæˆ">å®Œæˆ</h4><p>â€¦ å¾…å†™ completionBlock</p>
<h3 id="ä¾èµ–å’Œä¼˜å…ˆçº§">ä¾èµ–å’Œä¼˜å…ˆçº§</h3><p><code>NSOperation</code>æœ‰ä¸¤ä¸ªéå¸¸é‡è¦çš„åŠŸèƒ½ï¼Œé‚£å°±æ˜¯ä¾èµ–ï¼ˆ<strong>dependency</strong>ï¼‰å’Œä¼˜å…ˆçº§ï¼ˆ<strong>priority</strong>ï¼‰äº†</p>
<p><code>NSOperation</code>å…è®¸æˆ‘ä»¬æ·»åŠ æˆ–ç§»é™¤ä¾èµ–ï¼Œå½“æˆ‘ä»¬éœ€è¦ä¸€ä¸ªoperationåœ¨å¦ä¸€ä¸ªoperationå®Œæˆä¹‹åæ‰èƒ½å¼€å§‹çš„æ—¶å€™ï¼Œé‚£ä¹ˆè¿™ä¸ªå±æ€§å°±éå¸¸æœ‰ç”¨ã€‚</p>
<ul>
<li><code>addDependency</code><br>  æ·»åŠ ä¾èµ–</li>
<li><code>removeDependency</code><br>  ç§»é™¤ä¾èµ–</li>
</ul>
<p>ä¾èµ–éœ€è¦çš„ä¸€ä¸ªé‡è¦çŠ¶æ€å°±æ˜¯<code>isReady</code></p>
<ul>
<li><p><code>isReady</code> </p>
<p>  è¿™ä¸ªå±æ€§ç”¨äºæŒ‡ç¤ºoperationæ˜¯å¦å·²ç»å‡†å¤‡å¥½æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¿…é¡»å½“operationçš„<code>isReady</code>ä¸º<code>YES</code>çš„æ—¶å€™ï¼Œoperationæ‰å¯ä»¥æ‰§è¡Œã€‚å‡å¦‚å®ƒæ²¡æœ‰å‡†å¤‡å¥½æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯<code>isReady</code>ä¸º<code>NO</code>ï¼Œä¸€èˆ¬æœ‰ä»¥ä¸‹å‡ ç§æƒ…å†µ</p>
<ul>
<li>åˆå§‹åŒ–å·¥ä½œæœªå®Œæˆ</li>
<li>å®ƒä¾èµ–äº†å…¶ä»–çš„operationï¼Œè€Œä¾èµ–çš„operationå¹¶æ²¡æœ‰å…¨éƒ¨å®Œæˆ</li>
</ul>
</li>
</ul>
<p>è¿™é‡Œéœ€è¦æ³¨æ„</p>
<ul>
<li><strong>ä¾èµ–å¹¶ä¸è¢«é™åˆ¶åœ¨åŒä¸€ä¸ªæ“ä½œé˜Ÿåˆ—</strong>ã€‚å‡å¦‚æ“ä½œAåœ¨é˜Ÿåˆ—Aï¼Œæ“ä½œBåœ¨é˜Ÿåˆ—Bï¼Œé‚£ä¹ˆAå’ŒBè¿˜æ˜¯å¯ä»¥å»ºç«‹ä¾èµ–å…³ç³»çš„ã€‚</li>
<li><strong>ä¸€ä¸ªoperationå¦‚æœè¦å¼€å§‹å¿…é¡»è¦ç­‰åˆ°å®ƒæ‰€ä¾èµ–çš„æ‰€æœ‰operationå…¨éƒ¨å®Œæˆä¹‹åæ‰èƒ½å¼€å§‹</strong>ï¼Œå³ä¾èµ–çš„æ‰€æœ‰operationçš„<code>isFinished</code>ä¸º<code>YES</code>çš„æ—¶å€™ï¼Œé™¤éä½ æ˜¾å¼çš„å–æ¶ˆä¾èµ–ã€‚ </li>
<li>åœ¨å»ºç«‹ä¾èµ–å…³ç³»çš„æ—¶å€™ï¼Œæœ€å¥½ç¡®ä¿æ‰€æœ‰çš„æ“ä½œéƒ½è¿˜æ²¡æœ‰å¼€å§‹ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ<strong>æœ€å¥½åœ¨å®ƒåŠ å…¥æ“ä½œé˜Ÿåˆ—ä¹‹å‰å»ºç«‹ä¾èµ–å…³ç³»</strong>ï¼Œå› ä¸ºå½“operationåŠ å…¥åˆ°æ“ä½œé˜Ÿåˆ—ä¹‹åï¼Œå®ƒå¯èƒ½å¼€å§‹äºä»»ä½•æ—¶å€™ï¼Œè¿™ä¸ªæ—¶å€™å†å»å»ºç«‹ä¾èµ–æˆ–è€…ä¿®æ”¹æ“ä½œæœ¬èº«å¯èƒ½ä¼šå¯¼è‡´æ„æ–™ä¹‹å¤–çš„ç»“æœã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå‡å¦‚Aä¾èµ–Bï¼Œé‚£ä¹ˆå½“å»ºç«‹ä¾èµ–å…³ç³»çš„æ—¶å€™Aå·²ç»å¼€å§‹æ“ä½œè€ŒBå¹¶æ²¡æœ‰ï¼Œé‚£ä¹ˆè¿™ä¸ªä¾èµ–å…³ç³»å°±ä¸æˆç«‹äº†ï¼Œè€Œä½ å¯èƒ½è¿˜åœ¨æ€€ç–‘è‡ªå·±çš„ä¾èµ–ä¸ºä»€ä¹ˆä¸èµ·ä½œç”¨ã€‚</li>
<li>é¿å…å¾ªç¯ä¾èµ–ã€‚</li>
<li>å¦‚æœè¦†å†™äº†ï¼Œè®°å¾—è°ƒç”¨<code>superã€‚</code></li>
</ul>
<p>NSOperationè¿˜å…è®¸æˆ‘ä»¬è®¾ç½®ä¼˜å…ˆçº§ï¼Œ<strong>é€‚ç”¨äºåœ¨ç›¸äº’é—´æ²¡æœ‰ä¾èµ–å…³ç³»çš„operationsä½¿ç”¨</strong>ï¼Œè¡¨ç¤ºoperationåœ¨NSOperationQueueä¸­æ‰§è¡Œçš„ä¼˜å…ˆç¨‹åº¦ï¼Œæˆ‘ä»¬å¯ä»¥è®¾ç½®é˜Ÿåˆ—ä¼˜å…ˆçº§å’Œçº¿ç¨‹ä¼˜å…ˆçº§ã€‚</p>
<ul>
<li><p><code>setQueuePriority:</code><br>  è®¾ç½®é˜Ÿåˆ—ä¼˜å…ˆçº§ï¼Œé˜Ÿåˆ—ä¼˜å…ˆçº§å½±å“åˆ°operationå¼€å§‹æ‰§è¡Œå’Œé€€å‡ºé˜Ÿåˆ—çš„é¡ºåºã€‚æœ‰ä¸‹é¢å‡ ä¸ªå¯é€‰å€¼ï¼Œé»˜è®¤æ˜¯<code>NSOperationQueuePriorityNormal</code></p>
<ul>
<li><code>NSOperationQueuePriorityVeryLow</code></li>
<li><code>NSOperationQueuePriorityLow</code></li>
<li><code>NSOperationQueuePriorityNormal</code></li>
<li><code>NSOperationQueuePriorityHigh</code></li>
<li><code>NSOperationQueuePriorityVeryHigh</code></li>
</ul>
</li>
<li><p><code>setThreadPriority:</code><br>  è®¾ç½®çº¿ç¨‹ä¼˜å…ˆçº§ã€‚ä¸€ä¸ªæµ®ç‚¹å‹å€¼ï¼Œå¯é€‰å€¼åœ¨<code>0.0</code>åˆ°<code>1.0</code>ï¼Œé»˜è®¤ä¸º0.5</p>
</li>
</ul>
<p>NSOperationQueueåœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œåœ¨è°ƒç”¨operationsçš„<code>start</code>ä¹‹å‰ï¼Œä¼šæŸ¥æ‰¾æ‰€æœ‰çš„operationå¹¶æ¯”è¾ƒå®ƒä»¬çš„ä¼˜å…ˆçº§ï¼Œä¼˜å…ˆçº§é«˜çš„æ“ä½œä¼˜å…ˆæ‰§è¡Œï¼ŒåŒçº§çš„æ“ä½œæŒ‰ç…§æäº¤åˆ°é˜Ÿåˆ—çš„é¡ºåºæ‰§è¡Œï¼ˆFIFOï¼‰ã€‚</p>
<p>ä¼˜å…ˆçº§ï¼ˆ<strong>priority</strong>ï¼‰ä¸åŒäºä¾èµ–ï¼Œå®ƒæ˜¯operationæœ¬èº«çš„å±æ€§ï¼Œåªèƒ½åœ¨ç›¸åŒé˜Ÿåˆ—ä¸­æ¯”è¾ƒã€‚æ„æ€å°±æ˜¯è¯´ï¼Œå¦‚æœæœ‰å¤šä¸ªæ“ä½œé˜Ÿåˆ—ï¼Œå…¶ä¸­çš„æ¯ä¸ªæ“ä½œéƒ½æœ‰å®ƒè‡ªå·±çš„ä¼˜å…ˆçº§ï¼Œå®ƒä»¬æ˜¯äº’ä¸å½±å“çš„ï¼Œå› æ­¤åœ¨ä¸åŒé˜Ÿåˆ—ä¸­ä½ä¼˜å…ˆçº§æœ‰å¯èƒ½æ¯”é«˜ä¼˜å…ˆçº§çš„å…ˆæ‰§è¡Œã€‚</p>
<h3 id="KVO">KVO</h3><p>NSOperationæ”¯æŒ<code>KVO</code>ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡<code>KVO</code>è§‚å¯Ÿoperationçš„æ‰§è¡ŒçŠ¶æ€ï¼Œé»˜è®¤æœ‰ä»¥ä¸‹å‡ ä¸ªçŠ¶æ€è§‚å¯Ÿã€‚</p>
<ul>
<li><code>isCancelled</code></li>
<li><code>isConcurrent</code></li>
<li><code>isExecuting</code></li>
<li><code>isFinished</code></li>
<li><code>isReady</code></li>
<li><code>dependencies</code></li>
<li><code>queuePriority</code></li>
<li><code>completionBlock</code></li>
</ul>
<p>æˆ‘ä»¬è¦åšçš„ï¼Œå°±æ˜¯åœ¨åˆé€‚çš„åœ°æ–¹å‘å‡º<code>KVO</code>é€šçŸ¥</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">[self willChangeValueForKey:@"isFinished"]</span><span class="comment">;</span></span><br><span class="line"><span class="setting">finished = <span class="value"><span class="keyword">YES</span>;</span></span></span><br><span class="line"><span class="title">[self didChangeValueForKey:@"isFinished"]</span><span class="comment">;</span></span><br></pre></td></tr></table></figure>
<h3 id="NSOperationQueue">NSOperationQueue</h3><h3 id="æ¦‚è¿°-1">æ¦‚è¿°</h3><p><code>NSOperationQueue</code>æ˜¯ä¸€ä¸ªè´Ÿè´£æ‰§è¡Œoperationsçš„é˜Ÿåˆ—ï¼Œæˆ‘ä»¬å¯ä»¥æ·»åŠ æˆ‘ä»¬çš„operationåˆ°é˜Ÿåˆ—é‡Œé¢ï¼Œç„¶åé˜Ÿåˆ—å°±ä¼šæŒæœ‰æˆ‘ä»¬çš„operationï¼Œå¹¶ä¸”ä¼šæŒ‰ç…§æˆ‘ä»¬è®¾ç½®çš„ä¾èµ–æˆ–è€…ä¼˜å…ˆçº§æ‰§è¡Œï¼Œç›´åˆ°æˆ‘ä»¬æ˜¾å¼åœ°å–æ¶ˆæˆ–è€…ç›´åˆ°ä»»åŠ¡å®Œæˆã€‚</p>
<p>åˆ›å»ºNSOperationQueue</p>
<figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NSOperationQueue *queue = <span class="comment">[<span class="comment">[NSOperationQueue alloc]</span> init]</span>;</span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºå¥½ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹å‡ ä¸ªæ–¹æ³•å°†operationæ·»åŠ åˆ°é˜Ÿåˆ—ä¸­</p>
<ul>
<li><p><code>addOperation:</code></p>
<p>  æ·»åŠ operationåˆ°é˜Ÿåˆ—</p>
</li>
<li><p><code>addOperations:waitUntilFinished:</code></p>
<p>  æ·»åŠ operationåˆ°é˜Ÿåˆ—ï¼Œå†³å®šæ˜¯å¦è¦ç­‰å¾…operationå®Œæˆï¼Œå¦‚æœæ˜¯ï¼Œåˆ™å°†ä¼šé˜»å¡å½“å‰çº¿ç¨‹ç›´åˆ°ä»»åŠ¡å®Œæˆè¿”å›ï¼›å¦‚æœå¦ï¼Œåœ¨æ“ä½œåŠ å…¥åˆ°é˜Ÿåˆ—ä¹‹åï¼Œæ–¹æ³•ä¼šç«‹åˆ»è¿”å›ã€‚å’Œæ­¤æ–¹æ³•ç±»ä¼¼çš„æ˜¯<code>waitUntilAllOperationsAreFinished</code>ï¼Œä¸è¿‡å®ƒæ˜¯ç­‰å¾…å…¨éƒ¨ä»»åŠ¡å®Œæˆæ‰è¿”å›ã€‚è¿™ä¸¤ä¸ªæ–¹æ³•éƒ½ä¸å»ºè®®åœ¨ä¸»çº¿ç¨‹ä½¿ç”¨ã€‚</p>
</li>
<li><p><code>addOperationWithBlock:</code></p>
<p>  å°†ä»»åŠ¡ä»¥blockçš„å½¢å¼æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­</p>
</li>
</ul>
<p>æ³¨æ„ï¼šå½“operationåŠ å…¥åˆ°æ“ä½œé˜Ÿåˆ—ä¹‹åï¼Œå®ƒå¯èƒ½å¼€å§‹äºä»»ä½•æ—¶å€™ï¼Œå®ƒå¯èƒ½é©¬ä¸Šå¼€å§‹ï¼Œä¹Ÿå¯èƒ½å»¶è¿Ÿä¸€æ®µæ—¶é—´å¼€å§‹ã€‚è¿™é‡Œæœ‰å‡ ä¸ªæƒ…å†µå»¶è¿Ÿæ¯”è¾ƒæ˜æ˜¾ã€‚</p>
<ul>
<li>å½“ä½ åŠ å…¥çš„operationä¾èµ–å…¶ä»–operationï¼Œè€Œå…¶ä»–operationå¹¶æ²¡æœ‰å®Œæˆï¼Œè¿™ä¸ªå»¶è¿Ÿå°±æ›´æ˜æ˜¾äº†</li>
<li>è¿™ä¸ªæ“ä½œé˜Ÿåˆ—æš‚åœäº†</li>
<li>è¿™ä¸ªæ“ä½œé˜Ÿåˆ—å·²ç»è¾¾åˆ°å®ƒçš„æœ€å¤§å¹¶å‘æ•°äº†ï¼Œæ­¤åˆ»å®ƒä¸å¾—ä¸ç­‰å¾…æŸä¸ªoperationå®Œæˆä¹‹åï¼Œå®ƒæ‰æœ‰æœºä¼šæ‰§è¡Œ</li>
</ul>
<h3 id="æš‚åœå’Œæ¢å¤">æš‚åœå’Œæ¢å¤</h3><p>å½“operationåŠ å…¥æ“ä½œé˜Ÿåˆ—åï¼Œæˆ‘ä»¬å¯ä»¥æš‚åœæˆ–è€…æ¢å¤æ“ä½œé˜Ÿåˆ—ã€‚</p>
<ul>
<li><p><code>setSuspended</code></p>
<p>  å¯ä»¥é€šè¿‡è¿™ä¸ªæ–¹æ³•æš‚åœæˆ–è€…æ¢å¤é˜Ÿåˆ—</p>
<ul>
<li>å½“è®¾ç½®ä¸º<code>NO</code>çš„æ—¶å€™ï¼Œé˜Ÿåˆ—ä¼šå¼€å§‹æ‰§è¡Œæ“ä½œ</li>
<li><p>å½“è®¾ç½®ä¸º<code>YES</code>çš„æ—¶å€™ï¼Œé˜Ÿåˆ—ä¼šé˜»æ­¢æ–°çš„operationå¼€å§‹ï¼Œä½†æ˜¯å¹¶ä¸ä¼šç§»é™¤æ­£åœ¨æ‰§è¡Œçš„operationï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ­£åœ¨æ‰§è¡Œä¸­çš„operationå¹¶ä¸ä¼šå—å½±å“ã€‚å¯¹äºå¤„äºæš‚åœçŠ¶æ€çš„é˜Ÿåˆ—ï¼Œå‡å¦‚è¿™ä¸ªæ—¶å€™ç»§ç»­æ·»åŠ operationè¿›å»ï¼Œé‚£ä¹ˆè¿™äº›æ–°åŠ å…¥çš„operationå¹¶ä¸ä¼šæ‰§è¡Œï¼Œç›´åˆ°suspendedå˜ä¸º<code>NO</code>ã€‚</p>
<p>æ¯”å¦‚æœ‰Aã€Bã€Cä¸‰ä¸ªoperationï¼ŒAå·²ç»åœ¨é˜Ÿåˆ—ä¸­æ‰§è¡Œï¼Œè€ŒBå’ŒCåªæ˜¯åœ¨é˜Ÿåˆ—ä¸­è¿˜æ²¡æœ‰å¼€å§‹ï¼ˆå³startæ–¹æ³•è¿˜æ²¡æœ‰æ‰§è¡Œï¼‰ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™æš‚åœé˜Ÿåˆ—åªä¼šé˜»æ­¢Bå’ŒCå¼€å§‹ï¼Œè€ŒAå¹¶ä¸ä¼šæœ‰å½±å“ã€‚</p>
</li>
</ul>
</li>
<li><p><code>isSuspended</code></p>
<p>  è¡¨ç¤ºå½“å‰é˜Ÿåˆ—æ˜¯å¦å¤„åœ¨æš‚åœçŠ¶æ€</p>
</li>
</ul>
<h3 id="å¹¶å‘æ•°">å¹¶å‘æ•°</h3><p>ä¹Ÿå¯ä»¥è®¾ç½®æ“ä½œé˜Ÿåˆ—çš„æœ€å¤§å¹¶å‘æ•°ç›®</p>
<ul>
<li><p><code>maxConcurrentOperationCount</code></p>
<p>  é˜Ÿåˆ—åŒæ—¶å¯ä»¥æ‰§è¡Œçš„æœ€å¤§æ“ä½œä¸ªæ•°</p>
</li>
<li><p><code>setMaxConcurrentOperationCount:</code></p>
<p>  è®¾ç½®é˜Ÿåˆ—åŒæ—¶å¯ä»¥æ‰§è¡Œçš„æœ€å¤§æ“ä½œä¸ªæ•°ã€‚æ³¨æ„ï¼Œå‡å°‘è¿™ä¸ªå€¼çš„æ—¶å€™ï¼Œå¹¶ä¸ä¼šå½±å“å·²ç»åœ¨æ‰§è¡Œçš„operationï¼Œæˆ‘ä»¬å¯ä»¥è®¾ç½®ä¸º<code>NSOperationQueueDefaultMaxConcurrentOperationCount</code>ï¼Œè¿™æ ·é˜Ÿåˆ—çš„æœ€å¤§å¹¶å‘æ•°å°±æ˜¯ç”±ç³»ç»Ÿæ¥å†³å®šäº†ï¼Œå¹¶ä¸”è¿™ä¹Ÿæ˜¯é»˜è®¤å€¼ã€‚</p>
</li>
</ul>
<h3 id="å–æ¶ˆ-1">å–æ¶ˆ</h3><p>å¯¹äºä¸æƒ³è¦çš„ä»»åŠ¡ï¼Œæˆ‘ä»¬å¯ä»¥å–æ¶ˆæ‰€æœ‰æ“ä½œ</p>
<ul>
<li><p><code>cancelAllOperations</code></p>
<p>  å–æ¶ˆæ‰€æœ‰åœ¨é˜Ÿåˆ—ä¸­çš„æ“ä½œã€‚è¿™ä¸ªæ–¹æ³•åªæ˜¯å¯¹é˜Ÿåˆ—ä¸­çš„æ¯ä¸ªoperationæ‰§è¡Œ<code>cancel</code></p>
<ul>
<li>å¯¹äºå·²ç»åœ¨é˜Ÿåˆ—ä¸­æ‰§è¡Œçš„operationï¼Œå–æ¶ˆå¹¶ä¸ä¼šå°†å®ƒä»¬ä»é˜Ÿåˆ—ä¸­ç§»é™¤ï¼Œå®ƒåªæ˜¯ç®€å•çš„è®¾ç½®<code>isCancelled</code>ä¸º<code>YES</code>ï¼Œå› æ­¤operationæœ¬èº«å¿…é¡»æ£€æŸ¥è‡ªå·±çš„<code>isCancelled</code>çŠ¶æ€ï¼Œå‡å¦‚å·²ç»æ˜¯å–æ¶ˆçŠ¶æ€äº†ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ ‡è®°è¯¥operationä¸ºå·²å®Œæˆï¼Œé‚£ä¹ˆæ•´ä¸ªoperationçš„çŠ¶æ€å°±å¯ä»¥ç”±<code>isCancelled -&gt; isFinished</code>ã€‚</li>
<li>å¯¹äºåœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…çš„operationï¼Œé‚£ä¹ˆå®ƒå°†ä¸ä¼šè¢«æ‰§è¡Œã€‚</li>
</ul>
</li>
</ul>
<h3 id="KVO-1">KVO</h3><p>å’ŒNSOperationä¸€æ ·ï¼ŒNSOperationQueueä¹Ÿæ”¯æŒ<code>KVO</code>ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡<code>KVO</code>è§‚å¯Ÿæ“ä½œé˜Ÿåˆ—çš„æ‰§è¡ŒçŠ¶æ€ã€‚é»˜è®¤æœ‰ä»¥ä¸‹å‡ ä¸ªå±æ€§å¯ä»¥è§‚å¯Ÿ</p>
<ul>
<li><code>operations</code></li>
<li><code>operationCount</code></li>
<li><code>maxConcurrentOperationCount</code></li>
<li><code>suspended</code></li>
<li><code>name</code></li>
</ul>
]]></content>
    <summary type="html">
    <![CDATA[<h3 id="NSOperation">NSOperation</h3><h3 id="æ¦‚è¿°">æ¦‚è¿°</h3><p><code>NSOperation</code>æ˜¯ä¸€ä¸ªæŠ½è±¡çš„ç±»ï¼ŒåŒ…è£…äº†å¤„ç†å•ä¸ªä»»åŠ¡æ‰€éœ€è¦çš„ä¸€äº›æ•°æ®ï¼Œä»£è¡¨æ‰§è¡Œå•ä¸ªä»»åŠ¡çš„ä¸€ä¸ªç‹¬ç«‹å•å…ƒã€‚ä¸è¿‡å°½ç®¡å®ƒæ˜¯ä¸ªæŠ½è±¡ç±»ï¼Œä½†æ˜¯å®ƒå·²]]>
    </summary>
    
  </entry>
  
  <entry>
    <title><![CDATA[iOSçš„äº‹ä»¶å“åº”æœºåˆ¶]]></title>
    <link href="http://yoursite.com/2016/01/15/iOS%E7%9A%84%E4%BA%8B%E4%BB%B6%E5%93%8D%E5%BA%94%E6%9C%BA%E5%88%B6/"/>
    <id>http://yoursite.com/2016/01/15/iOSçš„äº‹ä»¶å“åº”æœºåˆ¶/</id>
    <published>2016-01-14T16:00:00.000Z</published>
    <updated>2016-01-30T07:42:50.000Z</updated>
    <content type="html"><![CDATA[<p>å­¦ä¹ iOSäº‹ä»¶å“åº”æœºåˆ¶æ—¶å€™ï¼Œç»å¸¸ä¼šå¬åˆ°ä¸€ä¸ªè¯ï¼Œå³<code>hit-testing</code>æˆ–è€…<code>hit-test</code>è§†å›¾ï¼Œå­—é¢æ„æ€ç†è§£ä¸ºæ•²æ‰“æµ‹è¯•ï¼Œå®é™…ä¸Šï¼Œ<code>hit-testing</code>æ˜¯ä¸€ä¸ªè¿‡ç¨‹ï¼Œæ˜¯iOSç”¨æ¥ç¡®å®šç”¨æˆ·ç‚¹å‡»çš„éƒ¨åˆ†åœ¨å±å¹•å“ªä¸ªéƒ¨ä½çš„ä¸€ä¸ªæ–¹æ³•ï¼Œè€Œç‚¹å‡»éƒ¨åˆ†æ‰€åœ¨çš„è§†å›¾å°±æ˜¯<code>hit-test</code>è§†å›¾ã€‚</p>
<p>é‚£ä¹ˆå½“ç”¨æˆ·è§¦æ‘¸å±å¹•æ—¶ï¼ŒiOSæ˜¯å¦‚ä½•ç¡®å®š<code>hit-testing</code>å¹¶ä¸”æœ€ç»ˆæ‰¾åˆ°è¿™ä¸ª<code>hit-testing</code>è§†å›¾çš„å‘¢ã€‚</p>
<p>å½“ç”¨æˆ·è§¦æ‘¸å±å¹•å³å“åº”çš„äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œ<code>UIKit</code>é¦–å…ˆä¼šç”Ÿæˆä¸€ä¸ª<code>UIEvent</code>å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡åŒ…å«ç€äº‹ä»¶çš„ä¸€äº›åŸºæœ¬ä¿¡æ¯ï¼ŒåŒ…æ‹¬äº‹ä»¶ç±»å‹ã€äº‹ä»¶å‘ç”Ÿçš„æ—¶é—´ï¼Œç„¶åä¼šå°†å®ƒæ”¾å…¥<code>event queue</code>é‡Œé¢ã€‚æ¥ä¸‹æ¥ï¼Œå°±æ˜¯äº‹ä»¶ä»åº•éƒ¨å‘ä¸Šåˆ°é¡¶éƒ¨æ‰¾åˆ°<code>hit-test</code>è§†å›¾çš„è¿‡ç¨‹äº†ã€‚</p>
<ul>
<li><code>UIApplication</code>å¯¹è±¡ä»<code>event queue</code>ä¸­å–å‡ºeventï¼Œç„¶åå°†å®ƒåˆ†å‘ç»™å…¶ä»–å¯¹è±¡å¤„ç†ã€‚</li>
<li>ç„¶å<code>UIApplication</code>ä¼šå…ˆå°†eventå‘é€ç»™<code>UIWindow</code>å¯¹è±¡ï¼Œæ¥ä¸‹æ¥ç”±windowå°†äº‹ä»¶ä¼ é€’åˆ°äº‹ä»¶å‘ç”Ÿçš„é‚£ä¸ªè§†å›¾ã€‚</li>
<li>é‚£ä¹ˆwindowæ˜¯æ€ä¹ˆåšçš„å‘¢ï¼Œå®ƒä¼šè‡ªä¸‹è€Œä¸Šéå†å®ƒçš„å­è§†å›¾ï¼Œå¯¹æ¯ä¸ªè§†å›¾è°ƒç”¨<code>-hitTest:withEvent:</code>ï¼Œè€Œè¯¥æ–¹æ³•ä¼šè§¦å‘<code>-pointInside:withEvent:</code>æ£€æŸ¥è§¦æ‘¸åŒºåŸŸæ˜¯å¦åœ¨è¯¥è§†å›¾è¾¹ç•Œå†…ï¼Œ<ul>
<li>å¦‚æœåœ¨åˆ™è¿”å›<code>YES</code>ï¼Œå¹¶ä¸”<code>-hitTest:withEvent:</code>è¿”å›è¯¥è§†å›¾è‡ªèº«ï¼Œè¡¨ç¤ºå½“å‰æŸ¥æ‰¾çš„è¿™ä¸ªè§†å›¾æ˜¯<code>hit-testing</code>è§†å›¾ï¼›</li>
<li>å¦åˆ™ä¸º<code>NO</code>ï¼Œ<code>hitTest:withEvent:</code>è¿”å›<code>nil</code>ï¼Œè¡¨ç¤ºè§¦æ‘¸äº‹ä»¶å¹¶ä¸å‘ç”Ÿåœ¨é‚£ä¸ªè§†å›¾ä¸Šé¢ï¼Œé‚£ä¹ˆè¯¥è§†å›¾è¢«æŠ›å¼ƒï¼Œå…¶æ‰€æœ‰å­è§†å›¾çš„<code>hitTest:withEvent:</code>ä¹Ÿéƒ½è¿”å›<code>nil</code>ï¼Œè¿›è€Œæ£€æŸ¥å…¶ä»–è§†å›¾ã€‚</li>
</ul>
</li>
<li>å¦‚æœè§¦æ‘¸å‘ç”Ÿåœ¨ç›¸å…³è§†å›¾ä¸Šï¼ˆå³<code>pointInside:withEvent:</code>è¿”å›<code>YES</code>ï¼‰ï¼Œé‚£ä¹ˆè¯¥è§†å›¾ä¼šå†æ¬¡éå†å®ƒçš„å­è§†å›¾ï¼ˆé€†åºï¼‰ï¼Œå¯¹æ¯ä¸ªå­è§†å›¾è°ƒç”¨<code>-hitTest:withEvent:</code>åšåŒæ ·ä¸€éæŸ¥æ‰¾è¿‡ç¨‹ï¼Œç›´åˆ°è¯¥è§†å›¾æ²¡æœ‰å­è§†å›¾ï¼Œæœ€ç»ˆç¡®å®šé‚£ä¸ªè§†å›¾ä¸º<code>hit-testing</code>è§†å›¾ï¼ŒæŸ¥æ‰¾<code>hit-testing</code>è§†å›¾çš„è¿™ä¸ªè¿‡ç¨‹å°±å«åš<code>hit-testing</code>ã€‚</li>
</ul>
<p>æ‰¾åˆ°<code>hit-testing</code>è§†å›¾ä¹‹åï¼Œå®ƒå°±æœ‰æœºä¼šå»å¤„ç†è¯¥äº‹ä»¶ï¼Œå¦‚æœå®ƒä¸èƒ½å¤„ç†ï¼Œåˆ™äº‹ä»¶ä¼šæ²¿ç€å“åº”é“¾ç»§ç»­ä¼ é€’ï¼Œæ¯ä¸ªå“åº”è€…éƒ½æœ‰æœºä¼šå†³å®šæ˜¯å¦å»å¤„ç†äº‹ä»¶æˆ–è€…ç»§ç»­ä¼ é€’ç»™ä¸‹ä¸€ä¸ªå“åº”è€…ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªå¯ä»¥å¤„ç†å®ƒçš„å¯¹è±¡æˆ–è€…è¢«ä¸¢å¼ƒã€‚</p>
<ul>
<li><code>hit-testing</code>è§†å›¾æ˜¯ç¬¬ä¸€ä¸ªå¯ä»¥å¤„ç†äº‹ä»¶çš„ï¼Œå¦‚æœå®ƒä¸èƒ½å¤„ç†ï¼Œåˆ™å®ƒä¼šå°†äº‹ä»¶ä¼ é€’ç»™å®ƒçš„çˆ¶è§†å›¾</li>
<li>çˆ¶è§†å›¾å¦‚æœä¸èƒ½å¤„ç†ï¼Œåˆ™å®ƒä¼šå†æ¬¡ä¼ é€’ç»™å®ƒçš„çˆ¶è§†å›¾</li>
<li>ç›´åˆ°ä¼ åˆ°æœ€é¡¶ç«¯çš„è§†å›¾ï¼Œå³ç›´æ¥æ·»åŠ åˆ°<code>UIWindow</code>ä¸Šçš„é‚£ä¸ªè§†å›¾ï¼Œå¦‚æœå®ƒè¿˜ä¸èƒ½å¤„ç†ï¼Œåˆ™å®ƒä¼šä¼ é€’ç»™å®ƒçš„è§†å›¾æ§åˆ¶å™¨</li>
<li>å¦‚æœè§†å›¾æ§åˆ¶å™¨ä¹Ÿä¸èƒ½å¤„ç†ï¼Œé‚£ä¹ˆåªèƒ½æœ€åä¼ é€’ç»™windowå¯¹è±¡äº†</li>
<li>å¦‚æœwindowå¯¹è±¡æ— æ³•å¤„ç†ï¼Œé‚£ä¹ˆå®ƒä¼šè¿˜ç»™<code>UIApplication</code>å¯¹è±¡</li>
<li>å¦‚æœ<code>UIApplication</code>ä¹Ÿä¸å¤„ç†ï¼Œé‚£ä¹ˆè¯¥äº‹ä»¶å°±åªèƒ½è¢«ä¸¢å¼ƒã€‚</li>
</ul>
<p>ä»ä»¥ä¸Šå¯ä»¥çœ‹å‡ºï¼ŒæŸ¥æ‰¾<code>hit-test</code>è§†å›¾çš„è¿‡ç¨‹æ˜¯<strong>ä»ä¸‹å¾€ä¸Š</strong>çš„ï¼Œè€Œæ‰¾åˆ°ä¹‹åæŸ¥æ‰¾å“åº”è€…çš„è¿‡ç¨‹æ˜¯<strong>è‡ªä¸‹è€Œä¸Š</strong>çš„ã€‚</p>
<p>æ¥ä¸‹æ¥é€šè¿‡ä¸€ä¸ªå®ä¾‹æ¥è¯´æ˜ä¸€ä¸‹ã€‚</p>
<p>è¿™ä¸ªå›¾æ˜¯è‹¹æœæ–‡æ¡£é‡Œçš„ä¸€ä¸ªå›¾ï¼Œæˆ‘ç”¨å®éªŒè¯æ˜äº†ä¸€ä¸‹</p>
<p><img src="/images/hit-test_1.png" alt="hit-test_1"></p>
<p>æˆ‘ç‚¹å‡»åœ¨è§†å›¾Dä¸Šé¢ï¼ŒæŸ¥çœ‹æ§åˆ¶å°çš„è¾“å‡ºå¦‚ä¸‹</p>
<p><img src="/images/hit-test_2.png" alt="hit-test_2"></p>
<p>ä»å›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°</p>
<ol>
<li><p>ç”±<code>UIApplication</code>åˆ†å‘ç»™<code>UIWindow</code>ä¹‹åï¼Œé¦–å…ˆè°ƒç”¨<code>UIWindow</code>çš„<code>-hitTest:withEvent:</code>ï¼Œè¿›è€Œè°ƒç”¨<code>-pointInside:withEvent:</code>ï¼Œå‘ç°è§¦æ‘¸åœ¨windowä¹‹å†…ï¼Œå› æ­¤è¿”å›<code>YES</code>,<code>-hitTest:withEvent:</code>è¿”å›windowè‡ªèº«ï¼Œè¡¨ç¤ºå½“å‰<code>hit-test</code>è§†å›¾æ˜¯windowã€‚</p>
</li>
<li><p>éå†windowä¸Šé¢çš„è§†å›¾ï¼Œç”±äºwindowçš„å­è§†å›¾åªæœ‰View Aï¼Œå› æ­¤è°ƒç”¨View Açš„<code>-pointInside:withEvent:</code>ï¼Œå‘ç°è§¦æ‘¸åœ¨windowä¹‹å†…ï¼Œå› æ­¤è¿”å›<code>YES</code>,<code>-hitTest:withEvent:</code>è¿”å›View Aï¼Œè¡¨ç¤ºå½“å‰<code>hit-test</code>è§†å›¾æ˜¯View Aã€‚</p>
</li>
<li><p>éå†View Aä¸Šé¢çš„è§†å›¾ï¼Œè¿™é‡Œè¦æ³¨æ„ï¼ŒViewAçš„å­è§†å›¾æœ‰ä¸¤ä¸ªï¼Œåˆ†åˆ«æ˜¯View Bå’ŒView Cï¼Œé€šè¿‡æµ‹è¯•æˆ‘å‘ç°è°ƒç”¨çš„é¡ºåºæ˜¯å­è§†å›¾é€†åºï¼Œå³View Cæ˜¯åœ¨View Bä¹‹ååŠ çš„ï¼Œ</p>
<ul>
<li>å› æ­¤è¿™é‡Œå…ˆè°ƒç”¨View Cçš„<code>-pointInside:withEvent:</code>ï¼Œå‘ç°è§¦æ‘¸åœ¨View Cä¹‹å†…ï¼Œå› æ­¤è¿”å›<code>YES</code>,<code>-hitTest:withEvent:</code>è¿”å›View Cï¼Œè¡¨ç¤ºå½“å‰<code>hit-test</code>è§†å›¾æ˜¯View Cï¼Œå› æ­¤View Båˆ™è¢«å¿½ç•¥ã€‚</li>
<li>å€˜è‹¥è¿™é‡ŒView BåŠ åœ¨View Cä¹‹åï¼Œåˆ™ä¼šå…ˆè°ƒç”¨View B</li>
</ul>
</li>
<li><p>æ¥ç€éå†View Cä¸Šé¢çš„è§†å›¾ï¼ŒåŒæ ·çš„é“ç†ï¼Œ</p>
<ul>
<li>å…ˆæµ‹è¯•View Eï¼Œå‘ç°è§¦æ‘¸ä¸åœ¨ä¸Šé¢ï¼Œå³View Eçš„<code>pointInside:withEvent:</code>è¿”å›<code>NO</code>ï¼Œæ‰€ä»¥View Eçš„<code>-hitTest:withEvent:</code>è¿”å›<code>nil</code></li>
<li>å†æµ‹è¯•View Dï¼Œå‘ç°è§¦æ‘¸åœ¨ä¸Šé¢ï¼Œ<code>pointInside:withEvent:</code>è¿”å›<code>YES</code>ï¼Œ<code>-hitTest:withEvent:</code>è¿”å›View Dï¼Œè¡¨ç¤ºå½“å‰<code>hit-test</code>è§†å›¾æ˜¯View Dã€‚</li>
</ul>
</li>
<li><p>å†æ¬¡éå†View Dä¸Šé¢çš„å­è§†å›¾ï¼Œå‘ç°å·²ç»æ²¡æœ‰å­è§†å›¾ï¼Œå› æ­¤æ­¤æ¬¡ç‚¹å‡»æœ€ç»ˆçš„<code>hit-test</code>è§†å›¾æ˜¯View D</p>
</li>
</ol>
<p>ä¸çŸ¥é“å¤§å®¶æœ‰æ²¡æœ‰æ³¨æ„åˆ°é‚£ä¸ªå›¾ï¼Œ<code>hit-testing</code>è¿‡ç¨‹æ‰§è¡Œäº†ä¸¤éï¼Œè‡³äºä¸ºä»€ä¹ˆä¼šæ‰§è¡Œä¸¤éï¼Œç›®å‰è¿˜ä¸æ¸…æ¥šã€‚</p>
<p>äº†è§£äº†<code>hit-testing</code>è¿‡ç¨‹ä¹‹åï¼Œè¿™å°±å¾ˆå¥½ç†è§£ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬æ·»åŠ ä¸€ä¸ªbuttonåœ¨viewä¸Šé¢ï¼Œç‚¹å‡»ä¹‹åæ— æ³•å“åº”äº‹ä»¶çš„åŸå› äº†ã€‚</p>
<p>å¦‚å›¾ï¼Œæˆ‘åœ¨View Bä¸Šæ·»åŠ äº†ä¸€ä¸ªbuttonï¼ŒæŸ¥çœ‹buttonçš„å“åº”æƒ…å†µ</p>
<p><img src="/images/hit-test_3.png" alt="hit-test_3"></p>
<p>é¦–å…ˆï¼Œæˆ‘ç‚¹å‡»åœ¨buttonå³ä¾§ï¼Œæ³¨æ„ç‚¹å‡»çš„éƒ¨ä½å¿…é¡»åœ¨View Bä¹‹å†…ï¼ŒæŸ¥çœ‹è¾“å‡ºæƒ…å†µã€‚</p>
<p><img src="/images/hit-test_4.png" alt="hit-test_4"></p>
<p>å¯ä»¥çœ‹åˆ°ï¼ŒæŸ¥æ‰¾View Bä¹‹åï¼Œå‘ç°åœ¨View Bä¸Šï¼Œç„¶åæŸ¥æ‰¾buttonï¼Œå‘ç°ä¹Ÿåœ¨buttonä¹‹ä¸Šï¼Œå› æ­¤ï¼Œæ­£å¸¸çš„å“åº”äº†äº‹ä»¶ã€‚</p>
<p>ç„¶åï¼Œæˆ‘ç‚¹å‡»åœ¨buttonå·¦ä¾§ï¼Œç‚¹å‡»åœ¨View Bä¹‹å¤–</p>
<p><img src="/images/hit-test_5.png" alt="hit-test_5"></p>
<p>å¯ä»¥çœ‹åˆ°ï¼ŒView Båœ¨æ£€æµ‹çš„æ—¶å€™ï¼Œå‘ç°ç‚¹å‡»åœ¨View Bä¹‹å¤–ï¼Œå› æ­¤<code>-pointInside:withEvent</code>ç›´æ¥è¿”å›<code>NO</code>ï¼Œæ¥ç€<code>-hitTest:withEvent:</code>è¿”å›<code>nil</code>ï¼Œè¡¨ç¤ºè§¦æ‘¸äº‹ä»¶å¹¶ä¸å‘ç”Ÿåœ¨é‚£ä¸ªè§†å›¾ä¸Šé¢ï¼Œåˆ™å®ƒçš„æ‰€æœ‰å­è§†å›¾çš„<code>-hitTest:withEvent:</code>å…¨éƒ¨è¿”å›<code>nil</code>ï¼Œå› æ­¤buttonå¹¶ä¸ä¼šå“åº”æˆ‘ä»¬çš„ç‚¹å‡»äº‹ä»¶ã€‚</p>
<p>è¿™ç§æƒ…å†µå°¤å…¶è¦æ³¨æ„ï¼Œå°¤å…¶æ˜¯æˆ‘ä»¬è®¾ç½®äº†<code>clipsToBounds</code>ä¸º<code>NO</code>çš„æ—¶å€™ã€‚</p>
<p>é‚£ä¹ˆå‡å¦‚æˆ‘ä»¬æƒ³è¦buttonç»§ç»­å“åº”äº‹ä»¶å‘¢ï¼Œåªéœ€è¦åœ¨<code>-hitTest:withEvent:</code>æ–¹æ³•é‡Œä¿®æ”¹å³å¯</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">UIView</span> *)hitTest:(<span class="built_in">CGPoint</span>)point withEvent:(<span class="built_in">UIEvent</span> *)event &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@ [-hitTest:withEvent:]"</span>, <span class="keyword">self</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†ç‚¹å‡»çš„ç‚¹è½¬åŒ–ä¸ºbuttonè‡ªèº«çš„åæ ‡</span></span><br><span class="line">    <span class="built_in">CGPoint</span> touchPointInButton = [<span class="keyword">self</span><span class="variable">.button</span> convertPoint:point fromView:<span class="keyword">self</span>];</span><br><span class="line">    <span class="comment">// å¦‚æœç‚¹å‡»çš„ç‚¹åœ¨buttonä¹‹å†…ï¼Œåˆ™è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">CGRectContainsPoint</span>(<span class="keyword">self</span><span class="variable">.button</span><span class="variable">.bounds</span>, touchPointInButton)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span><span class="variable">.button</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> [<span class="keyword">super</span> hitTest:point withEvent:event];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬æ‰€åšçš„å°±æ˜¯åˆ¤æ–­ç‚¹å‡»çš„ç‚¹æ˜¯å¦åœ¨buttonä¹‹å†…ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¿”å›buttonä¸º<code>hit-test</code>è§†å›¾ï¼Œå¦åˆ™ï¼Œè°ƒç”¨superå¤„ç†ã€‚</p>
<p>å› æ­¤ï¼Œé€šè¿‡<code>hit-testing</code>æˆ‘ä»¬å¯ä»¥æ”¹å˜äº‹ä»¶çš„åˆ†å‘ï¼Œå¯ä»¥å®Œæˆè¯¸å¦‚ç‚¹å‡»Aè€Œè®©Bå“åº”çš„ç‰¹æ®Šæƒ…å†µï¼Œè¿›è€Œæ»¡è¶³ä¸€äº›ç‰¹æ®Šçš„éœ€æ±‚ã€‚</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>å­¦ä¹ iOSäº‹ä»¶å“åº”æœºåˆ¶æ—¶å€™ï¼Œç»å¸¸ä¼šå¬åˆ°ä¸€ä¸ªè¯ï¼Œå³<code>hit-testing</code>æˆ–è€…<code>hit-test</code>è§†å›¾ï¼Œå­—é¢æ„æ€ç†è§£ä¸ºæ•²æ‰“æµ‹è¯•ï¼Œå®é™…ä¸Šï¼Œ<code>hit-testing</code>æ˜¯ä¸€ä¸ªè¿‡ç¨‹ï¼Œæ˜¯iOSç”¨æ¥ç¡®å®šç”¨æˆ·ç‚¹å‡»çš„éƒ¨åˆ†åœ¨å±]]>
    </summary>
    
  </entry>
  
  <entry>
    <title><![CDATA[iOS Method Swizzling]]></title>
    <link href="http://yoursite.com/2016/01/14/iOS_Method_Swizzling/"/>
    <id>http://yoursite.com/2016/01/14/iOS_Method_Swizzling/</id>
    <published>2016-01-13T16:00:00.000Z</published>
    <updated>2016-01-30T05:59:30.000Z</updated>
    <content type="html"><![CDATA[<p>å…ˆæ¥çœ‹ä¸‹é¢è¿™æ®µä»£ç </p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">+ (void)load &#123;</span><br><span class="line">    static dispatch_once_t onceToken;</span><br><span class="line">    dispatch_once(&amp;onceToken, ^&#123;</span><br><span class="line">        Class <span class="class"><span class="keyword">class</span> = [<span class="title">self</span> <span class="title">class</span>];</span></span><br><span class="line"></span><br><span class="line">        SEL oldSelector = @selector(viewDidLoad);</span><br><span class="line">        SEL newSelector = @selector(xxx_viewDidLoad);</span><br><span class="line"></span><br><span class="line">        Method oldMethod = class_getInstanceMethod(<span class="class"><span class="keyword">class</span>, <span class="typename">oldSelector);</span></span></span><br><span class="line">        Method newMethod = class_getInstanceMethod(<span class="class"><span class="keyword">class</span>, <span class="typename">newSelector);</span></span></span><br><span class="line"></span><br><span class="line">        IMP oldIMP = method_getImplementation(oldMethod);</span><br><span class="line">        IMP newIMP = method_getImplementation(newMethod);</span><br><span class="line"></span><br><span class="line">        const char *oldMethodType = method_getTypeEncoding(oldMethod);</span><br><span class="line">        const char *newMethodType = method_getTypeEncoding(newMethod);</span><br><span class="line"></span><br><span class="line">        BOOL didAddMethod = class_addMethod(<span class="class"><span class="keyword">class</span>, <span class="typename">oldSelector</span>, <span class="typename">newIMP</span>, <span class="typename">newMethodType);</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (didAddMethod) &#123;</span><br><span class="line">            class_replaceMethod(<span class="class"><span class="keyword">class</span>, <span class="typename">newSelector</span>, <span class="typename">oldIMP</span>, <span class="typename">oldMethodType);</span></span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            method_exchangeImplementations(oldMethod, newMethod);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)xxx_viewDidLoad</span><br><span class="line">&#123;</span><br><span class="line">    [self xxx_viewDidLoad];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç æƒ³å¿…åªè¦æˆ‘ä»¬å­¦ä¹ è¿‡<code>method swizzle</code>çš„åŒå­¦éƒ½å¾ˆç†Ÿæ‚‰ï¼Œå®ç°ä¹Ÿæ¯”è¾ƒç®€å•ã€‚å…¶ä¸­æœ‰ä¸¤ä¸ªåœ°æ–¹éœ€è¦æ³¨æ„ï¼Œä¹Ÿæ˜¯éš¾ç‚¹ï¼Œå³</p>
<p><code>BOOL didAddMethod = class_addMethod(class, oldSelector, newIMP, newMethodType);</code></p>
<p>å’Œ</p>
<p><code>[self xxx_viewDidLoad];</code></p>
<p>è®²è§£ç¬¬ä¸€ç‚¹ä¹‹å‰ï¼Œå¿…é¡»å…ˆäº†è§£ä¸€ä¸‹<code>class_getInstanceMethod</code>å‡½æ•°çš„åŠŸèƒ½ã€‚</p>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">å®šä¹‰ï¼š<span class="function"><span class="keyword">Method</span> <span class="title">class_getInstanceMethod</span><span class="params">(<span class="keyword">Class</span> aClass, SEL aSelector)</span></span><br><span class="line"></span><br><span class="line">è¯´æ˜ï¼šæŒ‡å®šç±»å’Œæ–¹æ³•é€‰æ‹©å™¨è¿”å›å¯¹åº”çš„å®ä¾‹æ–¹æ³•ï¼Œå³<span class="title">Method</span>ï¼›å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™è¿”å›<span class="title">NULL</span>ã€‚</span></span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­æœ‰ä¸ªéœ€è¦æ³¨æ„çš„åœ°æ–¹ï¼Œå®˜æ–¹æ–‡æ¡£æè¿°è¯¥æ–¹æ³•å¦‚ä¸‹</p>
<blockquote>
<p><strong>Discussion</strong></p>
<p>Note that this function searches superclasses for implementations, whereas class_copyMethodList does not.</p>
</blockquote>
<p>ä»ä¸­å¯ä»¥çœ‹åˆ°ï¼Œè¯¥å‡½æ•°ä¼šæœç´¢çˆ¶ç±»çš„å®ç°ï¼Œå¦‚æœè¯¥é€‰æ‹©å™¨æ²¡æœ‰åœ¨æœ¬ç±»å®ç°ï¼Œåˆ™å®ƒä¼šæŸ¥æ‰¾çˆ¶ç±»çš„å®ç°ï¼Œå¦‚æœçˆ¶ç±»å®ç°äº†ï¼Œåˆ™è¿”å›ï¼›è€Œ<code>class_copyMethodList</code>å¹¶ä¸ä¼šè¿”å›çˆ¶ç±»çš„æ–¹æ³•ã€‚</p>
<p>å› æ­¤æˆ‘ä»¬å›åˆ°åˆšæ‰é‚£ä¸ªé—®é¢˜ï¼Œå‡å¦‚æˆ‘ä»¬è¦æ›¿æ¢çš„æ–¹æ³•åœ¨æœ¬ç±»ä¸­å¹¶æ²¡æœ‰å®ç°è€Œçˆ¶ç±»å®ç°äº†ï¼Œåˆ™<code>class_getInstanceMethod</code>è¿”å›äº†çˆ¶ç±»çš„å®ç°ï¼Œæˆ‘ä»¬å†ä½¿ç”¨<code>method_exchangeImplementations</code>äº¤æ¢å®ç°ï¼Œè¿™æ ·çš„ç»“æœæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå°±æ˜¯æˆ‘ä»¬æ›¿æ¢äº†æˆ‘ä»¬æƒ³è¦æ›¿æ¢çš„ç±»çš„çˆ¶ç±»çš„æ–¹æ³•ï¼Œè¿™å¹¶ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ã€‚</p>
<p>å› æ­¤å…ˆç”¨<code>class_addMethod</code>è¿™ä¸ªæ–¹æ³•<code>Hit-Testing</code>ä¸€ä¸‹æœ¬ç±»æœ‰æ²¡æœ‰å®ç°è¿™ä¸ªæ–¹æ³•ï¼Œ</p>
<ul>
<li>å¦‚æœæœ¬ç±»å·²ç»å®ç°äº†è¯¥æ–¹æ³•ï¼Œåˆ™ä¼šæ·»åŠ å¤±è´¥ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¼€å¼€å¿ƒå¿ƒçš„<code>method_exchangeImplementations</code>å°±å¥½äº†ï¼›</li>
<li>ä½†æ˜¯å‡å¦‚æœ¬ç±»æ²¡æœ‰å®ç°å‘¢ï¼Œé‚£ä¹ˆè¯¥æ–¹æ³•ä¼šè‡ªåŠ¨ä¸ºè¯¥ç±»æ·»åŠ è¯¥æ–¹æ³•ï¼Œå¹¶ä¸”æŒ‡å‘æˆ‘ä»¬çš„æ–°å®ç°ï¼Œç„¶åæˆ‘ä»¬å†ä½¿ç”¨<code>class_replaceMethod</code>å°†æ–°æ–¹æ³•æŒ‡å‘è€çš„å®ç°ã€‚å®é™…ä¸Šå› ä¸º<code>class_addMethod</code>å·²ç»æˆåŠŸï¼Œå³å·²ç»<code>oldSelector --&gt; newIMP</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦<code>newSelector --&gt; oldIMP</code>å³å¯ï¼Œå› æ­¤<code>class_replaceMethod</code>å¯ä»¥è¢«æ›¿æ¢æˆ<code>method_setImplementation(swizzledSelector, method_getImplementation(originalMethod));</code>ï¼Œç›´æ¥å°†æ–°æ–¹æ³•æŒ‡å‘è€å®ç°ã€‚</li>
</ul>
<p>å¯èƒ½æœ‰äº›åŒå­¦ä¼šè¢«ç»•æ™•ï¼Œæˆ‘ä¸¾ä¸ªå®ä¾‹ã€‚</p>
<p>æ¯”å¦‚æˆ‘æƒ³è¦æ›¿æ¢æ‰<code>UITableViewController</code>çš„<code>viewDidLoad</code>çš„å®ç°ï¼Œç”±äº<code>UITableViewController</code>çš„<code>viewDidLoad</code>æ˜¯åœ¨å…¶çˆ¶ç±»<code>UIViewController</code>ä¸­å®ç°çš„ï¼ˆ<code>class-dump</code>å‡ºæ¥çœ‹åˆ°çš„ï¼‰ï¼Œå› æ­¤<code>class_addMethod</code>ä¼šæ·»åŠ æˆåŠŸï¼›å¦‚æœç›´æ¥äº¤æ¢å®ç°çš„è¯ï¼Œå°±æŠŠå®ƒçš„çˆ¶ç±»<code>UIViewController</code>çš„<code>viewDidLoad</code>çš„å®ç°æ›¿æ¢äº†ï¼Œè¿™å°±ä¸æ˜¯æˆ‘ä»¬çš„åˆè¡·äº†ã€‚</p>
<p>æ¥ä¸‹æ¥è®²ä¸€ä¸‹ä¸ºä»€ä¹ˆè¦è°ƒç”¨è€æ–¹æ³•ï¼Œæˆ–è€…æˆ‘ä»¬ä¸è°ƒç”¨è€æ–¹æ³•é‚£å®ƒçœŸçš„å°±æ²¡è°ƒç”¨äº†å—ã€‚</p>
<p>é¡¾åæ€ä¹‰ï¼Œç³»ç»Ÿè°ƒç”¨è€æ–¹æ³•çš„æ—¶å€™ï¼Œç”±äºå®ƒçš„å®ç°è¢«æŒ‡å‘äº†æˆ‘è‡ªå·±çš„å®ç°ï¼Œæˆ‘ä»¬å®ç°è‡ªå·±çš„é€»è¾‘ä¹‹åï¼Œå½“ç„¶è¦è°ƒç”¨åŸæ¥çš„æ–¹æ³•ï¼Œä¸ç„¶å°±åƒéšè—äº†ä¸€ä¸ªå®šæ—¶ç‚¸å¼¹ï¼ŒæŒ‡å®šä»€ä¹ˆæ—¶å€™å‡ºç°ä»€ä¹ˆå¥‡æ€ªçš„é—®é¢˜ã€‚æ¯”å¦‚æˆ‘è‡ªå·±ä¸ºäº†æµ‹è¯•ï¼Œhookäº†<code>UIView</code>çš„<code>-setBackgroundColor:</code>æ–¹æ³•ï¼Œå‡å¦‚æˆ‘ä¸è°ƒç”¨è€æ–¹æ³•ï¼Œåˆ™ä¸ç®¡æˆ‘å°†viewè®¾ç½®æˆä»€ä¹ˆé¢œè‰²ï¼Œå®ƒå°†éƒ½æ˜¯é»‘è‰²ï¼Œè¿™è¯´æ˜äº†çš„ç¡®è€æ–¹æ³•çš„å®ç°è¢«æˆ‘ä»¬ç»•è¿‡äº†ã€‚å› æ­¤ï¼Œä¸ºäº†å®‰å…¨èµ·è§ï¼Œæˆ‘ä»¬åœ¨è‡ªå·±çš„æ–¹æ³•é‡Œé¢ä¸€å®šè¦è°ƒç”¨åŸæ¥çš„æ–¹æ³•ã€‚</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>å…ˆæ¥çœ‹ä¸‹é¢è¿™æ®µä»£ç </p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</sp]]>
    </summary>
    
  </entry>
  
  <entry>
    <title><![CDATA[ä½¿ç”¨clangè¯­æ³•æ¶ˆé™¤ç¼–è¯‘è­¦å‘Š]]></title>
    <link href="http://yoursite.com/2015/11/24/%E4%BD%BF%E7%94%A8clang%E8%AF%AD%E6%B3%95%E6%B6%88%E9%99%A4%E7%BC%96%E8%AF%91%E8%AD%A6%E5%91%8A/"/>
    <id>http://yoursite.com/2015/11/24/ä½¿ç”¨clangè¯­æ³•æ¶ˆé™¤ç¼–è¯‘è­¦å‘Š/</id>
    <published>2015-11-24T04:51:33.000Z</published>
    <updated>2016-01-30T09:27:00.000Z</updated>
    <content type="html"><![CDATA[<p>è‡ªå·±æ€»ç»“äº†ä¸€äº›å¸¸ç”¨çš„clangè¯­æ³•ç”¨äºæ¶ˆé™¤Xcodeè­¦å‘Š</p>
<p><em>ç”¨æ³•</em></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">pragma</span> clang diagnostic push</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">pragma</span> clang diagnostic ignored <span class="string">"-Wundeclared-selector"</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// your code</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">pragma</span> clang diagnostic pop</span></span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>Warning</th>
<th style="text-align:left">Message</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>-Warc-performSelector-leaks</code></td>
<td style="text-align:left"><code>performSelector</code>å¯èƒ½ä¼šé€ æˆå†…å­˜æ³„éœ²å› ä¸ºæ— æ³•çŸ¥é“å…·ä½“çš„selector</td>
</tr>
<tr>
<td><code>-Wunreachable-code&quot;</code></td>
<td style="text-align:left">æ— æ³•æ‰§è¡Œåˆ°çš„ä»£ç </td>
</tr>
<tr>
<td><code>-Wunused-function</code></td>
<td style="text-align:left">æ²¡æœ‰ä½¿ç”¨çš„å‡½æ•°</td>
</tr>
<tr>
<td><code>-Wdeprecated-implementations</code></td>
<td style="text-align:left">æ ‡è®°ä¸ºå·²ç»åºŸå¼ƒçš„æ–¹æ³•</td>
</tr>
<tr>
<td><code>-Wdeprecated-declarations</code></td>
<td style="text-align:left">æ¶ˆé™¤ä½¿ç”¨åºŸå¼ƒæ–¹æ³•è­¦å‘Š</td>
</tr>
<tr>
<td><code>-Wreceiver-is-weak</code>å’Œ<code>-Warc-repeated-use-of-weak</code></td>
<td style="text-align:left">æ¥å—è€…æ˜¯weakå±æ€§</td>
</tr>
<tr>
<td><code>-Wundeclared-selector</code></td>
<td style="text-align:left">æœªå®šä¹‰çš„selector</td>
</tr>
<tr>
<td><code>-Wgnu</code></td>
<td style="text-align:left">æœªçŸ¥</td>
</tr>
<tr>
<td><code>-Wreturn-type</code></td>
<td style="text-align:left">control reaches end of non-void function</td>
</tr>
<tr>
<td><code>-Wimplicit-function-declaration</code></td>
<td style="text-align:left">implicit declaration of function</td>
</tr>
<tr>
<td><code>-Wconversion</code></td>
<td style="text-align:left">æ¶ˆé™¤ç²¾åº¦ä¸¢å¤±warning</td>
</tr>
</tbody>
</table>
]]></content>
    <summary type="html">
    <![CDATA[<p>è‡ªå·±æ€»ç»“äº†ä¸€äº›å¸¸ç”¨çš„clangè¯­æ³•ç”¨äºæ¶ˆé™¤Xcodeè­¦å‘Š</p>
<p><em>ç”¨æ³•</em></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1]]>
    </summary>
    
  </entry>
  
</feed>
